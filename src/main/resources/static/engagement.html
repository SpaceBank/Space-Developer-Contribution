<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Developer Engagement - Space Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 2rem;
        }

        .back-button {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .panel {
            border: 1px solid #6366f1;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: #e4e4e7;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #a1a1aa;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6366f1;
        }

        button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            color: #a1a1aa;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Provider Selection */
        .provider-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .provider-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .provider-option:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .provider-option.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .provider-option .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Multi-select Contributors */
        .contributors-container {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .contributor-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .contributor-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .contributor-item.selected {
            background: rgba(99, 102, 241, 0.2);
        }

        .contributor-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }

        .contributor-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.3);
        }

        .contributor-info {
            flex: 1;
        }

        .contributor-login {
            font-weight: 500;
        }

        .contributor-contributions {
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .selection-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .selection-controls button {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Repository List */
        .repo-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .repo-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .repo-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .repo-item.selected {
            background: rgba(99, 102, 241, 0.2);
        }

        .repo-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }

        .repo-info {
            flex: 1;
        }

        .repo-name {
            font-weight: 500;
        }

        .repo-fullname {
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .selection-info {
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-card h3 {
            font-size: 2rem;
            color: #6366f1;
            margin-bottom: 0.5rem;
        }

        .summary-card p {
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .summary-card .subtitle {
            font-size: 0.75rem;
            color: #71717a;
            margin-top: 0.25rem;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-panel h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #e4e4e7;
        }

        .chart-container {
            height: 300px;
        }

        /* Contributor Filter */
        .contributor-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .filter-chip.selected {
            background: #6366f1;
            border-color: #6366f1;
        }

        .filter-chip img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #a1a1aa;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .contributor-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .contributor-cell img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            margin-bottom: 0.5rem;
        }

        /* Shimmer Loading Animation */
        .shimmer {
            background: linear-gradient(90deg,
                rgba(255,255,255,0.05) 25%,
                rgba(255,255,255,0.15) 50%,
                rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .shimmer-card {
            height: 80px;
            margin-bottom: 1rem;
        }

        .shimmer-chart {
            height: 300px;
            margin-bottom: 1rem;
        }

        .shimmer-text {
            height: 20px;
            width: 60%;
            margin-bottom: 0.5rem;
        }

        .section-loading {
            position: relative;
            min-height: 100px;
        }

        .section-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
        }

        .section-loaded {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-loading {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-complete {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .mini-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Chart shimmer overlay */
        .chart-shimmer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-shimmer::after {
            content: '‚è≥ Loading...';
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .chart-container {
            position: relative;
        }

        .chart-shimmer.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">‚Üê Back to Home</a>

    <div class="container">
        <h1>üë• Developer Engagement Dashboard</h1>

        <!-- Step 2: Select Contributors & Configure -->
        <div class="panel" id="step2-panel">
            <h2>üë• Select Contributors & Configure Analysis</h2>

            <a href="/" class="secondary" style="display: inline-block; margin-bottom: 1rem; text-decoration: none;">‚Üê Back to Home</a>

            <!-- Organization Info -->
            <div id="orgInfo" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; font-size: 0.9rem;"></div>

            <h3 style="margin-bottom: 0.5rem;">üë§ Select Contributors</h3>
            <div class="search-box">
                <input type="text" id="contributorSearch" placeholder="Search contributors..." oninput="filterContributors()">
            </div>

            <div class="selection-controls">
                <button class="secondary" onclick="selectAllContributors()">Select All</button>
                <button class="secondary" onclick="deselectAllContributors()">Deselect All</button>
                <span style="margin-left: auto; color: #a1a1aa;"><span id="contributorCount">0</span> selected</span>
            </div>

            <div class="contributors-container" id="contributorsList"></div>

            <!-- Optional: Repository Filter -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <input type="checkbox" id="filterByRepos" onchange="toggleRepoFilter()"
                           style="width: 18px; height: 18px; accent-color: #6366f1;">
                    <label for="filterByRepos" style="font-weight: 500; cursor: pointer;">
                        üìÅ Filter by specific repositories
                    </label>
                </div>
                <p id="repoFilterHint" style="font-size: 0.8rem; color: #71717a; margin-bottom: 0.5rem;">
                    ‚úÖ Will analyze activity across <strong>ALL accessible repositories</strong> by default.
                    Check the box above to filter by specific repos.
                </p>

                <div id="repo-filter-section" class="hidden">
                    <div id="repo-selection">
                        <div class="search-box">
                            <input type="text" id="repoSearch" placeholder="Search repositories..." oninput="filterRepos()">
                        </div>

                        <div class="selection-info">
                            <span id="repoCount">0</span> repositories selected
                            <button class="secondary" style="float: right; padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="selectAllRepos()">Select All</button>
                        </div>

                        <div class="repo-list" id="repoList"></div>
                    </div>
                </div>
            </div>

            <!-- Exclude Merge Commits Option -->
            <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                <input type="checkbox" id="excludeMergeCommits" checked
                       style="width: 18px; height: 18px; accent-color: #6366f1;">
                <label for="excludeMergeCommits" style="cursor: pointer;">
                    üîÄ Exclude merge commits (recommended)
                </label>
            </div>

            <!-- Date Range & Period -->
            <div class="form-row" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="period">Aggregation Period</label>
                    <select id="period">
                        <option value="DAILY">Daily</option>
                        <option value="WEEKLY" selected>Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>
            </div>

            <button onclick="analyzeEngagement()" id="analyzeBtn" disabled style="margin-top: 1rem;">
                <span>Analyze Engagement</span>
                <span>‚Üí</span>
            </button>

            <div id="analyze-error" class="error hidden"></div>
            <div id="analyze-loading" class="loading hidden">
                <div class="spinner"></div>
                <span id="loading-message">Initializing analysis...</span>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="panel hidden" id="step3-panel">
            <h2>üìä Step 3: Engagement Analysis Results</h2>

            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="secondary" onclick="goToStep(2)">‚Üê Back to Selection</button>
                <button class="secondary" onclick="goToStep(1)">üîÑ Start Over</button>
            </div>

            <!-- Loading Status Panel -->
            <div id="loadingStatusPanel" class="hidden" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; display: flex; gap: 1.5rem; align-items: center;">
                <span style="font-size: 0.875rem; color: #a1a1aa;">Loading:</span>
                <div style="display: flex; gap: 1rem;">
                    <div>üìù Commits: <span id="status-commits"></span></div>
                    <div>üöÄ PRs & Reviews: <span id="status-prs"></span></div>
                </div>
            </div>

            <!-- Analysis Info -->
            <div id="analysisInfo" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px;"></div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards"></div>

            <!-- Contributor Filter for Charts -->
            <div class="panel">
                <h3 style="margin-bottom: 0.5rem;">üéØ Filter by Contributor</h3>
                <div class="contributor-filter" id="contributorFilter"></div>
            </div>

            <!-- Charts Section -->
            <h3 style="margin: 1.5rem 0 1rem;">üìà Commits</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of code commits made by each contributor.
                Commits represent individual units of work pushed to the repository. Higher commit counts indicate active code contribution.
                <em>Note: Merge commits are excluded by default for accurate measurement.</em>
            </p>
            <div class="charts-grid" id="commitsChartsSection">
                <div class="chart-panel">
                    <h3>üìä Total Commits by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total commit count between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsBarChartShimmer"></div>
                        <canvas id="commitsBarChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>üìâ Commits Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows commit activity distribution across the selected time period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsLineChartShimmer"></div>
                        <canvas id="commitsLineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PR Merge Velocity -->
            <h3 style="margin: 1.5rem 0 1rem;">üöÄ PR Merge Velocity (Impact)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Requests created/merged by each contributor.
                This metric shows "Impact" - how many ideas and features were actually completed and shipped.
                High PR velocity indicates a developer who delivers finished work regularly.
            </p>
            <div class="charts-grid" id="prChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedLineChartShimmer"></div>
                        <canvas id="prsMergedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedBarChartShimmer"></div>
                        <canvas id="prsMergedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Review Responsiveness -->
            <h3 style="margin: 1.5rem 0 1rem;">üë• Review Responsiveness (Team Player)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Request reviews performed by each contributor.
                This metric shows "Team Player" status - developers who actively help others by reviewing their code.
                High review counts indicate strong collaboration and mentorship within the team.
            </p>
            <div class="charts-grid" id="reviewChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedLineChartShimmer"></div>
                        <canvas id="prsReviewedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedBarChartShimmer"></div>
                        <canvas id="prsReviewedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Commit Consistency / Active Days -->
            <h3 style="margin: 1.5rem 0 1rem;">üìÖ Commit Consistency (Active Days)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of days a contributor had any activity (commits, PRs, reviews, etc.).
                This metric shows "Flow" - consistent daily engagement is better than sporadic bursts of activity.
                High active days indicate steady, sustainable work patterns.
            </p>
            <div class="charts-grid" id="activeDaysChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysLineChartShimmer"></div>
                        <canvas id="activeDaysLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysBarChartShimmer"></div>
                        <canvas id="activeDaysBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="panel" style="margin-top: 1.5rem;">
                <h3>üìã Contributor Engagement Summary</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Contributor</th>
                                <th>Commits</th>
                                <th>PRs Merged</th>
                                <th>PRs Reviewed</th>
                                <th>Active Days</th>
                            </tr>
                        </thead>
                        <tbody id="engagementTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let contributors = [];
        let selectedContributors = new Set();
        let analysisData = null;
        let selectedContributorsForChart = new Set();

        // Charts - Commits
        let commitsLineChart = null;
        let commitsBarChart = null;

        // Charts - PRs Merged (Impact)
        let prsMergedLineChart = null;
        let prsMergedBarChart = null;

        // Charts - PRs Reviewed (Team Player)
        let prsReviewedLineChart = null;
        let prsReviewedBarChart = null;

        // Charts - Active Days (Consistency)
        let activeDaysLineChart = null;
        let activeDaysBarChart = null;

        // Organizations found
        let organizations = [];

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present (nicknames have @)
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            // Debug logging
            if (displayName && displayName !== loginOrNickname) {
                console.debug(`‚úÖ getDisplayName('${loginOrNickname}') -> '${displayName}'`);
            }

            return result;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Auto-load contributors from session
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    contributors = sessionData.contributors.map(c => ({
                        login: c.login,
                        name: c.name || null,  // Include name for display
                        avatarUrl: c.avatarUrl || c.avatar_url,
                        profileUrl: c.profileUrl || c.html_url,
                        contributions: 0
                    }));
                    organizations = sessionData.organizations || [];

                    // Create display name lookup map from session contributors
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                    console.log('üìã Sample displayNameMap:', Object.entries(window.displayNameMap).slice(0, 5));
                    console.log('üìã Contributors with names:', sessionData.contributors.filter(c => c.name && c.name !== c.login).length, '/', sessionData.contributors.length);

                    // Auto-load repositories
                    if (sessionData.repositories && sessionData.repositories.length > 0) {
                        repositories = sessionData.repositories.map(r => r.fullName);
                    }

                    renderContributorsList();

                    // Show org info
                    document.getElementById('orgInfo').innerHTML = `
                        üè¢ <strong>${organizations.length}</strong> organizations ‚Ä¢
                        üë• <strong>${contributors.length}</strong> contributors ‚Ä¢
                        üì¶ <strong>${repositories.length}</strong> repositories loaded
                    `;
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Provider selection
        function selectProvider(provider) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.provider === provider);
            });
            document.getElementById('custom-url-group').classList.toggle('hidden', provider !== 'GITLAB');
        }

        // Step navigation (step 2 and 3 only now - no login step)
        function goToStep(step) {
            // Map step 1 to step 2 since there's no login panel
            if (step === 1) step = 2;
            currentStep = step;
            document.getElementById('step2-panel').classList.toggle('hidden', step !== 2);
            document.getElementById('step3-panel').classList.toggle('hidden', step !== 3);
        }


        // Toggle repo filter section
        function toggleRepoFilter() {
            const checkbox = document.getElementById('filterByRepos');
            const section = document.getElementById('repo-filter-section');
            const hint = document.getElementById('repoFilterHint');

            if (checkbox.checked) {
                section.classList.remove('hidden');
                hint.innerHTML = '‚ö†Ô∏è <strong>Filter mode:</strong> Select specific repositories below to analyze.';

                // Render repos from session data (already loaded)
                if (repositories.length > 0) {
                    renderRepoList();
                }
            } else {
                section.classList.add('hidden');
                hint.innerHTML = '‚úÖ Will analyze activity across <strong>ALL accessible repositories</strong> by default. Check the box above to filter by specific repos.';
                selectedRepos.clear();
                updateRepoCount();
            }
        }

        // Render repository list from session data
        function renderRepoList(filter = '') {
            const container = document.getElementById('repoList');
            const filtered = repositories.filter(r =>
                r.toLowerCase().includes(filter.toLowerCase())
            );

            container.innerHTML = filtered.map(repo => {
                const repoName = repo.split('/').pop();
                return `
                    <div class="repo-item ${selectedRepos.has(repo) ? 'selected' : ''}"
                         onclick="toggleRepo('${repo}')">
                        <input type="checkbox" ${selectedRepos.has(repo) ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleRepo('${repo}')">
                        <div class="repo-info">
                            <div class="repo-name">${repoName}</div>
                            <div class="repo-fullname">${repo}</div>
                        </div>
                    </div>
                `;
            }).join('');

            updateRepoCount();
        }

        function filterRepos() {
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function toggleRepo(repo) {
            if (selectedRepos.has(repo)) {
                selectedRepos.delete(repo);
            } else {
                selectedRepos.add(repo);
            }
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function selectAllRepos() {
            const filter = document.getElementById('repoSearch').value.toLowerCase();
            repositories.filter(r => r.toLowerCase().includes(filter))
                .forEach(r => selectedRepos.add(r));
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function deselectAllRepos() {
            selectedRepos.clear();
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function updateRepoCount() {
            const repoCountEl = document.getElementById('repoCount');
            if (repoCountEl) {
                repoCountEl.textContent = selectedRepos.size;
            }
        }


        // Render contributors list
        function renderContributorsList(filter = '') {
            const container = document.getElementById('contributorsList');

            // Filter by login, name, or display name
            const filtered = contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                const searchText = filter.toLowerCase();

                return c.login.toLowerCase().includes(searchText) ||
                       (c.name && c.name.toLowerCase().includes(searchText)) ||
                       (displayName && displayName.toLowerCase().includes(searchText));
            });

            container.innerHTML = filtered.map(c => {
                const displayName = getDisplayName(c.login);
                const reposInfo = c.publicRepos ? `üìÅ ${c.publicRepos} repos` : '';
                const contributionsInfo = c.contributions ? `${c.contributions} contributions` : '';
                const infoText = [contributionsInfo, reposInfo].filter(x => x).join(' ‚Ä¢ ');

                return `
                    <div class="contributor-item ${selectedContributors.has(c.login) ? 'selected' : ''}"
                         onclick="toggleContributor('${c.login}')">
                        <input type="checkbox" ${selectedContributors.has(c.login) ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleContributor('${c.login}')">
                        <img class="contributor-avatar" src="${c.avatarUrl || ''}"
                             onerror="this.style.display='none'" alt="">
                        <div class="contributor-info">
                            <div class="contributor-login">${displayName}</div>
                            <div class="contributor-contributions">@${c.login}${infoText ? ' ‚Ä¢ ' + infoText : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            updateContributorCount();
        }

        function filterContributors() {
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function toggleContributor(login) {
            if (selectedContributors.has(login)) {
                selectedContributors.delete(login);
            } else {
                selectedContributors.add(login);
            }
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function selectAllContributors() {
            contributors.forEach(c => selectedContributors.add(c.login));
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function deselectAllContributors() {
            selectedContributors.clear();
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function updateContributorCount() {
            document.getElementById('contributorCount').textContent = selectedContributors.size;
            document.getElementById('analyzeBtn').disabled = selectedContributors.size === 0;
        }


        // Analyze engagement - PARALLEL loading for speed
        async function analyzeEngagement() {
            if (selectedContributors.size === 0) {
                showError('analyze-error', 'Please select at least one contributor');
                return;
            }

            const filterByRepos = document.getElementById('filterByRepos').checked;

            if (filterByRepos && selectedRepos.size === 0) {
                showError('analyze-error', 'Please select at least one repository, or uncheck "Filter by specific repositories" to analyze all repos.');
                return;
            }

            hideError('analyze-error');

            const sessionData = getSessionData();
            const token = sessionData?.token || '';
            const startDate = document.getElementById('startDate').value || null;
            const endDate = document.getElementById('endDate').value || null;
            const period = document.getElementById('period').value;
            const reposToAnalyze = filterByRepos ? Array.from(selectedRepos) : [];

            const requestBody = {
                token: token,
                provider: selectedProvider,
                baseUrl: sessionData?.baseUrl || null,
                repositoryFullNames: reposToAnalyze,
                contributorLogins: Array.from(selectedContributors),
                startDate: startDate,
                endDate: endDate,
                period: period,
                excludeMergeCommits: document.getElementById('excludeMergeCommits').checked
            };

            // Go to results page immediately with shimmer loading
            goToStep(3);
            showShimmerLoading();

            // Start BOTH API calls in PARALLEL
            updateLoadingStatus('commits', 'loading');
            updateLoadingStatus('prs', 'loading');

            const commitsPromise = fetch('/api/engagement/analyze/commits', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            }).then(r => r.ok ? r.json() : Promise.reject('Failed to fetch commits'));

            const prsPromise = fetch('/api/engagement/analyze/prs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            }).then(r => {
                if (!r.ok) {
                    console.error('PR fetch failed with status:', r.status, r.statusText);
                    return r.text().then(text => {
                        console.error('PR fetch error body:', text);
                        throw new Error(`Failed to fetch PRs: ${r.status} ${r.statusText}`);
                    });
                }
                return r.json();
            });

            // Handle commits when ready (usually faster)
            commitsPromise.then(data => {
                analysisData = data;
                updateLoadingStatus('commits', 'complete');
                displayCommitsResults(data);
            }).catch(err => {
                updateLoadingStatus('commits', 'error');
                console.error('Commits error:', err);
            });

            // Handle PRs when ready (usually slower)
            prsPromise.then(prData => {
                // Calculate totals for status display
                if (prData && prData.contributors && Array.isArray(prData.contributors)) {
                    const totalPRs = prData.contributors.reduce((sum, c) => sum + (c.prsMerged || 0), 0);
                    const totalReviews = prData.contributors.reduce((sum, c) => sum + (c.prsReviewed || 0), 0);
                    updateLoadingStatus('prs', 'complete', `${totalPRs} PRs, ${totalReviews} Reviews`);
                } else {
                    updateLoadingStatus('prs', 'complete');
                }
                mergePRDataIntoResults(prData);
                displayPRResults();
            }).catch(err => {
                updateLoadingStatus('prs', 'error');
                console.error('PRs error:', err);
                // Hide PR shimmers on error
                hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
                // Update summary cards to show N/A instead of spinner
                const prsMergedCard = document.getElementById('prsMergedCard');
                const prsReviewedCard = document.getElementById('prsReviewedCard');
                const activeDaysCard = document.getElementById('activeDaysCard');
                if (prsMergedCard) prsMergedCard.querySelector('.card-value').textContent = 'N/A';
                if (prsReviewedCard) prsReviewedCard.querySelector('.card-value').textContent = 'N/A';
                if (activeDaysCard) activeDaysCard.querySelector('.card-value').textContent = 'N/A';
            });

            // Wait for both to complete (for error handling)
            try {
                await Promise.allSettled([commitsPromise, prsPromise]);
            } catch (error) {
                console.error('Analysis error:', error);
            }
        }

        // Show shimmer loading placeholders
        function showShimmerLoading() {
            document.getElementById('analysisInfo').innerHTML = `
                <div class="shimmer shimmer-text" style="width: 200px; height: 24px;"></div>
            `;

            document.getElementById('summaryCards').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    ${[1,2,3,4,5].map(() => `<div class="shimmer shimmer-card"></div>`).join('')}
                </div>
            `;

            // Show loading status indicators
            document.getElementById('loadingStatusPanel').classList.remove('hidden');
            updateLoadingStatus('commits', 'pending');
            updateLoadingStatus('prs', 'pending');

            // Show shimmers on ALL chart containers
            showChartShimmers(['commitsLineChart', 'commitsBarChart']);
            showChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Show shimmer overlay on specific charts
        function showChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.remove('hidden');
                }
            });
        }

        // Hide shimmer overlay on specific charts
        function hideChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.add('hidden');
                }
            });
        }

        // Update loading status indicator
        function updateLoadingStatus(section, status, customText = null) {
            const el = document.getElementById(`status-${section}`);
            if (!el) return;

            if (status === 'pending') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(113,113,122,0.2); color: #71717a;">‚è≥ Pending</span>`;
            } else if (status === 'loading') {
                el.innerHTML = `<span class="status-indicator status-loading"><span class="mini-spinner"></span> Loading...</span>`;
            } else if (status === 'complete') {
                const text = customText || '‚úì Complete';
                el.innerHTML = `<span class="status-indicator status-complete">‚úì ${text}</span>`;
            } else if (status === 'error') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚úó Failed</span>`;
            }
        }

        // Display commits results (fast)
        function displayCommitsResults(data) {
            selectedContributorsForChart = new Set(data.contributors.map(c => c.login));
            window.analysisRepos = data.analyzedRepositories || [];

            const repos = data.analyzedRepositories || [];
            const repoCount = repos.length;

            document.getElementById('analysisInfo').innerHTML = `
                <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                    <strong>üìÅ Repositories:</strong>
                    <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                    <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                        style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                </div>
                <div id="repoDetailsBox" style="display:none;"></div>
                <p style="font-size:0.85rem; color:#a1a1aa;">
                    üìÖ ${data.dateRange.startDate} to ${data.dateRange.endDate}<br>
                    üìä Period: ${data.period}
                </p>
            `;

            // Summary cards - commits only first
            const s = data.summary;
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="card-icon">üë•</div>
                        <div class="card-value">${s.totalContributors}</div>
                        <div class="card-label">Contributors</div>
                    </div>
                    <div class="summary-card">
                        <div class="card-icon">üìù</div>
                        <div class="card-value">${s.totalCommits.toLocaleString()}</div>
                        <div class="card-label">Total Commits</div>
                    </div>
                    <div class="summary-card" id="prsMergedCard">
                        <div class="card-icon">üöÄ</div>
                        <div class="card-value"><span class="mini-spinner"></span></div>
                        <div class="card-label">PRs Merged</div>
                    </div>
                    <div class="summary-card" id="prsReviewedCard">
                        <div class="card-icon">üëÄ</div>
                        <div class="card-value"><span class="mini-spinner"></span></div>
                        <div class="card-label">PRs Reviewed</div>
                    </div>
                    <div class="summary-card" id="activeDaysCard">
                        <div class="card-icon">üìÖ</div>
                        <div class="card-value"><span class="mini-spinner"></span></div>
                        <div class="card-label">Active Days</div>
                    </div>
                </div>
            `;

            // Render commits charts immediately
            renderCommitsCharts(data);
            renderEngagementTable(data.contributors, true); // partial = true, no PR data yet

            // Show shimmer for PR sections
            showPRSectionsShimmer();
        }

        // Show shimmer for PR/review sections
        function showPRSectionsShimmer() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) prSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (reviewSection) reviewSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (activeDaysSection) activeDaysSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
        }

        // Merge PR data into existing results
        function mergePRDataIntoResults(prData) {
            if (!analysisData || !prData.contributors) return;

            // Update summary
            let totalPRs = 0, totalReviews = 0, totalActiveDays = 0;

            prData.contributors.forEach(prContrib => {
                totalPRs += prContrib.prsMerged;
                totalReviews += prContrib.prsReviewed;
                totalActiveDays += prContrib.activeDays;

                // Merge into main data
                const mainContrib = analysisData.contributors.find(c => c.login === prContrib.login);
                if (mainContrib) {
                    mainContrib.prsMerged = prContrib.prsMerged;
                    mainContrib.prsReviewed = prContrib.prsReviewed;
                    mainContrib.activeDays = prContrib.activeDays;
                    mainContrib.prsMergedOverTime = prContrib.prsMergedOverTime;
                    mainContrib.prsReviewedOverTime = prContrib.prsReviewedOverTime;
                    mainContrib.activeDaysOverTime = prContrib.activeDaysOverTime;
                }
            });

            analysisData.summary.totalPRsMerged = totalPRs;
            analysisData.summary.totalPRsReviewed = totalReviews;
            analysisData.summary.totalActiveDays = totalActiveDays;
        }

        // Display PR results after they load
        function displayPRResults() {
            // Restore PR chart sections (they were replaced by shimmer)
            restorePRChartSections();
            
            // Update summary cards
            const s = analysisData.summary;
            document.getElementById('prsMergedCard').querySelector('.card-value').textContent = s.totalPRsMerged.toLocaleString();
            document.getElementById('prsReviewedCard').querySelector('.card-value').textContent = s.totalPRsReviewed.toLocaleString();
            document.getElementById('activeDaysCard').querySelector('.card-value').textContent = s.totalActiveDays.toLocaleString();

            // Render PR charts
            renderPRCharts(analysisData);
            renderEngagementTable(analysisData.contributors, false); // full data now
        }

        // Restore PR chart sections that were replaced by shimmer
        function restorePRChartSections() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) {
                prSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedLineChartShimmer"></div>
                            <canvas id="prsMergedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedBarChartShimmer"></div>
                            <canvas id="prsMergedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (reviewSection) {
                reviewSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedLineChartShimmer"></div>
                            <canvas id="prsReviewedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedBarChartShimmer"></div>
                            <canvas id="prsReviewedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (activeDaysSection) {
                activeDaysSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysLineChartShimmer"></div>
                            <canvas id="activeDaysLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysBarChartShimmer"></div>
                            <canvas id="activeDaysBarChart"></canvas>
                        </div>
                    </div>
                `;
            }
        }

        // Render only commits charts
        function renderCommitsCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // Commits Over Time Line Chart
            if (commitsLineChart) commitsLineChart.destroy();
            commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.commitsOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Commits Bar Chart
            if (commitsBarChart) commitsBarChart.destroy();
            commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Total Commits',
                        data: contributors.map(c => c.totalCommits),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide commit chart shimmers after rendering
            hideChartShimmers(['commitsLineChart', 'commitsBarChart']);
        }

        // Render PR and review charts
        function renderPRCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // PRs Merged Over Time
            if (prsMergedLineChart) prsMergedLineChart.destroy();
            prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsMergedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Merged Bar Chart
            if (prsMergedBarChart) prsMergedBarChart.destroy();
            prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Merged',
                        data: contributors.map(c => c.prsMerged || 0),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Over Time
            if (prsReviewedLineChart) prsReviewedLineChart.destroy();
            prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsReviewedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Bar Chart
            if (prsReviewedBarChart) prsReviewedBarChart.destroy();
            prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Reviewed',
                        data: contributors.map(c => c.prsReviewed || 0),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Over Time
            if (activeDaysLineChart) activeDaysLineChart.destroy();
            activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.activeDaysOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Bar Chart
            if (activeDaysBarChart) activeDaysBarChart.destroy();
            activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Active Days',
                        data: contributors.map(c => c.activeDays || 0),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide PR/review/active days chart shimmers after rendering
            hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Render engagement table
        function renderEngagementTable(contributors, partial = false) {
            const tbody = document.getElementById('engagementTableBody');
            tbody.innerHTML = contributors.map(c => `
                <tr>
                    <td class="contributor-cell">
                        ${c.avatarUrl ? `<img src="${c.avatarUrl}" alt="">` : '<span style="font-size: 1.2em;">üë§</span>'}
                        <span>${getDisplayName(c.login)}</span>
                    </td>
                    <td>${c.totalCommits.toLocaleString()}</td>
                    <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsMerged || 0).toLocaleString()}</td>
                    <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsReviewed || 0).toLocaleString()}</td>
                    <td>${partial ? '<span class="mini-spinner"></span>' : (c.activeDays || 0).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // Toggle repo list view in results
        function toggleRepoDetails() {
            const box = document.getElementById('repoDetailsBox');
            const btn = document.getElementById('repoToggleBtn');

            if (box.style.display === 'none') {
                // Render repos only when expanding
                const repos = window.analysisRepos || [];
                box.innerHTML = `
                    <div style="margin-bottom:0.5rem; padding:0.5rem; background:rgba(0,0,0,0.3); border-radius:6px; max-height:100px; overflow-y:auto;">
                        <div style="font-size:0.65rem; color:#a1a1aa; display:flex; flex-wrap:wrap; gap:0.2rem;">
                            ${repos.map(r => `<span style="background:rgba(255,255,255,0.08); padding:0.1rem 0.25rem; border-radius:2px;">${r.split('/').pop()}</span>`).join('')}
                        </div>
                    </div>
                `;
                box.style.display = 'block';
                btn.textContent = 'Hide ‚ñ≤';
            } else {
                box.style.display = 'none';
                box.innerHTML = ''; // Clear content when hidden
                btn.textContent = 'Show ‚ñº';
            }
        }

        // Display results
        function displayResults(data) {
            // Initialize chart filters with all contributors
            selectedContributorsForChart = new Set(data.contributors.map(c => c.login));

            // Analysis Info - with collapsible repo list
            const repos = data.analyzedRepositories || [];
            const repoCount = repos.length;

            // Store repos for later use when expanding
            window.analysisRepos = repos;

            document.getElementById('analysisInfo').innerHTML = `
                <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                    <strong>üìÅ Repositories:</strong>
                    <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                    <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                        style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                </div>
                <div id="repoDetailsBox" style="display:none;"></div>
                <div>
                    <strong>üìÖ</strong> ${data.dateRange.startDate} to ${data.dateRange.endDate} &nbsp;
                    <strong>üìä</strong> ${data.period}
                </div>
            `;

            // Summary Cards - focused on key metrics
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <h3>${data.summary.totalContributors}</h3>
                    <p>Contributors</p>
                </div>
                <div class="summary-card">
                    <h3>${data.summary.totalCommits}</h3>
                    <p>Total Commits</p>
                    <div class="subtitle">Top: ${data.summary.mostActiveCommitter || 'N/A'}</div>
                </div>
                <div class="summary-card" style="background: rgba(139, 92, 246, 0.1);">
                    <h3 style="color: #8b5cf6;">${data.summary.totalPRsMerged || 0}</h3>
                    <p>PRs Merged</p>
                    <div class="subtitle">Impact metric</div>
                </div>
                <div class="summary-card" style="background: rgba(59, 130, 246, 0.1);">
                    <h3 style="color: #3b82f6;">${data.summary.totalPRsReviewed || 0}</h3>
                    <p>PRs Reviewed</p>
                    <div class="subtitle">Team player</div>
                </div>
                <div class="summary-card" style="background: rgba(16, 185, 129, 0.1);">
                    <h3 style="color: #10b981;">${data.summary.totalActiveDays || 0}</h3>
                    <p>Active Days</p>
                    <div class="subtitle">Consistency</div>
                </div>
            `;

            // Contributor filter
            renderContributorFilter(data.contributors);

            // Render all charts
            renderCharts(data);

            // Render table
            renderEngagementTable(data.contributors);
        }

        function renderContributorFilter(contributors) {
            const container = document.getElementById('contributorFilter');
            container.innerHTML = contributors.map(c => `
                <div class="filter-chip ${selectedContributorsForChart.has(c.login) ? 'selected' : ''}"
                     onclick="toggleChartContributor('${c.login}')"
                     title="${getDisplayName(c.login)}">
                    ${c.avatarUrl ? `<img src="${c.avatarUrl}" alt="">` : '<span style="font-size: 1em;">üë§</span>'}
                    <span>${getDisplayName(c.login)}</span>
                </div>
            `).join('');
        }

        function toggleChartContributor(login) {
            if (selectedContributorsForChart.has(login)) {
                selectedContributorsForChart.delete(login);
            } else {
                selectedContributorsForChart.add(login);
            }
            renderContributorFilter(analysisData.contributors);
            renderCharts(analysisData);
        }

        function renderCharts(data) {
            const filteredContributors = data.contributors.filter(c =>
                selectedContributorsForChart.has(c.login)
            );
            const colors = generateColors(filteredContributors.length);
            const periods = data.periods;

            // Commits Line Chart
            if (commitsLineChart) commitsLineChart.destroy();
            commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: filteredContributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.commitsOverTime.map(d => d.value),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions('Commits')
            });

            // Commits Bar Chart
            if (commitsBarChart) commitsBarChart.destroy();
            commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                type: 'bar',
                data: {
                    labels: filteredContributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Total Commits',
                        data: filteredContributors.map(c => c.totalCommits),
                        backgroundColor: colors
                    }]
                },
                options: chartOptions('Commits')
            });

            // ===== PRs Merged (Impact) =====
            // PRs Merged Over Time Line Chart
            if (prsMergedLineChart) prsMergedLineChart.destroy();
            prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: filteredContributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsMergedOverTime ? c.prsMergedOverTime.map(d => d.value) : periods.map(() => 0),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions('PRs Merged')
            });

            // PRs Merged Bar Chart
            if (prsMergedBarChart) prsMergedBarChart.destroy();
            prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                type: 'bar',
                data: {
                    labels: filteredContributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Merged',
                        data: filteredContributors.map(c => c.prsMerged || 0),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: chartOptions('PRs Merged')
            });

            // ===== PRs Reviewed (Team Player) =====
            // PRs Reviewed Over Time Line Chart
            if (prsReviewedLineChart) prsReviewedLineChart.destroy();
            prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: filteredContributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsReviewedOverTime ? c.prsReviewedOverTime.map(d => d.value) : periods.map(() => 0),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions('PRs Reviewed')
            });

            // PRs Reviewed Bar Chart
            if (prsReviewedBarChart) prsReviewedBarChart.destroy();
            prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                type: 'bar',
                data: {
                    labels: filteredContributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Reviewed',
                        data: filteredContributors.map(c => c.prsReviewed || 0),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: chartOptions('PRs Reviewed')
            });

            // ===== Active Days (Consistency) =====
            // Active Days Over Time Line Chart
            if (activeDaysLineChart) activeDaysLineChart.destroy();
            activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: filteredContributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.activeDaysOverTime ? c.activeDaysOverTime.map(d => d.value) : periods.map(() => 0),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions('Active Days')
            });

            // Active Days Bar Chart
            if (activeDaysBarChart) activeDaysBarChart.destroy();
            activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                type: 'bar',
                data: {
                    labels: filteredContributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Active Days',
                        data: filteredContributors.map(c => c.activeDays || 0),
                        backgroundColor: '#10b981'
                    }]
                },
                options: chartOptions('Active Days')
            });
        }

        function renderEngagementTable(contributors) {
            document.getElementById('engagementTableBody').innerHTML = contributors.map(c => `
                <tr>
                    <td>
                        <div class="contributor-cell">
                            ${c.avatarUrl ? `<img src="${c.avatarUrl}" alt="">` : '<span style="font-size: 1.2em;">üë§</span>'}
                            <span>${getDisplayName(c.login)}</span>
                        </div>
                    </td>
                    <td><strong>${c.totalCommits}</strong></td>
                    <td style="color: #8b5cf6;">${c.prsMerged || 0}</td>
                    <td style="color: #3b82f6;">${c.prsReviewed || 0}</td>
                    <td style="color: #10b981;">${c.activeDays || 0}</td>
                </tr>
            `).join('');
        }

        // Chart options
        function chartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: { color: '#e4e4e7' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7'
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        beginAtZero: true
                    }
                }
            };
        }

        // Pie/Doughnut chart options
        function pieChartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#e4e4e7',
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
        }

        // Generate colors
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4',
                '#0ea5e9', '#3b82f6'
            ];
            return colors.slice(0, count);
        }

        // Utilities
        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>
</html>

