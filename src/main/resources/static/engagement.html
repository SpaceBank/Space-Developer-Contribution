<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Developer Engagement - Space Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #12122e 40%, #1a1a3e 70%, #0f0f2a 100%);
            padding: 0;
        }

        body.in-iframe .back-home-btn { display: none !important; }
        body.in-iframe { padding-top: 0; }
        body.in-iframe .container { padding-top: 1rem; }

        /* Shimmer Loading */
        .shimmer-card { height: 80px; margin-bottom: var(--space-lg); }
        .shimmer-chart { height: 300px; margin-bottom: var(--space-lg); }
        .shimmer-text { height: 20px; width: 60%; margin-bottom: var(--space-sm); }

        .section-loading { position: relative; min-height: 100px; }
        .section-loading::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(26, 26, 46, 0.8); border-radius: var(--radius-lg);
        }
        .loading-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; gap: var(--space-sm); z-index: 10;
        }
        .section-loaded { animation: fadeIn 0.3s ease-in; }
        .status-indicator {
            display: inline-flex; align-items: center; gap: var(--space-sm);
            padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 500;
        }
        .status-loading { background: var(--color-warning-bg); color: var(--color-warning-light); }
        .status-complete { background: var(--color-success-bg); color: var(--color-success); }

        .chart-shimmer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;
            border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;
        }
        .chart-shimmer::after { content: '‚è≥ Loading...'; color: var(--color-text-secondary); font-size: 0.875rem; }
        .chart-container { position: relative; }
        .chart-shimmer.hidden { display: none; }

        /* Loading Panel */
        .loading-panel {
            background: rgba(99, 102, 241, 0.08); border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg); padding: var(--space-xl); margin-top: var(--space-lg);
        }
        .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
        .loading-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: var(--color-text); }
        .loading-progress-bar { height: 8px; background: rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; margin-bottom: var(--space-lg); }
        .loading-progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); border-radius: 4px; transition: width 0.3s; }
        .loading-status { font-size: 0.875rem; color: var(--color-text-secondary); }
        .pulse-dot { width: 10px; height: 10px; background: var(--color-success); border-radius: 50%; animation: pulse 1.5s infinite; }

        /* Results container - hidden by default, shown after analysis */
        .results-container { display: none; margin-top: 2rem; }
        .results-container.visible { display: block; animation: fadeIn 0.4s ease-out; }

        /* Loading spinner between config and results */
        .analysis-loading { display: none; text-align: center; padding: 3rem 1rem; }
        .analysis-loading.visible { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .error-box { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); border-radius: 12px; padding: 1rem; margin-top: 1rem; color: #f87171; }
        .error-box.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Searchable dropdowns */
        .repo-search-wrapper, .contributor-search-wrapper { position: relative; }
        .repo-dropdown, .contributor-dropdown { display:none; position:absolute; top:100%; left:0; right:0; max-height:280px; overflow-y:auto; background:#1e1e2e; border:1px solid rgba(255,255,255,.15); border-radius:12px; margin-top:4px; z-index:100; box-shadow:0 8px 32px rgba(0,0,0,.5); }
        .repo-dropdown.show, .contributor-dropdown.show { display:block; }
        .repo-dropdown-item, .contributor-dropdown-item { padding:.6rem 1rem; color:#e4e4e7; font-size:.875rem; cursor:pointer; transition:background .15s; display:flex; align-items:center; gap:.5rem; border-bottom:1px solid rgba(255,255,255,.05); }
        .repo-dropdown-item:last-child, .contributor-dropdown-item:last-child { border-bottom:none; }
        .repo-dropdown-item:hover, .contributor-dropdown-item:hover { background:rgba(99,102,241,.15); }
        .repo-dropdown-item.selected, .contributor-dropdown-item.selected { background:rgba(99,102,241,.2); color:#818cf8; }
        .repo-dropdown-item .repo-check, .contributor-dropdown-item .dd-check { width:16px; height:16px; border-radius:4px; border:2px solid rgba(255,255,255,.2); display:flex; align-items:center; justify-content:center; font-size:.7rem; flex-shrink:0; transition:all .15s; }
        .repo-dropdown-item.selected .repo-check, .contributor-dropdown-item.selected .dd-check { background:#6366f1; border-color:#6366f1; color:#fff; }
        .repo-dropdown-item .repo-icon, .contributor-dropdown-item .dd-avatar { opacity:.5; font-size:.75rem; }
        .contributor-dropdown-item .dd-avatar { width:24px; height:24px; border-radius:50%; opacity:1; }
        .repo-dropdown-empty, .contributor-dropdown-empty { padding:1rem; text-align:center; color:#71717a; font-size:.85rem; }

        /* Selected tags */
        .repo-tag, .contributor-tag { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:8px; font-size:.78rem; color:#a5b4fc; cursor:default; }
        .contributor-tag { background:rgba(139,92,246,.15); border-color:rgba(139,92,246,.3); color:#c4b5fd; }
        .contributor-tag .tag-avatar { width:16px; height:16px; border-radius:50%; }
        .repo-tag .tag-remove, .contributor-tag .tag-remove { cursor:pointer; color:#71717a; font-size:.85rem; line-height:1; margin-left:.15rem; transition:color .15s; }
        .repo-tag .tag-remove:hover, .contributor-tag .tag-remove:hover { color:#ef4444; }

        /* Commit Popup Modal */
        .commit-popup-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.75); backdrop-filter:blur(8px); z-index:10001; align-items:center; justify-content:center; }
        .commit-popup-modal.show { display:flex; }
        .commit-popup-content { background:linear-gradient(135deg,#1e1e2e,#16213e); border:1px solid rgba(255,255,255,.1); border-radius:16px; max-width:900px; width:95%; max-height:85vh; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,.5); animation:fadeIn .3s ease-out; }
        .commit-popup-header { display:flex; align-items:center; justify-content:space-between; padding:1.25rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.08); }
        .commit-popup-user-info { display:flex; align-items:center; gap:1rem; }
        .commit-popup-avatar { width:48px; height:48px; border-radius:50%; border:2px solid #6366f1; }
        .commit-popup-name { font-size:1.15rem; font-weight:600; color:#fff; }
        .commit-popup-login { font-size:.85rem; color:#818cf8; }
        .commit-popup-close { width:40px; height:40px; border:none; background:rgba(255,255,255,.05); color:#9ca3af; border-radius:10px; font-size:1.5rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; }
        .commit-popup-close:hover { background:rgba(239,68,68,.15); color:#ef4444; }
        .commit-popup-stats { display:flex; gap:1.5rem; padding:1rem 1.5rem; background:rgba(255,255,255,.03); border-bottom:1px solid rgba(255,255,255,.06); flex-wrap:wrap; }
        .commit-popup-stat { text-align:center; }
        .commit-popup-stat-value { font-size:1.3rem; font-weight:700; color:#fff; }
        .commit-popup-stat-label { font-size:.72rem; color:#71717a; }
        .commit-popup-search { padding:.75rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.06); }
        .commit-popup-search input { width:100%; padding:.6rem 1rem; border:1px solid rgba(255,255,255,.1); border-radius:10px; background:rgba(255,255,255,.04); color:#fff; font-size:.85rem; font-family:inherit; }
        .commit-popup-search input:focus { outline:none; border-color:#6366f1; }
        .commit-popup-body { padding:.75rem 1.5rem 1.5rem; max-height:48vh; overflow-y:auto; }
        .commit-item { display:flex; gap:1rem; padding:.75rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:10px; margin-bottom:.5rem; transition:all .15s; }
        .commit-item:hover { background:rgba(99,102,241,.08); border-color:rgba(99,102,241,.2); }
        .commit-hash { font-family:'Courier New',monospace; font-size:.8rem; color:#818cf8; min-width:70px; padding-top:2px; }
        .commit-hash a { color:#818cf8; text-decoration:none; }
        .commit-hash a:hover { text-decoration:underline; color:#a5b4fc; }
        .commit-info { flex:1; min-width:0; }
        .commit-message { font-size:.875rem; color:#e4e4e7; margin-bottom:.3rem; word-break:break-word; }
        .commit-message a { color:#e4e4e7; text-decoration:none; }
        .commit-message a:hover { color:#818cf8; text-decoration:underline; }
        .commit-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.75rem; color:#71717a; }
        .commit-meta-item { display:flex; align-items:center; gap:.25rem; }

        /* Popup Tabs */
        .popup-tabs { display:flex; border-bottom:1px solid rgba(255,255,255,.08); padding:0 1.5rem; gap:0; }
        .popup-tab { padding:.65rem 1.1rem; border:none; background:none; color:#71717a; font-size:.85rem; font-family:inherit; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; display:flex; align-items:center; gap:.4rem; }
        .popup-tab:hover { color:#a5b4fc; background:rgba(99,102,241,.05); }
        .popup-tab.active { color:#a5b4fc; border-bottom-color:#6366f1; }
        .popup-tab-badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:18px; padding:0 5px; border-radius:9px; background:rgba(255,255,255,.08); font-size:.7rem; font-weight:600; color:#71717a; }
        .popup-tab.active .popup-tab-badge { background:rgba(99,102,241,.2); color:#818cf8; }

        /* PR Item in popup */
        .pr-item { display:flex; gap:1rem; padding:.75rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:10px; margin-bottom:.5rem; transition:all .15s; }
        .pr-item:hover { background:rgba(99,102,241,.08); border-color:rgba(99,102,241,.2); }
        .pr-number { font-family:'Courier New',monospace; font-size:.8rem; color:#818cf8; min-width:55px; padding-top:2px; }
        .pr-number a { color:#818cf8; text-decoration:none; }
        .pr-number a:hover { text-decoration:underline; color:#a5b4fc; }
        .pr-info { flex:1; min-width:0; }
        .pr-title { font-size:.875rem; color:#e4e4e7; margin-bottom:.3rem; word-break:break-word; }
        .pr-title a { color:#e4e4e7; text-decoration:none; }
        .pr-title a:hover { color:#818cf8; text-decoration:underline; }
        .pr-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.75rem; color:#71717a; }
        .pr-state-badge { padding:.1rem .4rem; border-radius:4px; font-size:.7rem; font-weight:600; }
        .pr-state-badge.merged { background:rgba(139,92,246,.2); color:#a78bfa; }
        .pr-state-badge.open { background:rgba(34,197,94,.2); color:#4ade80; }
        .pr-state-badge.closed { background:rgba(239,68,68,.2); color:#f87171; }

        /* Clickable engagement table rows */
        .data-table tbody tr { cursor:pointer; transition:background .15s; }
        .data-table tbody tr:hover { background:rgba(99,102,241,.1) !important; }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="page-bg"><div class="grid-lines"></div></div>

    <div class="page-content">
    <!-- Custom Modal/Popup -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Alert</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="/" class="back-home-btn">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>

    <div class="container">
        <div class="page-title">
            <h1>üë• Developer Engagement</h1>
            <p class="subtitle">Monitor activity including commits, PR reviews, and code changes over time</p>
        </div>

        <!-- Select Contributors & Configure -->
        <div class="config-panel" id="configPanel">

            <div style="margin-bottom:1.25rem">
                <label style="display:block;color:#9ca3af;font-size:.82rem;font-weight:500;margin-bottom:.5rem">üë§ Select Contributors <span id="contributorCount" style="color:#818cf8;font-weight:600">0</span> selected</label>
                <div class="contributor-search-wrapper" id="contributorSearchWrapper">
                    <input type="text" id="contributorSearch" placeholder="Search contributors‚Ä¶" autocomplete="off"
                           style="width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;font-size:.9rem;font-family:inherit"
                           oninput="filterContributors()" onfocus="showContributorDropdown()">
                    <div class="contributor-dropdown" id="contributorDropdown"></div>
                </div>
                <div class="contributor-selected-tags" id="contributorSelectedTags" style="display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.6rem"></div>
            </div>

            <div style="margin-bottom:1.25rem">
                <label style="display:block;color:#9ca3af;font-size:.82rem;font-weight:500;margin-bottom:.5rem">üìÅ Select Repositories <span id="repoCount" style="color:#818cf8;font-weight:600">0</span> selected (1-10)</label>
                <div class="repo-search-wrapper" id="repoSearchWrapper">
                    <input type="text" id="repoSearch" placeholder="Search repositories‚Ä¶" autocomplete="off"
                           style="width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;font-size:.9rem;font-family:inherit"
                           oninput="filterRepos()" onfocus="showRepoDropdown()">
                    <div class="repo-dropdown" id="repoDropdown"></div>
                </div>
                <div class="repo-selected-tags" id="repoSelectedTags" style="display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.6rem"></div>
            </div>

            <!-- Exclude Merge Commits -->
            <div class="config-checkbox">
                <input type="checkbox" id="excludeMergeCommits" checked>
                <label for="excludeMergeCommits">üîÄ Exclude merge commits (recommended)</label>
            </div>

            <!-- Date Range & Period -->
            <div class="config-grid">
                <div class="config-field">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="config-field">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="config-field">
                    <label>Aggregation Period</label>
                    <select id="period">
                        <option value="DAILY">Daily</option>
                        <option value="WEEKLY" selected>Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>
            </div>

            <div class="config-actions">
                <button class="btn-action btn-analyze" onclick="analyzeEngagement()" id="analyzeBtn" disabled>
                    üìä Analyze Engagement
                </button>
            </div>

            <div id="analyze-error" class="error hidden"></div>
            <div id="analyze-loading" class="loading hidden">
                <div class="spinner"></div>
                <span id="loading-message">Initializing analysis...</span>
            </div>
        </div>

        <!-- Loading -->
        <div class="analysis-loading" id="analysisLoading">
            <div class="spinner"></div>
            <span style="color:var(--color-accent-light);font-weight:500" id="loadingText">Analyzing engagement‚Ä¶</span>
        </div>
        <div id="errorMsg" class="error-box hidden"></div>

        <!-- Results (appears below config panel on same page) -->
        <div class="results-container" id="resultsContainer">
            <h2 style="color:#fff;margin-bottom:1rem;">üìä Engagement Analysis Results</h2>

            <!-- Loading Status Panel -->
            <div id="loadingStatusPanel" class="hidden" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; display: flex; gap: 1.5rem; align-items: center;">
                <span style="font-size: 0.875rem; color: #a1a1aa;">Loading:</span>
                <div style="display: flex; gap: 1rem;">
                    <div>üìù Commits: <span id="status-commits"></span></div>
                    <div>üöÄ PRs & Reviews: <span id="status-prs"></span></div>
                </div>
            </div>

            <!-- Analysis Info -->
            <div id="analysisInfo" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px;"></div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards"></div>

            <!-- Contributor Filter for Charts -->
            <div class="panel">
                <h3 style="margin-bottom: 0.5rem;">üéØ Filter by Contributor</h3>
                <div class="contributor-filter" id="contributorFilter"></div>
            </div>

            <!-- Charts Section -->
            <h3 style="margin: 1.5rem 0 1rem;">üìà Commits</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of code commits made by each contributor.
                Commits represent individual units of work pushed to the repository. Higher commit counts indicate active code contribution.
                <em>Note: Merge commits are excluded by default for accurate measurement.</em>
            </p>
            <div class="charts-grid" id="commitsChartsSection">
                <div class="chart-panel">
                    <h3>üìä Total Commits by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total commit count between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsBarChartShimmer"></div>
                        <canvas id="commitsBarChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>üìâ Commits Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows commit activity distribution across the selected time period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsLineChartShimmer"></div>
                        <canvas id="commitsLineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PR Merge Velocity -->
            <h3 style="margin: 1.5rem 0 1rem;">üöÄ PR Merge Velocity (Impact)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Requests created/merged by each contributor.
                This metric shows "Impact" - how many ideas and features were actually completed and shipped.
                High PR velocity indicates a developer who delivers finished work regularly.
            </p>
            <div class="charts-grid" id="prChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedLineChartShimmer"></div>
                        <canvas id="prsMergedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedBarChartShimmer"></div>
                        <canvas id="prsMergedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Review Responsiveness -->
            <h3 style="margin: 1.5rem 0 1rem;">üë• Review Responsiveness (Team Player)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Request reviews performed by each contributor.
                This metric shows "Team Player" status - developers who actively help others by reviewing their code.
                High review counts indicate strong collaboration and mentorship within the team.
            </p>
            <div class="charts-grid" id="reviewChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedLineChartShimmer"></div>
                        <canvas id="prsReviewedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedBarChartShimmer"></div>
                        <canvas id="prsReviewedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Commit Consistency / Active Days -->
            <h3 style="margin: 1.5rem 0 1rem;">üìÖ Commit Consistency (Active Days)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of days a contributor had any activity (commits, PRs, reviews, etc.).
                This metric shows "Flow" - consistent daily engagement is better than sporadic bursts of activity.
                High active days indicate steady, sustainable work patterns.
            </p>
            <div class="charts-grid" id="activeDaysChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysLineChartShimmer"></div>
                        <canvas id="activeDaysLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysBarChartShimmer"></div>
                        <canvas id="activeDaysBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="panel" style="margin-top: 1.5rem;">
                <h3>üìã Contributor Engagement Summary</h3>
                <p style="font-size: 0.82rem; color: #71717a; margin: -0.25rem 0 0.75rem;">üí° Click on a contributor row to view their commit history</p>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Contributor</th>
                                <th>Commits</th>
                                <th style="color: #22c55e;">Lines Added</th>
                                <th style="color: #ef4444;">Lines Deleted</th>
                                <th>PRs Merged</th>
                                <th>PRs Reviewed</th>
                                <th>Active Days</th>
                            </tr>
                        </thead>
                        <tbody id="engagementTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Activity Popup Modal -->
    <div id="commitPopupModal" class="commit-popup-modal" onclick="closeCommitPopup(event)">
        <div class="commit-popup-content" onclick="event.stopPropagation()">
            <div class="commit-popup-header">
                <div class="commit-popup-user-info">
                    <img id="commitPopupAvatar" class="commit-popup-avatar" src="" alt="">
                    <div>
                        <div class="commit-popup-name" id="commitPopupName">Developer Name</div>
                        <div class="commit-popup-login" id="commitPopupLogin">@username</div>
                    </div>
                </div>
                <button class="commit-popup-close" onclick="closeCommitPopup()">√ó</button>
            </div>
            <div class="commit-popup-stats" id="commitPopupStats"></div>
            <!-- Tabs -->
            <div class="popup-tabs">
                <button class="popup-tab active" data-tab="commits" onclick="switchPopupTab('commits')">
                    <span>‚å®Ô∏è</span> Commits <span class="popup-tab-badge" id="tabBadgeCommits">0</span>
                </button>
                <button class="popup-tab" data-tab="prs-merged" onclick="switchPopupTab('prs-merged')">
                    <span>üîÄ</span> PRs Merged <span class="popup-tab-badge" id="tabBadgePRsMerged">0</span>
                </button>
                <button class="popup-tab" data-tab="prs-reviewed" onclick="switchPopupTab('prs-reviewed')">
                    <span>üëÅÔ∏è</span> PRs Reviewed <span class="popup-tab-badge" id="tabBadgePRsReviewed">0</span>
                </button>
            </div>
            <div class="commit-popup-search">
                <input type="text" id="commitSearchInput" placeholder="Search‚Ä¶" oninput="filterPopupTab()">
            </div>
            <div class="commit-popup-body" id="commitPopupBody"></div>
        </div>
    </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let contributors = [];
        let selectedContributors = new Set();
        let analysisData = null;
        let selectedContributorsForChart = new Set();

        // Charts - Commits
        let commitsLineChart = null;
        let commitsBarChart = null;

        // Charts - PRs Merged (Impact)
        let prsMergedLineChart = null;
        let prsMergedBarChart = null;

        // Charts - PRs Reviewed (Team Player)
        let prsReviewedLineChart = null;
        let prsReviewedBarChart = null;

        // Charts - Active Days (Consistency)
        let activeDaysLineChart = null;
        let activeDaysBarChart = null;

        // Organizations found
        let organizations = [];

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present (nicknames have @)
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            // Debug logging
            if (displayName && displayName !== loginOrNickname) {
                console.debug(`‚úÖ getDisplayName('${loginOrNickname}') -> '${displayName}'`);
            }

            return result;
        }

        /**
         * Get avatar URL for a contributor login
         * Fetches from cached session data
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Custom Modal Functions
        function showModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeModal();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Detect if running in iframe
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }

            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Auto-load contributors from session
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    contributors = sessionData.contributors.map(c => ({
                        login: c.login,
                        name: c.name || null,  // Include name for display
                        avatarUrl: c.avatarUrl || c.avatar_url,
                        profileUrl: c.profileUrl || c.html_url,
                        contributions: 0
                    }));
                    organizations = sessionData.organizations || [];

                    // Create display name lookup map from session contributors
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                    console.log('üìã Sample displayNameMap:', Object.entries(window.displayNameMap).slice(0, 5));
                    console.log('üìã Contributors with names:', sessionData.contributors.filter(c => c.name && c.name !== c.login).length, '/', sessionData.contributors.length);

                    // Auto-load repositories
                    if (sessionData.repositories && sessionData.repositories.length > 0) {
                        repositories = sessionData.repositories.map(r => r.fullName);

                        // Render repository dropdown
                        renderRepoDropdown(repositories);
                        renderRepoSelectedTags();
                    }

                    renderContributorDropdown(contributors);
                    renderContributorSelectedTags();

                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Provider selection
        function selectProvider(provider) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.provider === provider);
            });
            document.getElementById('custom-url-group').classList.toggle('hidden', provider !== 'GITLAB');
        }

        // Show/hide results (config panel always stays visible)
        function showResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.add('visible');
            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.remove('visible');
        }

        // Legacy goToStep calls mapped to new pattern
        function goToStep(step) {
            if (step === 3) {
                showResults();
            } else {
                hideResults();
            }
        }

        // ==================== REPO DROPDOWN ====================
        function renderRepoDropdown(repos) {
            const dd = document.getElementById('repoDropdown');
            if (!repos.length) {
                dd.innerHTML = '<div class="repo-dropdown-empty">No repositories found</div>';
                return;
            }
            dd.innerHTML = repos.map(repo => {
                const fullName = typeof repo === 'string' ? repo : repo.fullName;
                const isPrivate = typeof repo === 'object' && repo.isPrivate;
                const isSelected = selectedRepos.has(fullName);
                const icon = isPrivate ? 'üîí' : 'üìÇ';
                return `<div class="repo-dropdown-item ${isSelected ? 'selected' : ''}" onclick="toggleRepo('${fullName.replace(/'/g, "\\'")}')">
                    <span class="repo-check">${isSelected ? '‚úì' : ''}</span>
                    <span class="repo-icon">${icon}</span>
                    ${fullName}
                </div>`;
            }).join('');
        }

        function filterRepos() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = repositories.filter(r => {
                const name = typeof r === 'string' ? r : r.fullName;
                return name.toLowerCase().includes(q);
            });
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function showRepoDropdown() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => {
                const name = typeof r === 'string' ? r : r.fullName;
                return name.toLowerCase().includes(q);
            }) : repositories;
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function toggleRepo(fullName) {
            if (selectedRepos.has(fullName)) {
                selectedRepos.delete(fullName);
            } else {
                if (selectedRepos.size >= 10) {
                    showModal('‚ö†Ô∏è', 'Maximum Limit Reached', 'You can select a maximum of 10 repositories.');
                    return;
                }
                selectedRepos.add(fullName);
            }
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => {
                const name = typeof r === 'string' ? r : r.fullName;
                return name.toLowerCase().includes(q);
            }) : repositories;
            renderRepoDropdown(filtered);
            renderRepoSelectedTags();
            updateRepoCount();
        }

        function removeRepo(fullName) {
            selectedRepos.delete(fullName);
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => {
                const name = typeof r === 'string' ? r : r.fullName;
                return name.toLowerCase().includes(q);
            }) : repositories;
            renderRepoDropdown(filtered);
            renderRepoSelectedTags();
            updateRepoCount();
        }

        function renderRepoSelectedTags() {
            const container = document.getElementById('repoSelectedTags');
            if (selectedRepos.size === 0) {
                container.innerHTML = '<span style="color:#52525b;font-size:.8rem">No repositories selected</span>';
                return;
            }
            container.innerHTML = Array.from(selectedRepos).map(name => {
                const short = name.split('/').pop();
                return `<span class="repo-tag">${short}<span class="tag-remove" onclick="removeRepo('${name.replace(/'/g, "\\'")}')">&times;</span></span>`;
            }).join('');
        }

        function updateRepoCount() {
            const el = document.getElementById('repoCount');
            if (el) el.textContent = selectedRepos.size;
        }

        // ==================== CONTRIBUTOR DROPDOWN ====================
        function renderContributorDropdown(contribs) {
            const dd = document.getElementById('contributorDropdown');
            if (!contribs.length) {
                dd.innerHTML = '<div class="contributor-dropdown-empty">No contributors found</div>';
                return;
            }
            dd.innerHTML = contribs.map(c => {
                const isSelected = selectedContributors.has(c.login);
                const displayName = getDisplayName(c.login);
                return `<div class="contributor-dropdown-item ${isSelected ? 'selected' : ''}" onclick="toggleContributor('${c.login.replace(/'/g, "\\'")}')">
                    <span class="dd-check">${isSelected ? '‚úì' : ''}</span>
                    ${c.avatarUrl ? `<img class="dd-avatar" src="${c.avatarUrl}" alt="">` : ''}
                    <span>${displayName} <span style="color:#71717a;font-size:.75rem">@${c.login}</span></span>
                </div>`;
            }).join('');
        }

        function filterContributors() {
            const q = document.getElementById('contributorSearch').value.toLowerCase();
            const filtered = contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                return c.login.toLowerCase().includes(q) ||
                       (c.name && c.name.toLowerCase().includes(q)) ||
                       (displayName && displayName.toLowerCase().includes(q));
            });
            renderContributorDropdown(filtered);
            document.getElementById('contributorDropdown').classList.add('show');
        }

        function showContributorDropdown() {
            const q = document.getElementById('contributorSearch').value.toLowerCase();
            const filtered = q ? contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                return c.login.toLowerCase().includes(q) ||
                       (c.name && c.name.toLowerCase().includes(q)) ||
                       (displayName && displayName.toLowerCase().includes(q));
            }) : contributors;
            renderContributorDropdown(filtered);
            document.getElementById('contributorDropdown').classList.add('show');
        }

        function toggleContributor(login) {
            if (selectedContributors.has(login)) {
                selectedContributors.delete(login);
            } else {
                selectedContributors.add(login);
            }
            const q = document.getElementById('contributorSearch').value.toLowerCase();
            const filtered = q ? contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                return c.login.toLowerCase().includes(q) ||
                       (c.name && c.name.toLowerCase().includes(q)) ||
                       (displayName && displayName.toLowerCase().includes(q));
            }) : contributors;
            renderContributorDropdown(filtered);
            renderContributorSelectedTags();
            updateContributorCount();
        }

        function removeContributor(login) {
            selectedContributors.delete(login);
            const q = document.getElementById('contributorSearch').value.toLowerCase();
            const filtered = q ? contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                return c.login.toLowerCase().includes(q) ||
                       (c.name && c.name.toLowerCase().includes(q)) ||
                       (displayName && displayName.toLowerCase().includes(q));
            }) : contributors;
            renderContributorDropdown(filtered);
            renderContributorSelectedTags();
            updateContributorCount();
        }

        function renderContributorSelectedTags() {
            const container = document.getElementById('contributorSelectedTags');
            if (selectedContributors.size === 0) {
                container.innerHTML = '<span style="color:#52525b;font-size:.8rem">No contributors selected</span>';
                return;
            }
            container.innerHTML = Array.from(selectedContributors).map(login => {
                const displayName = getDisplayName(login);
                const avatarUrl = getAvatarUrl(login);
                const avatarImg = avatarUrl ? `<img class="tag-avatar" src="${avatarUrl}" alt="">` : '';
                return `<span class="contributor-tag">${avatarImg}${displayName}<span class="tag-remove" onclick="removeContributor('${login.replace(/'/g, "\\'")}')">&times;</span></span>`;
            }).join('');
        }

        function updateContributorCount() {
            document.getElementById('contributorCount').textContent = selectedContributors.size;
            document.getElementById('analyzeBtn').disabled = selectedContributors.size === 0;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const repoWrapper = document.getElementById('repoSearchWrapper');
            if (repoWrapper && !repoWrapper.contains(e.target)) {
                document.getElementById('repoDropdown').classList.remove('show');
            }
            const contribWrapper = document.getElementById('contributorSearchWrapper');
            if (contribWrapper && !contribWrapper.contains(e.target)) {
                document.getElementById('contributorDropdown').classList.remove('show');
            }
        });


        // Analyze engagement - PARALLEL loading for speed
        async function analyzeEngagement() {
            console.log('üöÄ analyzeEngagement() started');

            try {
                // Validate contributors
                console.log('üìä Validating contributors...', { count: selectedContributors.size });
                if (selectedContributors.size === 0) {
                    console.warn('‚ùå No contributors selected');
                    showModal('üë•', 'Contributors Required', 'Please select at least one contributor to analyze.');
                    return;
                }

                // Validate repositories (1-10 required)
                console.log('üìÅ Validating repositories...', { count: selectedRepos.size });
                if (selectedRepos.size === 0) {
                    console.warn('‚ùå No repositories selected');
                    showModal('üìÅ', 'Repositories Required', 'Please select at least 1 repository to analyze.');
                    return;
                }

                if (selectedRepos.size > 10) {
                    console.warn('‚ùå Too many repositories selected:', selectedRepos.size);
                    showModal('‚ö†Ô∏è', 'Too Many Repositories', 'You can select a maximum of 10 repositories. Please deselect some repositories.');
                    return;
                }

                console.log('‚úÖ Validation passed');
                hideError('analyze-error');

                // Reset all state before new analysis
                console.log('üîÑ Resetting state for new analysis...');
                analysisData = null;
                selectedContributorsForChart = new Set();
                window.pendingPRData = null; // Clear any pending PR data from previous run

                // Destroy all existing charts
                if (commitsLineChart) { commitsLineChart.destroy(); commitsLineChart = null; }
                if (commitsBarChart) { commitsBarChart.destroy(); commitsBarChart = null; }
                if (prsMergedLineChart) { prsMergedLineChart.destroy(); prsMergedLineChart = null; }
                if (prsMergedBarChart) { prsMergedBarChart.destroy(); prsMergedBarChart = null; }
                if (prsReviewedLineChart) { prsReviewedLineChart.destroy(); prsReviewedLineChart = null; }
                if (prsReviewedBarChart) { prsReviewedBarChart.destroy(); prsReviewedBarChart = null; }
                if (activeDaysLineChart) { activeDaysLineChart.destroy(); activeDaysLineChart = null; }
                if (activeDaysBarChart) { activeDaysBarChart.destroy(); activeDaysBarChart = null; }
                console.log('‚úÖ State reset complete');

                const sessionData = getSessionData();
                console.log('üì¶ Session data retrieved:', {
                    hasToken: !!sessionData?.token,
                    provider: sessionData?.provider,
                    hasBaseUrl: !!sessionData?.baseUrl
                });

                const token = sessionData?.token || '';
                const startDate = document.getElementById('startDate').value || null;
                const endDate = document.getElementById('endDate').value || null;
                const period = document.getElementById('period').value;
                const reposToAnalyze = Array.from(selectedRepos);

                const requestBody = {
                    token: token,
                    provider: selectedProvider,
                    baseUrl: sessionData?.baseUrl || null,
                    repositoryFullNames: reposToAnalyze,
                    contributorLogins: Array.from(selectedContributors),
                    startDate: startDate,
                    endDate: endDate,
                    period: period,
                    excludeMergeCommits: document.getElementById('excludeMergeCommits').checked
                };

                console.log('üìù Request body prepared:', {
                    provider: requestBody.provider,
                    repoCount: requestBody.repositoryFullNames.length,
                    contributorCount: requestBody.contributorLogins.length,
                    dateRange: `${startDate} to ${endDate}`,
                    period: period,
                    excludeMergeCommits: requestBody.excludeMergeCommits
                });

                // Go to results page immediately with shimmer loading
                console.log('üé¨ Navigating to results page...');
                goToStep(3);
                showShimmerLoading();

                // Start BOTH API calls in PARALLEL
                console.log('üîÑ Starting parallel API calls...');
                updateLoadingStatus('commits', 'loading');
                updateLoadingStatus('prs', 'loading');

                const commitsPromise = fetch('/api/engagement/analyze/commits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).then(r => {
                    console.log('üì° Commits API response received:', { status: r.status, ok: r.ok });
                    if (!r.ok) {
                        return r.text().then(text => {
                            console.error('‚ùå Commits API error response body:', text);
                            throw new Error(`Failed to fetch commits: ${r.status} ${r.statusText}`);
                        });
                    }
                    return r.json();
                }).then(data => {
                    console.log('‚úÖ Commits data parsed successfully:', {
                        hasContributors: !!data?.contributors,
                        contributorCount: data?.contributors?.length || 0,
                        hasAnalyzedRepos: !!data?.analyzedRepositories
                    });
                    return data;
                });

                const prsPromise = fetch('/api/engagement/analyze/prs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).then(async r => {
                    console.log('üì° PRs API response received:', {
                        status: r.status,
                        ok: r.ok,
                        statusText: r.statusText,
                        headers: {
                            contentType: r.headers.get('content-type'),
                            contentLength: r.headers.get('content-length')
                        }
                    });

                    // Get raw text first to see what we're dealing with
                    const rawText = await r.text();
                    console.log('üìÑ PRs raw response text (first 500 chars):', rawText.substring(0, 500));
                    console.log('üìÑ PRs raw response length:', rawText.length);

                    if (!r.ok) {
                        console.error('‚ùå PRs API error response body:', rawText);
                        throw new Error(`Failed to fetch PRs: ${r.status} ${r.statusText} - ${rawText.substring(0, 200)}`);
                    }

                    // Try to parse JSON
                    let data;
                    try {
                        data = JSON.parse(rawText);
                        console.log('‚úÖ PRs JSON parsed successfully');
                    } catch (parseError) {
                        console.error('‚ùå Failed to parse PRs JSON:', parseError);
                        console.error('‚ùå Raw text was:', rawText.substring(0, 1000));
                        throw new Error(`Failed to parse PR response as JSON: ${parseError.message}`);
                    }

                    console.log('üì¶ PRs parsed data:', data);
                    console.log('üì¶ PRs data type:', typeof data);
                    console.log('üì¶ PRs data keys:', data ? Object.keys(data) : 'null');
                    console.log('üì¶ PRs contributors check:', {
                        hasData: !!data,
                        hasContributors: data ? ('contributors' in data) : false,
                        contributorsType: data?.contributors ? typeof data.contributors : 'undefined',
                        isArray: Array.isArray(data?.contributors),
                        contributorCount: data?.contributors?.length || 0,
                        firstContributor: data?.contributors?.[0] || null
                    });

                    if (!data) {
                        console.error('‚ùå PRs data is null or undefined after parsing!');
                        throw new Error('PR response data is null');
                    }

                    if (!data.contributors) {
                        console.error('‚ùå PRs data.contributors is missing!');
                        console.error('‚ùå Full data object:', JSON.stringify(data, null, 2));
                        throw new Error('PR response missing contributors field');
                    }

                    console.log('‚úÖ PRs data validated successfully');
                    return data;
                });

                // Handle commits when ready (usually faster)
                commitsPromise.then(data => {
                    console.log('üéØ Processing commits data...');
                    try {
                        analysisData = data;
                        updateLoadingStatus('commits', 'complete');
                        displayCommitsResults(data);
                        console.log('‚úÖ Commits results displayed successfully');
                    } catch (err) {
                        console.error('‚ùå Error displaying commits results:', err);
                        throw err;
                    }
                }).catch(err => {
                    console.error('‚ùå Commits promise error:', err);
                    updateLoadingStatus('commits', 'error');
                    showModal('‚ùå', 'Commits Loading Failed', `Failed to load commits data: ${err.message}`);
                });

                // Handle PRs when ready (usually slower)
                prsPromise.then(prData => {
                    console.log('üéØ Processing PRs data...');
                    console.log('üì¶ Raw prData:', prData);
                    try {
                        // Validate prData before processing
                        if (!prData) {
                            console.error('‚ùå prData is null or undefined');
                            throw new Error('PR response data is null');
                        }

                        // Calculate totals for status display
                        if (prData.contributors && Array.isArray(prData.contributors)) {
                            const totalPRs = prData.contributors.reduce((sum, c) => sum + (c.prsMerged || 0), 0);
                            const totalReviews = prData.contributors.reduce((sum, c) => sum + (c.prsReviewed || 0), 0);
                            console.log('üìä PRs stats:', { totalPRs, totalReviews });
                            updateLoadingStatus('prs', 'complete', `${totalPRs} PRs, ${totalReviews} Reviews`);
                        } else {
                            console.warn('‚ö†Ô∏è PRs data structure unexpected:', prData);
                            console.warn('‚ö†Ô∏è prData.contributors:', prData.contributors);
                            updateLoadingStatus('prs', 'complete', 'No PR data');
                        }
                        mergePRDataIntoResults(prData);
                        displayPRResults();
                        console.log('‚úÖ PRs results displayed successfully');
                    } catch (err) {
                        console.error('‚ùå Error displaying PRs results:', err);
                        throw err;
                    }
                }).catch(err => {
                    console.error('‚ùå PRs promise error:', err);
                    updateLoadingStatus('prs', 'error');
                    console.log('üîÑ Handling PR error - restoring chart sections...');

                    // Restore PR chart sections with error message
                    restorePRChartSectionsWithError();

                    // Hide PR shimmers on error
                    hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);

                    // Update summary cards to show N/A instead of spinner
                    const prsMergedCard = document.getElementById('prsMergedCard');
                    const prsReviewedCard = document.getElementById('prsReviewedCard');
                    const activeDaysCard = document.getElementById('activeDaysCard');
                    if (prsMergedCard) {
                        const cardValue = prsMergedCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }
                    if (prsReviewedCard) {
                        const cardValue = prsReviewedCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }
                    if (activeDaysCard) {
                        const cardValue = activeDaysCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }

                    // Update table to show N/A for PR columns
                    updateTableWithPRError();

                    showModal('‚ö†Ô∏è', 'PRs Loading Failed', `Failed to load PRs data: ${err.message}`);
                });

                // Wait for both to complete (for error handling)
                console.log('‚è≥ Waiting for both API calls to complete...');
                const results = await Promise.allSettled([commitsPromise, prsPromise]);
                console.log('‚úÖ Both API calls completed:', {
                    commits: results[0].status,
                    prs: results[1].status
                });

                if (results[0].status === 'rejected') {
                    console.error('‚ùå Commits failed:', results[0].reason);
                }
                if (results[1].status === 'rejected') {
                    console.error('‚ùå PRs failed:', results[1].reason);
                }

            } catch (error) {
                console.error('‚ùå FATAL ERROR in analyzeEngagement():', error);
                console.error('Error stack:', error.stack);
                showModal('‚ùå', 'Analysis Failed', `An unexpected error occurred: ${error.message}`);
                updateLoadingStatus('commits', 'error');
                updateLoadingStatus('prs', 'error');
            }
        }

        // Show shimmer loading placeholders
        function showShimmerLoading() {
            document.getElementById('analysisInfo').innerHTML = `
                <div class="shimmer shimmer-text" style="width: 200px; height: 24px;"></div>
            `;

            document.getElementById('summaryCards').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    ${[1,2,3,4,5].map(() => `<div class="shimmer shimmer-card"></div>`).join('')}
                </div>
            `;

            // Clear contributor filter
            const contributorFilter = document.getElementById('contributorFilter');
            if (contributorFilter) {
                contributorFilter.innerHTML = '<div class="shimmer" style="height: 32px; width: 100%;"></div>';
            }

            // Clear engagement table
            const engagementTableBody = document.getElementById('engagementTableBody');
            if (engagementTableBody) {
                engagementTableBody.innerHTML = `
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                `;
            }

            // Show loading status indicators
            document.getElementById('loadingStatusPanel').classList.remove('hidden');
            updateLoadingStatus('commits', 'pending');
            updateLoadingStatus('prs', 'pending');

            // Show shimmers on ALL chart containers
            showChartShimmers(['commitsLineChart', 'commitsBarChart']);
            showChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Show shimmer overlay on specific charts
        function showChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.remove('hidden');
                }
            });
        }

        // Hide shimmer overlay on specific charts
        function hideChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.add('hidden');
                }
            });
        }

        // Update loading status indicator
        function updateLoadingStatus(section, status, customText = null) {
            const el = document.getElementById(`status-${section}`);
            if (!el) return;

            if (status === 'pending') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(113,113,122,0.2); color: #71717a;">‚è≥ Pending</span>`;
            } else if (status === 'loading') {
                el.innerHTML = `<span class="status-indicator status-loading"><span class="mini-spinner"></span> Loading...</span>`;
            } else if (status === 'complete') {
                const text = customText || '‚úì Complete';
                el.innerHTML = `<span class="status-indicator status-complete">‚úì ${text}</span>`;
            } else if (status === 'error') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚úó Failed</span>`;
            }
        }

        // Display commits results
        function displayCommitsResults(data) {
            console.log('üìä displayCommitsResults() called', {
                hasData: !!data,
                hasContributors: !!data?.contributors,
                contributorCount: data?.contributors?.length || 0,
                hasSummary: !!data?.summary,
                hasDateRange: !!data?.dateRange
            });

            try {
                selectedContributorsForChart = new Set(data.contributors.map(c => c.login));
                console.log('üë• Contributors for chart filter:', selectedContributorsForChart.size);

                const repos = data.analyzedRepositories || [];
                const repoCount = repos.length;

                // Store repos globally for toggleRepoDetails function
                window.analysisRepos = repos;

                document.getElementById('analysisInfo').innerHTML = `
                    <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                        <strong>üìÅ Repositories:</strong>
                        <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                        <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                            style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                    </div>
                    <div id="repoDetailsBox" style="display:none;"></div>
                    <p style="font-size:0.85rem; color:#a1a1aa;">
                        üìÖ ${data.dateRange.startDate} to ${data.dateRange.endDate}<br>
                        üìä Period: ${data.period}
                    </p>
                `;

                // Summary cards - commits only first
                const s = data.summary;
                document.getElementById('summaryCards').innerHTML = `
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-icon">üë•</div>
                            <div class="card-value">${s.totalContributors}</div>
                            <div class="card-label">Contributors</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">üìù</div>
                            <div class="card-value">${s.totalCommits.toLocaleString()}</div>
                            <div class="card-label">Total Commits</div>
                        </div>
                        <div class="summary-card" id="prsMergedCard">
                            <div class="card-icon">üöÄ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">PRs Merged</div>
                        </div>
                        <div class="summary-card" id="prsReviewedCard">
                            <div class="card-icon">üëÄ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">PRs Reviewed</div>
                        </div>
                        <div class="summary-card" id="activeDaysCard">
                            <div class="card-icon">üìÖ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">Active Days</div>
                        </div>
                    </div>
                `;

                // Render contributor filter chips
                console.log('üîÑ About to render contributor filter:', {
                    contributorsArray: data.contributors,
                    contributorLogins: data.contributors?.map(c => c.login),
                    selectedContributorsForChart: Array.from(selectedContributorsForChart)
                });
                renderContributorFilter(data.contributors);

                // Render commits charts immediately
                renderCommitsCharts(data);
                renderEngagementTable(data.contributors, true); // partial = true, no PR data yet

                // Show shimmer for PR sections
                showPRSectionsShimmer();

                // Check if PR data arrived before commits (was stored as pending)
                if (window.pendingPRData) {
                    console.log('üì¶ Found pending PR data, merging now...');
                    mergePRDataIntoResults(window.pendingPRData);
                    displayPRResults();
                    window.pendingPRData = null;
                }
            } catch (err) {
                console.error('‚ùå Error in displayCommitsResults():', err);
                console.error('Error stack:', err.stack);
                throw err;
            }

            console.log('‚úÖ displayCommitsResults() completed successfully');
        }

        // Show shimmer for PR/review sections
        function showPRSectionsShimmer() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) prSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (reviewSection) reviewSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (activeDaysSection) activeDaysSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
        }

        // Merge PR data into existing results
        function mergePRDataIntoResults(prData) {
            console.log('üîÑ mergePRDataIntoResults() called', {
                hasPRData: !!prData,
                hasContributors: !!prData?.contributors,
                contributorCount: prData?.contributors?.length || 0,
                hasAnalysisData: !!analysisData,
                analysisDataContributors: analysisData?.contributors?.length || 0
            });

            try {
                if (!prData || !prData.contributors) {
                    console.warn('‚ö†Ô∏è No PR data to merge');
                    return;
                }

                // Check if analysisData is ready
                if (!analysisData || !analysisData.contributors) {
                    console.warn('‚ö†Ô∏è analysisData is not ready yet, storing PR data for later merge');
                    // Store PR data to merge later when analysisData is ready
                    window.pendingPRData = prData;
                    return;
                }

                console.log('üîÄ Merging PR data into analysis data...');
                // Update summary
                let totalPRs = 0, totalReviews = 0, totalActiveDays = 0;

                prData.contributors.forEach(prContrib => {
                    totalPRs += prContrib.prsMerged || 0;
                    totalReviews += prContrib.prsReviewed || 0;
                    totalActiveDays += prContrib.activeDays || 0;

                    // Merge into main data
                    const mainContrib = analysisData.contributors.find(c => c.login === prContrib.login);
                    if (mainContrib) {
                        mainContrib.prsMerged = prContrib.prsMerged;
                        mainContrib.prsReviewed = prContrib.prsReviewed;
                        mainContrib.activeDays = prContrib.activeDays;
                        mainContrib.prsMergedOverTime = prContrib.prsMergedOverTime;
                        mainContrib.prsReviewedOverTime = prContrib.prsReviewedOverTime;
                        mainContrib.activeDaysOverTime = prContrib.activeDaysOverTime;
                        mainContrib.prDetails = prContrib.prDetails || [];
                        mainContrib.reviewDetails = prContrib.reviewDetails || [];
                    } else {
                        console.warn(`‚ö†Ô∏è Could not find contributor ${prContrib.login} in analysisData to merge PR data`);
                    }
                });

                if (analysisData.summary) {
                    analysisData.summary.totalPRsMerged = totalPRs;
                    analysisData.summary.totalPRsReviewed = totalReviews;
                    analysisData.summary.totalActiveDays = totalActiveDays;
                }

                console.log('‚úÖ PR data merged successfully', { totalPRs, totalReviews, totalActiveDays });
            } catch (err) {
                console.error('‚ùå Error in mergePRDataIntoResults():', err);
                console.error('Error stack:', err.stack);
                // Don't throw - let the page continue working even if merge fails
            }
        }

        // Display PR results
        function displayPRResults() {
            console.log('üöÄ displayPRResults() called', {
                hasAnalysisData: !!analysisData,
                hasContributors: !!analysisData?.contributors,
                hasSummary: !!analysisData?.summary
            });

            try {
                if (!analysisData || !analysisData.contributors) {
                    console.warn('‚ö†Ô∏è No analysis data available for PR display, skipping');
                    return;
                }

                console.log('üìä Rendering PR charts...');
                // Restore PR chart sections (they were replaced by shimmer)
                restorePRChartSections();

                // Update summary cards safely
                const s = analysisData.summary || {};
                const prsMergedCard = document.getElementById('prsMergedCard');
                const prsReviewedCard = document.getElementById('prsReviewedCard');
                const activeDaysCard = document.getElementById('activeDaysCard');

                if (prsMergedCard) {
                    const cardValue = prsMergedCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalPRsMerged || 0).toLocaleString();
                }
                if (prsReviewedCard) {
                    const cardValue = prsReviewedCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalPRsReviewed || 0).toLocaleString();
                }
                if (activeDaysCard) {
                    const cardValue = activeDaysCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalActiveDays || 0).toLocaleString();
                }

                // Render PR charts
                renderPRCharts(analysisData);
                renderEngagementTable(analysisData.contributors, false); // full data now

                console.log('‚úÖ displayPRResults() completed successfully');
            } catch (err) {
                console.error('‚ùå Error in displayPRResults():', err);
                console.error('Error stack:', err.stack);
                // Don't throw - let the page continue working
            }
        }

        // Restore PR chart sections that were replaced by shimmer
        function restorePRChartSections() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) {
                prSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedLineChartShimmer"></div>
                            <canvas id="prsMergedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedBarChartShimmer"></div>
                            <canvas id="prsMergedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (reviewSection) {
                reviewSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedLineChartShimmer"></div>
                            <canvas id="prsReviewedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedBarChartShimmer"></div>
                            <canvas id="prsReviewedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (activeDaysSection) {
                activeDaysSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysLineChartShimmer"></div>
                            <canvas id="activeDaysLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysBarChartShimmer"></div>
                            <canvas id="activeDaysBarChart"></canvas>
                        </div>
                    </div>
                `;
            }
        }

        // Restore PR chart sections with error state
        function restorePRChartSectionsWithError() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            const errorHtml = `
                <div class="chart-panel" style="display: flex; align-items: center; justify-content: center; min-height: 150px;">
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <div style="font-size: 0.9rem;">Failed to load PR data</div>
                        <div style="font-size: 0.75rem; color: #a1a1aa; margin-top: 0.25rem;">GitHub API rate limit may have been reached</div>
                    </div>
                </div>
            `;

            if (prSection) {
                prSection.innerHTML = errorHtml + errorHtml;
            }
            if (reviewSection) {
                reviewSection.innerHTML = errorHtml + errorHtml;
            }
            if (activeDaysSection) {
                activeDaysSection.innerHTML = errorHtml + errorHtml;
            }
        }

        // Update table to show N/A for PR columns when PR loading fails
        function updateTableWithPRError() {
            const tbody = document.getElementById('engagementTableBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                // Cells: Contributor, Commits, Lines Added, Lines Deleted, PRs Merged, PRs Reviewed, Active Days
                // Update cells 4, 5, 6 (0-indexed)
                if (cells.length >= 7) {
                    cells[4].textContent = 'N/A';
                    cells[5].textContent = 'N/A';
                    cells[6].textContent = 'N/A';
                }
            });
        }

        // Render only commits charts
        function renderCommitsCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // Commits Over Time Line Chart
            if (commitsLineChart) commitsLineChart.destroy();
            commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.commitsOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Commits Bar Chart
            if (commitsBarChart) commitsBarChart.destroy();
            commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Total Commits',
                        data: contributors.map(c => c.totalCommits),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide commit chart shimmers after rendering
            hideChartShimmers(['commitsLineChart', 'commitsBarChart']);
        }

        // Render PR and review charts
        function renderPRCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // PRs Merged Over Time
            if (prsMergedLineChart) prsMergedLineChart.destroy();
            prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsMergedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Merged Bar Chart
            if (prsMergedBarChart) prsMergedBarChart.destroy();
            prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Merged',
                        data: contributors.map(c => c.prsMerged || 0),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Over Time
            if (prsReviewedLineChart) prsReviewedLineChart.destroy();
            prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsReviewedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Bar Chart
            if (prsReviewedBarChart) prsReviewedBarChart.destroy();
            prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Reviewed',
                        data: contributors.map(c => c.prsReviewed || 0),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Over Time
            if (activeDaysLineChart) activeDaysLineChart.destroy();
            activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.activeDaysOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Bar Chart
            if (activeDaysBarChart) activeDaysBarChart.destroy();
            activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Active Days',
                        data: contributors.map(c => c.activeDays || 0),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide PR/review/active days chart shimmers after rendering
            hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Render engagement table
        function renderEngagementTable(contributors, partial = false) {
            const tbody = document.getElementById('engagementTableBody');
            // Store contributors globally for popup access
            window._currentEngagementContributors = contributors;
            tbody.innerHTML = contributors.map((c, index) => {
                const avatarUrl = getAvatarUrl(c.login);
                return `
                    <tr onclick="showContributorCommits(${index})" title="Click to view ${getDisplayName(c.login)}'s commits">
                        <td class="contributor-cell">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${getDisplayName(c.login)}">` : '<span style="font-size: 1.2em;">üë§</span>'}
                            <span>${getDisplayName(c.login)}</span>
                        </td>
                        <td>${c.totalCommits.toLocaleString()}</td>
                        <td style="color: #22c55e;">+${(c.totalLinesAdded || 0).toLocaleString()}</td>
                        <td style="color: #ef4444;">-${(c.totalLinesDeleted || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsMerged || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsReviewed || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.activeDays || 0).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle repo list view in results
        function toggleRepoDetails() {
            const box = document.getElementById('repoDetailsBox');
            const btn = document.getElementById('repoToggleBtn');

            if (box.style.display === 'none') {
                // Render repos only when expanding
                const repos = window.analysisRepos || [];
                box.innerHTML = `
                    <div style="margin-bottom:0.5rem; padding:0.5rem; background:rgba(0,0,0,0.3); border-radius:6px; max-height:100px; overflow-y:auto;">
                        <div style="font-size:0.65rem; color:#a1a1aa; display:flex; flex-wrap:wrap; gap:0.2rem;">
                            ${repos.map(r => `<span style="background:rgba(255,255,255,0.08); padding:0.1rem 0.25rem; border-radius:2px;">${r.split('/').pop()}</span>`).join('')}
                        </div>
                    </div>
                `;
                box.style.display = 'block';
                btn.textContent = 'Hide ‚ñ≤';
            } else {
                box.style.display = 'none';
                box.innerHTML = ''; // Clear content when hidden
                btn.textContent = 'Show ‚ñº';
            }
        }

        // Display results
        function displayResults(data) {
            // Initialize chart filters with all contributors
            selectedContributorsForChart = new Set(data.contributors.map(c => c.login));

            // Analysis Info - with collapsible repo list
            const repos = data.analyzedRepositories || [];
            const repoCount = repos.length;

            // Store repos for later use when expanding
            window.analysisRepos = repos;

            document.getElementById('analysisInfo').innerHTML = `
                <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                    <strong>üìÅ Repositories:</strong>
                    <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                    <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                        style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                </div>
                <div id="repoDetailsBox" style="display:none;"></div>
                <div>
                    <strong>üìÖ</strong> ${data.dateRange.startDate} to ${data.dateRange.endDate} &nbsp;
                    <strong>üìä</strong> ${data.period}
                </div>
            `;

            // Summary Cards - focused on key metrics
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <h3>${data.summary.totalContributors}</h3>
                    <p>Contributors</p>
                </div>
                <div class="summary-card">
                    <h3>${data.summary.totalCommits}</h3>
                    <p>Total Commits</p>
                    <div class="subtitle">Top: ${data.summary.mostActiveCommitter || 'N/A'}</div>
                </div>
                <div class="summary-card" style="background: rgba(139, 92, 246, 0.1);">
                    <h3 style="color: #8b5cf6;">${data.summary.totalPRsMerged || 0}</h3>
                    <p>PRs Merged</p>
                    <div class="subtitle">Impact metric</div>
                </div>
                <div class="summary-card" style="background: rgba(59, 130, 246, 0.1);">
                    <h3 style="color: #3b82f6;">${data.summary.totalPRsReviewed || 0}</h3>
                    <p>PRs Reviewed</p>
                    <div class="subtitle">Team player</div>
                </div>
                <div class="summary-card" style="background: rgba(16, 185, 129, 0.1);">
                    <h3 style="color: #10b981;">${data.summary.totalActiveDays || 0}</h3>
                    <p>Active Days</p>
                    <div class="subtitle">Consistency</div>
                </div>
            `;

            // Contributor filter
            renderContributorFilter(data.contributors);

            // Render all charts
            renderCharts(data);

            // Render table
            renderEngagementTable(data.contributors);
        }

        function renderContributorFilter(contributors) {
            console.log('üéØ renderContributorFilter() called', {
                hasContributors: !!contributors,
                count: contributors?.length || 0,
                selectedForChart: selectedContributorsForChart?.size || 0
            });

            const container = document.getElementById('contributorFilter');
            if (!container) {
                console.error('‚ùå contributorFilter container not found!');
                return;
            }

            if (!contributors || contributors.length === 0) {
                container.innerHTML = '<div style="color: #a1a1aa; padding: 0.5rem;">No contributors to display</div>';
                return;
            }

            container.innerHTML = contributors.map(c => {
                const avatarUrl = getAvatarUrl(c.login);
                return `
                    <div class="filter-chip ${selectedContributorsForChart.has(c.login) ? 'selected' : ''}"
                         onclick="toggleChartContributor('${c.login}')"
                         title="${getDisplayName(c.login)}">
                        ${avatarUrl ? `<img src="${avatarUrl}" alt="${getDisplayName(c.login)}">` : '<span style="font-size: 1em;">üë§</span>'}
                        <span>${getDisplayName(c.login)}</span>
                    </div>
                `;
            }).join('');

            console.log('‚úÖ renderContributorFilter() completed, rendered', contributors.length, 'chips');
        }

        function toggleChartContributor(login) {
            if (selectedContributorsForChart.has(login)) {
                selectedContributorsForChart.delete(login);
            } else {
                selectedContributorsForChart.add(login);
            }
            renderContributorFilter(analysisData.contributors);
            renderCharts(analysisData);
        }

        function renderCharts(data) {
            console.log('üìà renderCharts() called', {
                hasData: !!data,
                hasContributors: !!data?.contributors,
                contributorCount: data?.contributors?.length || 0
            });

            try {
                const filteredContributors = data.contributors.filter(c =>
                    selectedContributorsForChart.has(c.login)
                );
                const colors = generateColors(filteredContributors.length);
                const periods = data.periods;

                // Commits Line Chart
                if (commitsLineChart) commitsLineChart.destroy();
                commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.commitsOverTime.map(d => d.value),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('Commits')
                });

                // Commits Bar Chart
                if (commitsBarChart) commitsBarChart.destroy();
                commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'Total Commits',
                            data: filteredContributors.map(c => c.totalCommits),
                            backgroundColor: colors
                        }]
                    },
                    options: chartOptions('Commits')
                });

                // ===== PRs Merged (Impact) =====
                // PRs Merged Over Time Line Chart
                if (prsMergedLineChart) prsMergedLineChart.destroy();
                prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.prsMergedOverTime ? c.prsMergedOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('PRs Merged')
                });

                // PRs Merged Bar Chart
                if (prsMergedBarChart) prsMergedBarChart.destroy();
                prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'PRs Merged',
                            data: filteredContributors.map(c => c.prsMerged || 0),
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: chartOptions('PRs Merged')
                });

                // ===== PRs Reviewed (Team Player) =====
                // PRs Reviewed Over Time Line Chart
                if (prsReviewedLineChart) prsReviewedLineChart.destroy();
                prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.prsReviewedOverTime ? c.prsReviewedOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('PRs Reviewed')
                });

                // PRs Reviewed Bar Chart
                if (prsReviewedBarChart) prsReviewedBarChart.destroy();
                prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'PRs Reviewed',
                            data: filteredContributors.map(c => c.prsReviewed || 0),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: chartOptions('PRs Reviewed')
                });

                // ===== Active Days (Consistency) =====
                // Active Days Over Time Line Chart
                if (activeDaysLineChart) activeDaysLineChart.destroy();
                activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.activeDaysOverTime ? c.activeDaysOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('Active Days')
                });

                // Active Days Bar Chart
                if (activeDaysBarChart) activeDaysBarChart.destroy();
                activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'Active Days',
                            data: filteredContributors.map(c => c.activeDays || 0),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: chartOptions('Active Days')
                });

                console.log('‚úÖ renderCharts() completed successfully');
            } catch (err) {
                console.error('‚ùå Error in renderCharts():', err);
                console.error('Error stack:', err.stack);
                showModal('‚ùå', 'Chart Rendering Failed', `Failed to render charts: ${err.message}`);
            }
        }

        // Chart options for line and bar charts
        function chartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e4e4e7'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            };
        }

        // Pie/Doughnut chart options
        function pieChartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#e4e4e7',
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
        }

        // Generate colors
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4',
                '#0ea5e9', '#3b82f6'
            ];
            return colors.slice(0, count);
        }

        // Utilities
        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ==================== CONTRIBUTOR ACTIVITY POPUP (TABBED) ====================

        let _popupActiveTab = 'commits';

        function showContributorCommits(contribIndex) {
            const contributors = window._currentEngagementContributors;
            if (!contributors || !contributors[contribIndex]) return;

            const c = contributors[contribIndex];
            const displayName = getDisplayName(c.login);
            const avatarUrl = getAvatarUrl(c.login);

            // Header
            const avatarEl = document.getElementById('commitPopupAvatar');
            avatarEl.src = avatarUrl || '';
            avatarEl.style.display = avatarUrl ? 'block' : 'none';
            document.getElementById('commitPopupName').textContent = displayName;
            document.getElementById('commitPopupLogin').textContent = '@' + c.login;

            // Stats
            document.getElementById('commitPopupStats').innerHTML = `
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${c.totalCommits}</div>
                    <div class="commit-popup-stat-label">Total Commits</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value" style="color:#22c55e">+${(c.totalLinesAdded || 0).toLocaleString()}</div>
                    <div class="commit-popup-stat-label">Lines Added</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value" style="color:#ef4444">-${(c.totalLinesDeleted || 0).toLocaleString()}</div>
                    <div class="commit-popup-stat-label">Lines Deleted</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${c.prsMerged || 0}</div>
                    <div class="commit-popup-stat-label">PRs Merged</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${c.prsReviewed || 0}</div>
                    <div class="commit-popup-stat-label">PRs Reviewed</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${c.activeDays || 0}</div>
                    <div class="commit-popup-stat-label">Active Days</div>
                </div>
            `;

            // Store data globally for tab switching / filtering
            window._popupCommits = c.commits || [];
            window._popupPRDetails = c.prDetails || [];
            window._popupReviewDetails = c.reviewDetails || [];

            // Update tab badges
            document.getElementById('tabBadgeCommits').textContent = window._popupCommits.length;
            document.getElementById('tabBadgePRsMerged').textContent = window._popupPRDetails.length;
            document.getElementById('tabBadgePRsReviewed').textContent = window._popupReviewDetails.length;

            // Reset to commits tab
            _popupActiveTab = 'commits';
            document.querySelectorAll('.popup-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.popup-tab[data-tab="commits"]').classList.add('active');
            document.getElementById('commitSearchInput').value = '';
            document.getElementById('commitSearchInput').placeholder = 'Search commits by message or hash‚Ä¶';

            renderPopupTabContent();

            // Show modal
            document.getElementById('commitPopupModal').classList.add('show');
        }

        function switchPopupTab(tab) {
            _popupActiveTab = tab;
            document.querySelectorAll('.popup-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.popup-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('commitSearchInput').value = '';

            // Update placeholder
            const placeholders = {
                'commits': 'Search commits by message or hash‚Ä¶',
                'prs-merged': 'Search PRs by title, number, or repo‚Ä¶',
                'prs-reviewed': 'Search reviewed PRs by title, number, or repo‚Ä¶'
            };
            document.getElementById('commitSearchInput').placeholder = placeholders[tab] || 'Search‚Ä¶';

            renderPopupTabContent();
        }

        function renderPopupTabContent() {
            const q = (document.getElementById('commitSearchInput').value || '').toLowerCase();

            switch (_popupActiveTab) {
                case 'commits':
                    let commits = window._popupCommits || [];
                    if (q) commits = commits.filter(c =>
                        (c.message || '').toLowerCase().includes(q) ||
                        (c.hash || '').toLowerCase().includes(q) ||
                        (c.repositoryName || '').toLowerCase().includes(q)
                    );
                    renderCommitList(commits);
                    break;
                case 'prs-merged':
                    let prs = window._popupPRDetails || [];
                    if (q) prs = prs.filter(p =>
                        (p.title || '').toLowerCase().includes(q) ||
                        String(p.number).includes(q) ||
                        (p.repositoryName || '').toLowerCase().includes(q)
                    );
                    renderPRList(prs, 'merged');
                    break;
                case 'prs-reviewed':
                    let reviews = window._popupReviewDetails || [];
                    if (q) reviews = reviews.filter(p =>
                        (p.title || '').toLowerCase().includes(q) ||
                        String(p.number).includes(q) ||
                        (p.repositoryName || '').toLowerCase().includes(q)
                    );
                    renderPRList(reviews, 'reviewed');
                    break;
            }
        }

        function filterPopupTab() {
            renderPopupTabContent();
        }

        function renderCommitList(commits) {
            const body = document.getElementById('commitPopupBody');

            if (!commits || commits.length === 0) {
                body.innerHTML = '<p style="text-align:center;color:#71717a;padding:2rem;">No commit details available</p>';
                return;
            }

            const sorted = [...commits].sort((a, b) => new Date(b.date) - new Date(a.date));

            body.innerHTML = sorted.map(c => {
                const shortHash = c.hash.substring(0, 7);
                const commitUrl = buildCommitUrl(c.hash, c.repositoryName);
                const date = new Date(c.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const repoShort = c.repositoryName ? c.repositoryName.split('/').pop() : '';
                const msgEl = document.createElement('span');
                msgEl.textContent = c.message || '';
                const safeMsg = msgEl.innerHTML;

                return `
                    <div class="commit-item">
                        <div class="commit-hash"><a href="${commitUrl}" target="_blank" rel="noopener noreferrer">${shortHash}</a></div>
                        <div class="commit-info">
                            <div class="commit-message"><a href="${commitUrl}" target="_blank" rel="noopener noreferrer">${safeMsg}</a></div>
                            <div class="commit-meta">
                                <span class="commit-meta-item">üìÖ ${dateStr} ${timeStr}</span>
                                ${repoShort ? `<span class="commit-meta-item">üì¶ ${repoShort}</span>` : ''}
                                <span class="commit-meta-item" style="color:#22c55e">+${c.linesAdded || 0}</span>
                                <span class="commit-meta-item" style="color:#ef4444">-${c.linesDeleted || 0}</span>
                                <span class="commit-meta-item">üìÅ ${c.filesChanged || 0} files</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPRList(prs, type) {
            const body = document.getElementById('commitPopupBody');
            const emptyLabel = type === 'merged' ? 'No PRs merged data available' : 'No PRs reviewed data available';

            if (!prs || prs.length === 0) {
                body.innerHTML = `<p style="text-align:center;color:#71717a;padding:2rem;">${emptyLabel}</p>`;
                return;
            }

            const sorted = [...prs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            body.innerHTML = sorted.map(pr => {
                const date = new Date(pr.createdAt);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const repoShort = pr.repositoryName ? pr.repositoryName.split('/').pop() : '';
                const titleEl = document.createElement('span');
                titleEl.textContent = pr.title || '';
                const safeTitle = titleEl.innerHTML;

                // Determine state badge
                let stateClass = 'open';
                let stateLabel = 'Open';
                if (pr.mergedAt) {
                    stateClass = 'merged';
                    stateLabel = 'Merged';
                } else if (pr.state === 'closed') {
                    stateClass = 'closed';
                    stateLabel = 'Closed';
                }

                return `
                    <div class="pr-item">
                        <div class="pr-number"><a href="${pr.url}" target="_blank" rel="noopener noreferrer">#${pr.number}</a></div>
                        <div class="pr-info">
                            <div class="pr-title"><a href="${pr.url}" target="_blank" rel="noopener noreferrer">${safeTitle}</a></div>
                            <div class="pr-meta">
                                <span class="pr-state-badge ${stateClass}">${stateLabel}</span>
                                <span class="commit-meta-item">üìÖ ${dateStr}</span>
                                ${repoShort ? `<span class="commit-meta-item">üì¶ ${repoShort}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buildCommitUrl(hash, repoName) {
            if (repoName && repoName.includes('/')) {
                return 'https://github.com/' + repoName + '/commit/' + hash;
            }
            return '#';
        }


        function closeCommitPopup(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('commitPopupModal').classList.remove('show');
        }

        // Close popup on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeCommitPopup();
        });
    </script>
</body>
</html>

