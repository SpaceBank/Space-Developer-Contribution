<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Developer Engagement - Space Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #12122e 40%, #1a1a3e 70%, #0f0f2a 100%);
            padding: 0;
        }

        body.in-iframe .back-home-btn { display: none !important; }
        body.in-iframe { padding-top: 0; }
        body.in-iframe .container { padding-top: 1rem; }

        /* Shimmer Loading */
        .shimmer-card { height: 80px; margin-bottom: var(--space-lg); }
        .shimmer-chart { height: 300px; margin-bottom: var(--space-lg); }
        .shimmer-text { height: 20px; width: 60%; margin-bottom: var(--space-sm); }

        .section-loading { position: relative; min-height: 100px; }
        .section-loading::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(26, 26, 46, 0.8); border-radius: var(--radius-lg);
        }
        .loading-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; gap: var(--space-sm); z-index: 10;
        }
        .section-loaded { animation: fadeIn 0.3s ease-in; }
        .status-indicator {
            display: inline-flex; align-items: center; gap: var(--space-sm);
            padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 500;
        }
        .status-loading { background: var(--color-warning-bg); color: var(--color-warning-light); }
        .status-complete { background: var(--color-success-bg); color: var(--color-success); }

        .chart-shimmer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;
            border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;
        }
        .chart-shimmer::after { content: '‚è≥ Loading...'; color: var(--color-text-secondary); font-size: 0.875rem; }
        .chart-container { position: relative; }
        .chart-shimmer.hidden { display: none; }

        /* Loading Panel */
        .loading-panel {
            background: rgba(99, 102, 241, 0.08); border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg); padding: var(--space-xl); margin-top: var(--space-lg);
        }
        .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
        .loading-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: var(--color-text); }
        .loading-progress-bar { height: 8px; background: rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; margin-bottom: var(--space-lg); }
        .loading-progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); border-radius: 4px; transition: width 0.3s; }
        .loading-status { font-size: 0.875rem; color: var(--color-text-secondary); }
        .pulse-dot { width: 10px; height: 10px; background: var(--color-success); border-radius: 50%; animation: pulse 1.5s infinite; }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="page-bg"><div class="grid-lines"></div></div>

    <div class="page-content">
    <!-- Custom Modal/Popup -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Alert</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="/" class="back-home-btn">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>

    <div class="container">
        <div class="page-title">
            <h1>üë• Developer Engagement</h1>
            <p class="subtitle">Monitor activity including commits, PR reviews, and code changes over time</p>
        </div>

        <!-- Step 2: Select Contributors & Configure -->
        <div class="panel" id="step2-panel">
            <!-- Organization Info -->
            <div id="orgInfo" class="org-info-bar"></div>

            <h3 style="margin-bottom: var(--space-sm);">üë§ Select Contributors</h3>
            <div class="search-box">
                <input type="text" id="contributorSearch" placeholder="Search contributors..." oninput="filterContributors()">
            </div>

            <div class="selection-controls">
                <button class="secondary" onclick="deselectAllContributors()">Deselect All</button>
                <span style="margin-left: auto; color: #a1a1aa;"><span id="contributorCount">0</span> selected</span>
            </div>

            <div class="contributors-container" id="contributorsList"></div>

            <!-- Repository Filter -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                <h3 style="margin-bottom: 0.75rem;">üìÅ Select Repositories (1-10 required)</h3>
                <p style="font-size: 0.8rem; color: #71717a; margin-bottom: 0.75rem;">
                    Select between 1 and 10 repositories to analyze.
                </p>

                <div id="repo-selection">
                    <div class="search-box">
                        <input type="text" id="repoSearch" placeholder="Search repositories..." oninput="filterRepos()">
                    </div>

                    <div class="selection-controls">
                        <button class="secondary" onclick="deselectAllRepos()">Deselect All</button>
                        <span style="margin-left: auto; color: #a1a1aa;"><span id="repoCount">0</span> selected</span>
                    </div>

                    <div class="repo-list" id="repoList"></div>
                </div>
            </div>

            <!-- Exclude Merge Commits Option -->
            <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                <input type="checkbox" id="excludeMergeCommits" checked
                       style="width: 18px; height: 18px; accent-color: #6366f1;">
                <label for="excludeMergeCommits" style="cursor: pointer;">
                    üîÄ Exclude merge commits (recommended)
                </label>
            </div>

            <!-- Date Range & Period -->
            <div class="form-row" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="period">Aggregation Period</label>
                    <select id="period">
                        <option value="DAILY">Daily</option>
                        <option value="WEEKLY" selected>Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>
            </div>

            <button onclick="analyzeEngagement()" id="analyzeBtn" disabled style="margin-top: 1rem;">
                <span>Analyze Engagement</span>
                <span>‚Üí</span>
            </button>

            <div id="analyze-error" class="error hidden"></div>
            <div id="analyze-loading" class="loading hidden">
                <div class="spinner"></div>
                <span id="loading-message">Initializing analysis...</span>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="panel hidden" id="step3-panel">
            <h2>üìä Engagement Analysis Results</h2>

            <div class="button-group" style="margin-bottom: var(--space-xl);">
                <button class="secondary" onclick="goToStep(2)">‚Üê Back to Selection</button>
            </div>

            <!-- Loading Status Panel -->
            <div id="loadingStatusPanel" class="hidden" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; display: flex; gap: 1.5rem; align-items: center;">
                <span style="font-size: 0.875rem; color: #a1a1aa;">Loading:</span>
                <div style="display: flex; gap: 1rem;">
                    <div>üìù Commits: <span id="status-commits"></span></div>
                    <div>üöÄ PRs & Reviews: <span id="status-prs"></span></div>
                </div>
            </div>

            <!-- Analysis Info -->
            <div id="analysisInfo" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px;"></div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards"></div>

            <!-- Contributor Filter for Charts -->
            <div class="panel">
                <h3 style="margin-bottom: 0.5rem;">üéØ Filter by Contributor</h3>
                <div class="contributor-filter" id="contributorFilter"></div>
            </div>

            <!-- Charts Section -->
            <h3 style="margin: 1.5rem 0 1rem;">üìà Commits</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of code commits made by each contributor.
                Commits represent individual units of work pushed to the repository. Higher commit counts indicate active code contribution.
                <em>Note: Merge commits are excluded by default for accurate measurement.</em>
            </p>
            <div class="charts-grid" id="commitsChartsSection">
                <div class="chart-panel">
                    <h3>üìä Total Commits by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total commit count between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsBarChartShimmer"></div>
                        <canvas id="commitsBarChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>üìâ Commits Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows commit activity distribution across the selected time period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="commitsLineChartShimmer"></div>
                        <canvas id="commitsLineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PR Merge Velocity -->
            <h3 style="margin: 1.5rem 0 1rem;">üöÄ PR Merge Velocity (Impact)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Requests created/merged by each contributor.
                This metric shows "Impact" - how many ideas and features were actually completed and shipped.
                High PR velocity indicates a developer who delivers finished work regularly.
            </p>
            <div class="charts-grid" id="prChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedLineChartShimmer"></div>
                        <canvas id="prsMergedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsMergedBarChartShimmer"></div>
                        <canvas id="prsMergedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Review Responsiveness -->
            <h3 style="margin: 1.5rem 0 1rem;">üë• Review Responsiveness (Team Player)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of Pull Request reviews performed by each contributor.
                This metric shows "Team Player" status - developers who actively help others by reviewing their code.
                High review counts indicate strong collaboration and mentorship within the team.
            </p>
            <div class="charts-grid" id="reviewChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedLineChartShimmer"></div>
                        <canvas id="prsReviewedLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="prsReviewedBarChartShimmer"></div>
                        <canvas id="prsReviewedBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Commit Consistency / Active Days -->
            <h3 style="margin: 1.5rem 0 1rem;">üìÖ Commit Consistency (Active Days)</h3>
            <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 1rem;">
                <strong>What it measures:</strong> The number of days a contributor had any activity (commits, PRs, reviews, etc.).
                This metric shows "Flow" - consistent daily engagement is better than sporadic bursts of activity.
                High active days indicate steady, sustainable work patterns.
            </p>
            <div class="charts-grid" id="activeDaysChartsSection">
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysLineChartShimmer"></div>
                        <canvas id="activeDaysLineChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                    <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                    <div class="chart-container">
                        <div class="chart-shimmer shimmer" id="activeDaysBarChartShimmer"></div>
                        <canvas id="activeDaysBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="panel" style="margin-top: 1.5rem;">
                <h3>üìã Contributor Engagement Summary</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Contributor</th>
                                <th>Commits</th>
                                <th style="color: #22c55e;">Lines Added</th>
                                <th style="color: #ef4444;">Lines Deleted</th>
                                <th>PRs Merged</th>
                                <th>PRs Reviewed</th>
                                <th>Active Days</th>
                            </tr>
                        </thead>
                        <tbody id="engagementTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let contributors = [];
        let selectedContributors = new Set();
        let analysisData = null;
        let selectedContributorsForChart = new Set();

        // Charts - Commits
        let commitsLineChart = null;
        let commitsBarChart = null;

        // Charts - PRs Merged (Impact)
        let prsMergedLineChart = null;
        let prsMergedBarChart = null;

        // Charts - PRs Reviewed (Team Player)
        let prsReviewedLineChart = null;
        let prsReviewedBarChart = null;

        // Charts - Active Days (Consistency)
        let activeDaysLineChart = null;
        let activeDaysBarChart = null;

        // Organizations found
        let organizations = [];

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present (nicknames have @)
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            // Debug logging
            if (displayName && displayName !== loginOrNickname) {
                console.debug(`‚úÖ getDisplayName('${loginOrNickname}') -> '${displayName}'`);
            }

            return result;
        }

        /**
         * Get avatar URL for a contributor login
         * Fetches from cached session data
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Custom Modal Functions
        function showModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeModal();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Detect if running in iframe
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }

            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Auto-load contributors from session
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    contributors = sessionData.contributors.map(c => ({
                        login: c.login,
                        name: c.name || null,  // Include name for display
                        avatarUrl: c.avatarUrl || c.avatar_url,
                        profileUrl: c.profileUrl || c.html_url,
                        contributions: 0
                    }));
                    organizations = sessionData.organizations || [];

                    // Create display name lookup map from session contributors
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                    console.log('üìã Sample displayNameMap:', Object.entries(window.displayNameMap).slice(0, 5));
                    console.log('üìã Contributors with names:', sessionData.contributors.filter(c => c.name && c.name !== c.login).length, '/', sessionData.contributors.length);

                    // Auto-load repositories
                    if (sessionData.repositories && sessionData.repositories.length > 0) {
                        repositories = sessionData.repositories.map(r => r.fullName);

                        // Render repository list
                        renderRepoList();
                    }

                    renderContributorsList();

                    // Show org info
                    document.getElementById('orgInfo').innerHTML = `
                        üè¢ <strong>${organizations.length}</strong> organizations ‚Ä¢
                        üë• <strong>${contributors.length}</strong> contributors ‚Ä¢
                        üì¶ <strong>${repositories.length}</strong> repositories loaded
                    `;
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Provider selection
        function selectProvider(provider) {
            selectedProvider = provider;
            document.querySelectorAll('.provider-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.provider === provider);
            });
            document.getElementById('custom-url-group').classList.toggle('hidden', provider !== 'GITLAB');
        }

        // Step navigation (step 2 and 3 only now - no login step)
        function goToStep(step) {
            // Map step 1 to step 2 since there's no login panel
            if (step === 1) step = 2;
            currentStep = step;
            document.getElementById('step2-panel').classList.toggle('hidden', step !== 2);
            document.getElementById('step3-panel').classList.toggle('hidden', step !== 3);
        }

        // Repository list rendering
        function renderRepoList(filter = '') {
            const container = document.getElementById('repoList');
            const filtered = repositories.filter(r =>
                r.toLowerCase().includes(filter.toLowerCase())
            );

            container.innerHTML = filtered.map(repo => {
                const repoName = repo.split('/').pop();
                return `
                    <div class="repo-item ${selectedRepos.has(repo) ? 'selected' : ''}"
                         onclick="toggleRepo('${repo}')">
                        <input type="checkbox" ${selectedRepos.has(repo) ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleRepo('${repo}')">
                        <div class="repo-info">
                            <div class="repo-name">${repoName}</div>
                            <div class="repo-fullname">${repo}</div>
                        </div>
                    </div>
                `;
            }).join('');

            updateRepoCount();
        }

        function filterRepos() {
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function toggleRepo(repo) {
            // Check if adding would exceed limit
            if (!selectedRepos.has(repo) && selectedRepos.size >= 10) {
                showModal('‚ö†Ô∏è', 'Maximum Limit Reached', 'You can select a maximum of 10 repositories.');
                return;
            }

            if (selectedRepos.has(repo)) {
                selectedRepos.delete(repo);
            } else {
                selectedRepos.add(repo);
            }
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function deselectAllRepos() {
            selectedRepos.clear();
            renderRepoList(document.getElementById('repoSearch').value);
        }

        function updateRepoCount() {
            const repoCountEl = document.getElementById('repoCount');
            if (repoCountEl) {
                repoCountEl.textContent = selectedRepos.size;
            }
        }


        // Render contributors list
        function renderContributorsList(filter = '') {
            const container = document.getElementById('contributorsList');

            // Filter by login, name, or display name
            const filtered = contributors.filter(c => {
                const displayName = getDisplayName(c.login);
                const searchText = filter.toLowerCase();

                return c.login.toLowerCase().includes(searchText) ||
                       (c.name && c.name.toLowerCase().includes(searchText)) ||
                       (displayName && displayName.toLowerCase().includes(searchText));
            });

            container.innerHTML = filtered.map(c => {
                const displayName = getDisplayName(c.login);
                const reposInfo = c.publicRepos ? `üìÅ ${c.publicRepos} repos` : '';
                const contributionsInfo = c.contributions ? `${c.contributions} contributions` : '';
                const infoText = [contributionsInfo, reposInfo].filter(x => x).join(' ‚Ä¢ ');

                return `
                    <div class="contributor-item ${selectedContributors.has(c.login) ? 'selected' : ''}"
                         onclick="toggleContributor('${c.login}')">
                        <input type="checkbox" ${selectedContributors.has(c.login) ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleContributor('${c.login}')">
                        <img class="contributor-avatar" src="${c.avatarUrl || ''}"
                             onerror="this.style.display='none'" alt="">
                        <div class="contributor-info">
                            <div class="contributor-login">${displayName}</div>
                            <div class="contributor-contributions">@${c.login}${infoText ? ' ‚Ä¢ ' + infoText : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            updateContributorCount();
        }

        function filterContributors() {
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function toggleContributor(login) {
            if (selectedContributors.has(login)) {
                selectedContributors.delete(login);
            } else {
                selectedContributors.add(login);
            }
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function deselectAllContributors() {
            selectedContributors.clear();
            renderContributorsList(document.getElementById('contributorSearch').value);
        }

        function updateContributorCount() {
            document.getElementById('contributorCount').textContent = selectedContributors.size;
            document.getElementById('analyzeBtn').disabled = selectedContributors.size === 0;
        }


        // Analyze engagement - PARALLEL loading for speed
        async function analyzeEngagement() {
            console.log('üöÄ analyzeEngagement() started');

            try {
                // Validate contributors
                console.log('üìä Validating contributors...', { count: selectedContributors.size });
                if (selectedContributors.size === 0) {
                    console.warn('‚ùå No contributors selected');
                    showModal('üë•', 'Contributors Required', 'Please select at least one contributor to analyze.');
                    return;
                }

                // Validate repositories (1-10 required)
                console.log('üìÅ Validating repositories...', { count: selectedRepos.size });
                if (selectedRepos.size === 0) {
                    console.warn('‚ùå No repositories selected');
                    showModal('üìÅ', 'Repositories Required', 'Please select at least 1 repository to analyze.');
                    return;
                }

                if (selectedRepos.size > 10) {
                    console.warn('‚ùå Too many repositories selected:', selectedRepos.size);
                    showModal('‚ö†Ô∏è', 'Too Many Repositories', 'You can select a maximum of 10 repositories. Please deselect some repositories.');
                    return;
                }

                console.log('‚úÖ Validation passed');
                hideError('analyze-error');

                // Reset all state before new analysis
                console.log('üîÑ Resetting state for new analysis...');
                analysisData = null;
                selectedContributorsForChart = new Set();
                window.pendingPRData = null; // Clear any pending PR data from previous run

                // Destroy all existing charts
                if (commitsLineChart) { commitsLineChart.destroy(); commitsLineChart = null; }
                if (commitsBarChart) { commitsBarChart.destroy(); commitsBarChart = null; }
                if (prsMergedLineChart) { prsMergedLineChart.destroy(); prsMergedLineChart = null; }
                if (prsMergedBarChart) { prsMergedBarChart.destroy(); prsMergedBarChart = null; }
                if (prsReviewedLineChart) { prsReviewedLineChart.destroy(); prsReviewedLineChart = null; }
                if (prsReviewedBarChart) { prsReviewedBarChart.destroy(); prsReviewedBarChart = null; }
                if (activeDaysLineChart) { activeDaysLineChart.destroy(); activeDaysLineChart = null; }
                if (activeDaysBarChart) { activeDaysBarChart.destroy(); activeDaysBarChart = null; }
                console.log('‚úÖ State reset complete');

                const sessionData = getSessionData();
                console.log('üì¶ Session data retrieved:', {
                    hasToken: !!sessionData?.token,
                    provider: sessionData?.provider,
                    hasBaseUrl: !!sessionData?.baseUrl
                });

                const token = sessionData?.token || '';
                const startDate = document.getElementById('startDate').value || null;
                const endDate = document.getElementById('endDate').value || null;
                const period = document.getElementById('period').value;
                const reposToAnalyze = Array.from(selectedRepos);

                const requestBody = {
                    token: token,
                    provider: selectedProvider,
                    baseUrl: sessionData?.baseUrl || null,
                    repositoryFullNames: reposToAnalyze,
                    contributorLogins: Array.from(selectedContributors),
                    startDate: startDate,
                    endDate: endDate,
                    period: period,
                    excludeMergeCommits: document.getElementById('excludeMergeCommits').checked
                };

                console.log('üìù Request body prepared:', {
                    provider: requestBody.provider,
                    repoCount: requestBody.repositoryFullNames.length,
                    contributorCount: requestBody.contributorLogins.length,
                    dateRange: `${startDate} to ${endDate}`,
                    period: period,
                    excludeMergeCommits: requestBody.excludeMergeCommits
                });

                // Go to results page immediately with shimmer loading
                console.log('üé¨ Navigating to results page...');
                goToStep(3);
                showShimmerLoading();

                // Start BOTH API calls in PARALLEL
                console.log('üîÑ Starting parallel API calls...');
                updateLoadingStatus('commits', 'loading');
                updateLoadingStatus('prs', 'loading');

                const commitsPromise = fetch('/api/engagement/analyze/commits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).then(r => {
                    console.log('üì° Commits API response received:', { status: r.status, ok: r.ok });
                    if (!r.ok) {
                        return r.text().then(text => {
                            console.error('‚ùå Commits API error response body:', text);
                            throw new Error(`Failed to fetch commits: ${r.status} ${r.statusText}`);
                        });
                    }
                    return r.json();
                }).then(data => {
                    console.log('‚úÖ Commits data parsed successfully:', {
                        hasContributors: !!data?.contributors,
                        contributorCount: data?.contributors?.length || 0,
                        hasAnalyzedRepos: !!data?.analyzedRepositories
                    });
                    return data;
                });

                const prsPromise = fetch('/api/engagement/analyze/prs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).then(async r => {
                    console.log('üì° PRs API response received:', {
                        status: r.status,
                        ok: r.ok,
                        statusText: r.statusText,
                        headers: {
                            contentType: r.headers.get('content-type'),
                            contentLength: r.headers.get('content-length')
                        }
                    });

                    // Get raw text first to see what we're dealing with
                    const rawText = await r.text();
                    console.log('üìÑ PRs raw response text (first 500 chars):', rawText.substring(0, 500));
                    console.log('üìÑ PRs raw response length:', rawText.length);

                    if (!r.ok) {
                        console.error('‚ùå PRs API error response body:', rawText);
                        throw new Error(`Failed to fetch PRs: ${r.status} ${r.statusText} - ${rawText.substring(0, 200)}`);
                    }

                    // Try to parse JSON
                    let data;
                    try {
                        data = JSON.parse(rawText);
                        console.log('‚úÖ PRs JSON parsed successfully');
                    } catch (parseError) {
                        console.error('‚ùå Failed to parse PRs JSON:', parseError);
                        console.error('‚ùå Raw text was:', rawText.substring(0, 1000));
                        throw new Error(`Failed to parse PR response as JSON: ${parseError.message}`);
                    }

                    console.log('üì¶ PRs parsed data:', data);
                    console.log('üì¶ PRs data type:', typeof data);
                    console.log('üì¶ PRs data keys:', data ? Object.keys(data) : 'null');
                    console.log('üì¶ PRs contributors check:', {
                        hasData: !!data,
                        hasContributors: data ? ('contributors' in data) : false,
                        contributorsType: data?.contributors ? typeof data.contributors : 'undefined',
                        isArray: Array.isArray(data?.contributors),
                        contributorCount: data?.contributors?.length || 0,
                        firstContributor: data?.contributors?.[0] || null
                    });

                    if (!data) {
                        console.error('‚ùå PRs data is null or undefined after parsing!');
                        throw new Error('PR response data is null');
                    }

                    if (!data.contributors) {
                        console.error('‚ùå PRs data.contributors is missing!');
                        console.error('‚ùå Full data object:', JSON.stringify(data, null, 2));
                        throw new Error('PR response missing contributors field');
                    }

                    console.log('‚úÖ PRs data validated successfully');
                    return data;
                });

                // Handle commits when ready (usually faster)
                commitsPromise.then(data => {
                    console.log('üéØ Processing commits data...');
                    try {
                        analysisData = data;
                        updateLoadingStatus('commits', 'complete');
                        displayCommitsResults(data);
                        console.log('‚úÖ Commits results displayed successfully');
                    } catch (err) {
                        console.error('‚ùå Error displaying commits results:', err);
                        throw err;
                    }
                }).catch(err => {
                    console.error('‚ùå Commits promise error:', err);
                    updateLoadingStatus('commits', 'error');
                    showModal('‚ùå', 'Commits Loading Failed', `Failed to load commits data: ${err.message}`);
                });

                // Handle PRs when ready (usually slower)
                prsPromise.then(prData => {
                    console.log('üéØ Processing PRs data...');
                    console.log('üì¶ Raw prData:', prData);
                    try {
                        // Validate prData before processing
                        if (!prData) {
                            console.error('‚ùå prData is null or undefined');
                            throw new Error('PR response data is null');
                        }

                        // Calculate totals for status display
                        if (prData.contributors && Array.isArray(prData.contributors)) {
                            const totalPRs = prData.contributors.reduce((sum, c) => sum + (c.prsMerged || 0), 0);
                            const totalReviews = prData.contributors.reduce((sum, c) => sum + (c.prsReviewed || 0), 0);
                            console.log('üìä PRs stats:', { totalPRs, totalReviews });
                            updateLoadingStatus('prs', 'complete', `${totalPRs} PRs, ${totalReviews} Reviews`);
                        } else {
                            console.warn('‚ö†Ô∏è PRs data structure unexpected:', prData);
                            console.warn('‚ö†Ô∏è prData.contributors:', prData.contributors);
                            updateLoadingStatus('prs', 'complete', 'No PR data');
                        }
                        mergePRDataIntoResults(prData);
                        displayPRResults();
                        console.log('‚úÖ PRs results displayed successfully');
                    } catch (err) {
                        console.error('‚ùå Error displaying PRs results:', err);
                        throw err;
                    }
                }).catch(err => {
                    console.error('‚ùå PRs promise error:', err);
                    updateLoadingStatus('prs', 'error');
                    console.log('üîÑ Handling PR error - restoring chart sections...');

                    // Restore PR chart sections with error message
                    restorePRChartSectionsWithError();

                    // Hide PR shimmers on error
                    hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);

                    // Update summary cards to show N/A instead of spinner
                    const prsMergedCard = document.getElementById('prsMergedCard');
                    const prsReviewedCard = document.getElementById('prsReviewedCard');
                    const activeDaysCard = document.getElementById('activeDaysCard');
                    if (prsMergedCard) {
                        const cardValue = prsMergedCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }
                    if (prsReviewedCard) {
                        const cardValue = prsReviewedCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }
                    if (activeDaysCard) {
                        const cardValue = activeDaysCard.querySelector('.card-value');
                        if (cardValue) cardValue.textContent = 'N/A';
                    }

                    // Update table to show N/A for PR columns
                    updateTableWithPRError();

                    showModal('‚ö†Ô∏è', 'PRs Loading Failed', `Failed to load PRs data: ${err.message}`);
                });

                // Wait for both to complete (for error handling)
                console.log('‚è≥ Waiting for both API calls to complete...');
                const results = await Promise.allSettled([commitsPromise, prsPromise]);
                console.log('‚úÖ Both API calls completed:', {
                    commits: results[0].status,
                    prs: results[1].status
                });

                if (results[0].status === 'rejected') {
                    console.error('‚ùå Commits failed:', results[0].reason);
                }
                if (results[1].status === 'rejected') {
                    console.error('‚ùå PRs failed:', results[1].reason);
                }

            } catch (error) {
                console.error('‚ùå FATAL ERROR in analyzeEngagement():', error);
                console.error('Error stack:', error.stack);
                showModal('‚ùå', 'Analysis Failed', `An unexpected error occurred: ${error.message}`);
                updateLoadingStatus('commits', 'error');
                updateLoadingStatus('prs', 'error');
            }
        }

        // Show shimmer loading placeholders
        function showShimmerLoading() {
            document.getElementById('analysisInfo').innerHTML = `
                <div class="shimmer shimmer-text" style="width: 200px; height: 24px;"></div>
            `;

            document.getElementById('summaryCards').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    ${[1,2,3,4,5].map(() => `<div class="shimmer shimmer-card"></div>`).join('')}
                </div>
            `;

            // Clear contributor filter
            const contributorFilter = document.getElementById('contributorFilter');
            if (contributorFilter) {
                contributorFilter.innerHTML = '<div class="shimmer" style="height: 32px; width: 100%;"></div>';
            }

            // Clear engagement table
            const engagementTableBody = document.getElementById('engagementTableBody');
            if (engagementTableBody) {
                engagementTableBody.innerHTML = `
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                    <tr><td colspan="7"><div class="shimmer" style="height: 40px; width: 100%;"></div></td></tr>
                `;
            }

            // Show loading status indicators
            document.getElementById('loadingStatusPanel').classList.remove('hidden');
            updateLoadingStatus('commits', 'pending');
            updateLoadingStatus('prs', 'pending');

            // Show shimmers on ALL chart containers
            showChartShimmers(['commitsLineChart', 'commitsBarChart']);
            showChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Show shimmer overlay on specific charts
        function showChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.remove('hidden');
                }
            });
        }

        // Hide shimmer overlay on specific charts
        function hideChartShimmers(chartIds) {
            chartIds.forEach(id => {
                const shimmer = document.getElementById(id + 'Shimmer');
                if (shimmer) {
                    shimmer.classList.add('hidden');
                }
            });
        }

        // Update loading status indicator
        function updateLoadingStatus(section, status, customText = null) {
            const el = document.getElementById(`status-${section}`);
            if (!el) return;

            if (status === 'pending') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(113,113,122,0.2); color: #71717a;">‚è≥ Pending</span>`;
            } else if (status === 'loading') {
                el.innerHTML = `<span class="status-indicator status-loading"><span class="mini-spinner"></span> Loading...</span>`;
            } else if (status === 'complete') {
                const text = customText || '‚úì Complete';
                el.innerHTML = `<span class="status-indicator status-complete">‚úì ${text}</span>`;
            } else if (status === 'error') {
                el.innerHTML = `<span class="status-indicator" style="background: rgba(239,68,68,0.2); color: #ef4444;">‚úó Failed</span>`;
            }
        }

        // Display commits results
        function displayCommitsResults(data) {
            console.log('üìä displayCommitsResults() called', {
                hasData: !!data,
                hasContributors: !!data?.contributors,
                contributorCount: data?.contributors?.length || 0,
                hasSummary: !!data?.summary,
                hasDateRange: !!data?.dateRange
            });

            try {
                selectedContributorsForChart = new Set(data.contributors.map(c => c.login));
                console.log('üë• Contributors for chart filter:', selectedContributorsForChart.size);

                const repos = data.analyzedRepositories || [];
                const repoCount = repos.length;

                // Store repos globally for toggleRepoDetails function
                window.analysisRepos = repos;

                document.getElementById('analysisInfo').innerHTML = `
                    <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                        <strong>üìÅ Repositories:</strong>
                        <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                        <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                            style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                    </div>
                    <div id="repoDetailsBox" style="display:none;"></div>
                    <p style="font-size:0.85rem; color:#a1a1aa;">
                        üìÖ ${data.dateRange.startDate} to ${data.dateRange.endDate}<br>
                        üìä Period: ${data.period}
                    </p>
                `;

                // Summary cards - commits only first
                const s = data.summary;
                document.getElementById('summaryCards').innerHTML = `
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-icon">üë•</div>
                            <div class="card-value">${s.totalContributors}</div>
                            <div class="card-label">Contributors</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">üìù</div>
                            <div class="card-value">${s.totalCommits.toLocaleString()}</div>
                            <div class="card-label">Total Commits</div>
                        </div>
                        <div class="summary-card" id="prsMergedCard">
                            <div class="card-icon">üöÄ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">PRs Merged</div>
                        </div>
                        <div class="summary-card" id="prsReviewedCard">
                            <div class="card-icon">üëÄ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">PRs Reviewed</div>
                        </div>
                        <div class="summary-card" id="activeDaysCard">
                            <div class="card-icon">üìÖ</div>
                            <div class="card-value"><span class="mini-spinner"></span></div>
                            <div class="card-label">Active Days</div>
                        </div>
                    </div>
                `;

                // Render contributor filter chips
                console.log('üîÑ About to render contributor filter:', {
                    contributorsArray: data.contributors,
                    contributorLogins: data.contributors?.map(c => c.login),
                    selectedContributorsForChart: Array.from(selectedContributorsForChart)
                });
                renderContributorFilter(data.contributors);

                // Render commits charts immediately
                renderCommitsCharts(data);
                renderEngagementTable(data.contributors, true); // partial = true, no PR data yet

                // Show shimmer for PR sections
                showPRSectionsShimmer();

                // Check if PR data arrived before commits (was stored as pending)
                if (window.pendingPRData) {
                    console.log('üì¶ Found pending PR data, merging now...');
                    mergePRDataIntoResults(window.pendingPRData);
                    displayPRResults();
                    window.pendingPRData = null;
                }
            } catch (err) {
                console.error('‚ùå Error in displayCommitsResults():', err);
                console.error('Error stack:', err.stack);
                throw err;
            }

            console.log('‚úÖ displayCommitsResults() completed successfully');
        }

        // Show shimmer for PR/review sections
        function showPRSectionsShimmer() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) prSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (reviewSection) reviewSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
            if (activeDaysSection) activeDaysSection.innerHTML = `<div class="shimmer shimmer-chart"></div>`;
        }

        // Merge PR data into existing results
        function mergePRDataIntoResults(prData) {
            console.log('üîÑ mergePRDataIntoResults() called', {
                hasPRData: !!prData,
                hasContributors: !!prData?.contributors,
                contributorCount: prData?.contributors?.length || 0,
                hasAnalysisData: !!analysisData,
                analysisDataContributors: analysisData?.contributors?.length || 0
            });

            try {
                if (!prData || !prData.contributors) {
                    console.warn('‚ö†Ô∏è No PR data to merge');
                    return;
                }

                // Check if analysisData is ready
                if (!analysisData || !analysisData.contributors) {
                    console.warn('‚ö†Ô∏è analysisData is not ready yet, storing PR data for later merge');
                    // Store PR data to merge later when analysisData is ready
                    window.pendingPRData = prData;
                    return;
                }

                console.log('üîÄ Merging PR data into analysis data...');
                // Update summary
                let totalPRs = 0, totalReviews = 0, totalActiveDays = 0;

                prData.contributors.forEach(prContrib => {
                    totalPRs += prContrib.prsMerged || 0;
                    totalReviews += prContrib.prsReviewed || 0;
                    totalActiveDays += prContrib.activeDays || 0;

                    // Merge into main data
                    const mainContrib = analysisData.contributors.find(c => c.login === prContrib.login);
                    if (mainContrib) {
                        mainContrib.prsMerged = prContrib.prsMerged;
                        mainContrib.prsReviewed = prContrib.prsReviewed;
                        mainContrib.activeDays = prContrib.activeDays;
                        mainContrib.prsMergedOverTime = prContrib.prsMergedOverTime;
                        mainContrib.prsReviewedOverTime = prContrib.prsReviewedOverTime;
                        mainContrib.activeDaysOverTime = prContrib.activeDaysOverTime;
                    } else {
                        console.warn(`‚ö†Ô∏è Could not find contributor ${prContrib.login} in analysisData to merge PR data`);
                    }
                });

                if (analysisData.summary) {
                    analysisData.summary.totalPRsMerged = totalPRs;
                    analysisData.summary.totalPRsReviewed = totalReviews;
                    analysisData.summary.totalActiveDays = totalActiveDays;
                }

                console.log('‚úÖ PR data merged successfully', { totalPRs, totalReviews, totalActiveDays });
            } catch (err) {
                console.error('‚ùå Error in mergePRDataIntoResults():', err);
                console.error('Error stack:', err.stack);
                // Don't throw - let the page continue working even if merge fails
            }
        }

        // Display PR results
        function displayPRResults() {
            console.log('üöÄ displayPRResults() called', {
                hasAnalysisData: !!analysisData,
                hasContributors: !!analysisData?.contributors,
                hasSummary: !!analysisData?.summary
            });

            try {
                if (!analysisData || !analysisData.contributors) {
                    console.warn('‚ö†Ô∏è No analysis data available for PR display, skipping');
                    return;
                }

                console.log('üìä Rendering PR charts...');
                // Restore PR chart sections (they were replaced by shimmer)
                restorePRChartSections();

                // Update summary cards safely
                const s = analysisData.summary || {};
                const prsMergedCard = document.getElementById('prsMergedCard');
                const prsReviewedCard = document.getElementById('prsReviewedCard');
                const activeDaysCard = document.getElementById('activeDaysCard');

                if (prsMergedCard) {
                    const cardValue = prsMergedCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalPRsMerged || 0).toLocaleString();
                }
                if (prsReviewedCard) {
                    const cardValue = prsReviewedCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalPRsReviewed || 0).toLocaleString();
                }
                if (activeDaysCard) {
                    const cardValue = activeDaysCard.querySelector('.card-value');
                    if (cardValue) cardValue.textContent = (s.totalActiveDays || 0).toLocaleString();
                }

                // Render PR charts
                renderPRCharts(analysisData);
                renderEngagementTable(analysisData.contributors, false); // full data now

                console.log('‚úÖ displayPRResults() completed successfully');
            } catch (err) {
                console.error('‚ùå Error in displayPRResults():', err);
                console.error('Error stack:', err.stack);
                // Don't throw - let the page continue working
            }
        }

        // Restore PR chart sections that were replaced by shimmer
        function restorePRChartSections() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            if (prSection) {
                prSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìà PRs Merged Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows PR creation/merge activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedLineChartShimmer"></div>
                            <canvas id="prsMergedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #8b5cf6;">üìä Total PRs Merged by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total PRs created between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsMergedBarChartShimmer"></div>
                            <canvas id="prsMergedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (reviewSection) {
                reviewSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìà PRs Reviewed Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows code review activity over the selected period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedLineChartShimmer"></div>
                            <canvas id="prsReviewedLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #3b82f6;">üìä Total PRs Reviewed by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total reviews performed between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="prsReviewedBarChartShimmer"></div>
                            <canvas id="prsReviewedBarChart"></canvas>
                        </div>
                    </div>
                `;
            }

            if (activeDaysSection) {
                activeDaysSection.innerHTML = `
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìà Active Days Over Time</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Shows how many days had activity in each period</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysLineChartShimmer"></div>
                            <canvas id="activeDaysLineChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-panel">
                        <h3 style="color: #10b981;">üìä Total Active Days by Contributor</h3>
                        <p style="color: #71717a; font-size: 0.75rem; margin-bottom: 0.5rem;">Compares total active days between contributors</p>
                        <div class="chart-container">
                            <div class="chart-shimmer shimmer hidden" id="activeDaysBarChartShimmer"></div>
                            <canvas id="activeDaysBarChart"></canvas>
                        </div>
                    </div>
                `;
            }
        }

        // Restore PR chart sections with error state
        function restorePRChartSectionsWithError() {
            const prSection = document.getElementById('prChartsSection');
            const reviewSection = document.getElementById('reviewChartsSection');
            const activeDaysSection = document.getElementById('activeDaysChartsSection');

            const errorHtml = `
                <div class="chart-panel" style="display: flex; align-items: center; justify-content: center; min-height: 150px;">
                    <div style="text-align: center; color: #ef4444;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <div style="font-size: 0.9rem;">Failed to load PR data</div>
                        <div style="font-size: 0.75rem; color: #a1a1aa; margin-top: 0.25rem;">GitHub API rate limit may have been reached</div>
                    </div>
                </div>
            `;

            if (prSection) {
                prSection.innerHTML = errorHtml + errorHtml;
            }
            if (reviewSection) {
                reviewSection.innerHTML = errorHtml + errorHtml;
            }
            if (activeDaysSection) {
                activeDaysSection.innerHTML = errorHtml + errorHtml;
            }
        }

        // Update table to show N/A for PR columns when PR loading fails
        function updateTableWithPRError() {
            const tbody = document.getElementById('engagementTableBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                // Cells: Contributor, Commits, Lines Added, Lines Deleted, PRs Merged, PRs Reviewed, Active Days
                // Update cells 4, 5, 6 (0-indexed)
                if (cells.length >= 7) {
                    cells[4].textContent = 'N/A';
                    cells[5].textContent = 'N/A';
                    cells[6].textContent = 'N/A';
                }
            });
        }

        // Render only commits charts
        function renderCommitsCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // Commits Over Time Line Chart
            if (commitsLineChart) commitsLineChart.destroy();
            commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.commitsOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Commits Bar Chart
            if (commitsBarChart) commitsBarChart.destroy();
            commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Total Commits',
                        data: contributors.map(c => c.totalCommits),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide commit chart shimmers after rendering
            hideChartShimmers(['commitsLineChart', 'commitsBarChart']);
        }

        // Render PR and review charts
        function renderPRCharts(data) {
            const labels = data.periods || [];
            const contributors = data.contributors.filter(c => selectedContributorsForChart.has(c.login));
            const colors = generateColors(contributors.length);

            // PRs Merged Over Time
            if (prsMergedLineChart) prsMergedLineChart.destroy();
            prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsMergedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Merged Bar Chart
            if (prsMergedBarChart) prsMergedBarChart.destroy();
            prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Merged',
                        data: contributors.map(c => c.prsMerged || 0),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Over Time
            if (prsReviewedLineChart) prsReviewedLineChart.destroy();
            prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.prsReviewedOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // PRs Reviewed Bar Chart
            if (prsReviewedBarChart) prsReviewedBarChart.destroy();
            prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'PRs Reviewed',
                        data: contributors.map(c => c.prsReviewed || 0),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Over Time
            if (activeDaysLineChart) activeDaysLineChart.destroy();
            activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: contributors.map((c, i) => ({
                        label: getDisplayName(c.login),
                        data: c.activeDaysOverTime?.map(d => d.value) || [],
                        borderColor: colors[i],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { labels: { color: '#e4e4e7' } },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Active Days Bar Chart
            if (activeDaysBarChart) activeDaysBarChart.destroy();
            activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                type: 'bar',
                data: {
                    labels: contributors.map(c => getDisplayName(c.login)),
                    datasets: [{
                        label: 'Active Days',
                        data: contributors.map(c => c.activeDays || 0),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Hide PR/review/active days chart shimmers after rendering
            hideChartShimmers(['prsMergedLineChart', 'prsMergedBarChart', 'prsReviewedLineChart', 'prsReviewedBarChart', 'activeDaysLineChart', 'activeDaysBarChart']);
        }

        // Render engagement table
        function renderEngagementTable(contributors, partial = false) {
            const tbody = document.getElementById('engagementTableBody');
            tbody.innerHTML = contributors.map(c => {
                const avatarUrl = getAvatarUrl(c.login);
                return `
                    <tr>
                        <td class="contributor-cell">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${getDisplayName(c.login)}">` : '<span style="font-size: 1.2em;">üë§</span>'}
                            <span>${getDisplayName(c.login)}</span>
                        </td>
                        <td>${c.totalCommits.toLocaleString()}</td>
                        <td style="color: #22c55e;">+${(c.totalLinesAdded || 0).toLocaleString()}</td>
                        <td style="color: #ef4444;">-${(c.totalLinesDeleted || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsMerged || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.prsReviewed || 0).toLocaleString()}</td>
                        <td>${partial ? '<span class="mini-spinner"></span>' : (c.activeDays || 0).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle repo list view in results
        function toggleRepoDetails() {
            const box = document.getElementById('repoDetailsBox');
            const btn = document.getElementById('repoToggleBtn');

            if (box.style.display === 'none') {
                // Render repos only when expanding
                const repos = window.analysisRepos || [];
                box.innerHTML = `
                    <div style="margin-bottom:0.5rem; padding:0.5rem; background:rgba(0,0,0,0.3); border-radius:6px; max-height:100px; overflow-y:auto;">
                        <div style="font-size:0.65rem; color:#a1a1aa; display:flex; flex-wrap:wrap; gap:0.2rem;">
                            ${repos.map(r => `<span style="background:rgba(255,255,255,0.08); padding:0.1rem 0.25rem; border-radius:2px;">${r.split('/').pop()}</span>`).join('')}
                        </div>
                    </div>
                `;
                box.style.display = 'block';
                btn.textContent = 'Hide ‚ñ≤';
            } else {
                box.style.display = 'none';
                box.innerHTML = ''; // Clear content when hidden
                btn.textContent = 'Show ‚ñº';
            }
        }

        // Display results
        function displayResults(data) {
            // Initialize chart filters with all contributors
            selectedContributorsForChart = new Set(data.contributors.map(c => c.login));

            // Analysis Info - with collapsible repo list
            const repos = data.analyzedRepositories || [];
            const repoCount = repos.length;

            // Store repos for later use when expanding
            window.analysisRepos = repos;

            document.getElementById('analysisInfo').innerHTML = `
                <div style="margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                    <strong>üìÅ Repositories:</strong>
                    <span style="background:rgba(99,102,241,0.2); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.8rem;">${repoCount}</span>
                    <button class="secondary" onclick="toggleRepoDetails()" id="repoToggleBtn"
                        style="font-size:0.65rem; padding:0.15rem 0.4rem;">Show ‚ñº</button>
                </div>
                <div id="repoDetailsBox" style="display:none;"></div>
                <div>
                    <strong>üìÖ</strong> ${data.dateRange.startDate} to ${data.dateRange.endDate} &nbsp;
                    <strong>üìä</strong> ${data.period}
                </div>
            `;

            // Summary Cards - focused on key metrics
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <h3>${data.summary.totalContributors}</h3>
                    <p>Contributors</p>
                </div>
                <div class="summary-card">
                    <h3>${data.summary.totalCommits}</h3>
                    <p>Total Commits</p>
                    <div class="subtitle">Top: ${data.summary.mostActiveCommitter || 'N/A'}</div>
                </div>
                <div class="summary-card" style="background: rgba(139, 92, 246, 0.1);">
                    <h3 style="color: #8b5cf6;">${data.summary.totalPRsMerged || 0}</h3>
                    <p>PRs Merged</p>
                    <div class="subtitle">Impact metric</div>
                </div>
                <div class="summary-card" style="background: rgba(59, 130, 246, 0.1);">
                    <h3 style="color: #3b82f6;">${data.summary.totalPRsReviewed || 0}</h3>
                    <p>PRs Reviewed</p>
                    <div class="subtitle">Team player</div>
                </div>
                <div class="summary-card" style="background: rgba(16, 185, 129, 0.1);">
                    <h3 style="color: #10b981;">${data.summary.totalActiveDays || 0}</h3>
                    <p>Active Days</p>
                    <div class="subtitle">Consistency</div>
                </div>
            `;

            // Contributor filter
            renderContributorFilter(data.contributors);

            // Render all charts
            renderCharts(data);

            // Render table
            renderEngagementTable(data.contributors);
        }

        function renderContributorFilter(contributors) {
            console.log('üéØ renderContributorFilter() called', {
                hasContributors: !!contributors,
                count: contributors?.length || 0,
                selectedForChart: selectedContributorsForChart?.size || 0
            });

            const container = document.getElementById('contributorFilter');
            if (!container) {
                console.error('‚ùå contributorFilter container not found!');
                return;
            }

            if (!contributors || contributors.length === 0) {
                container.innerHTML = '<div style="color: #a1a1aa; padding: 0.5rem;">No contributors to display</div>';
                return;
            }

            container.innerHTML = contributors.map(c => {
                const avatarUrl = getAvatarUrl(c.login);
                return `
                    <div class="filter-chip ${selectedContributorsForChart.has(c.login) ? 'selected' : ''}"
                         onclick="toggleChartContributor('${c.login}')"
                         title="${getDisplayName(c.login)}">
                        ${avatarUrl ? `<img src="${avatarUrl}" alt="${getDisplayName(c.login)}">` : '<span style="font-size: 1em;">üë§</span>'}
                        <span>${getDisplayName(c.login)}</span>
                    </div>
                `;
            }).join('');

            console.log('‚úÖ renderContributorFilter() completed, rendered', contributors.length, 'chips');
        }

        function toggleChartContributor(login) {
            if (selectedContributorsForChart.has(login)) {
                selectedContributorsForChart.delete(login);
            } else {
                selectedContributorsForChart.add(login);
            }
            renderContributorFilter(analysisData.contributors);
            renderCharts(analysisData);
        }

        function renderCharts(data) {
            console.log('üìà renderCharts() called', {
                hasData: !!data,
                hasContributors: !!data?.contributors,
                contributorCount: data?.contributors?.length || 0
            });

            try {
                const filteredContributors = data.contributors.filter(c =>
                    selectedContributorsForChart.has(c.login)
                );
                const colors = generateColors(filteredContributors.length);
                const periods = data.periods;

                // Commits Line Chart
                if (commitsLineChart) commitsLineChart.destroy();
                commitsLineChart = new Chart(document.getElementById('commitsLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.commitsOverTime.map(d => d.value),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('Commits')
                });

                // Commits Bar Chart
                if (commitsBarChart) commitsBarChart.destroy();
                commitsBarChart = new Chart(document.getElementById('commitsBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'Total Commits',
                            data: filteredContributors.map(c => c.totalCommits),
                            backgroundColor: colors
                        }]
                    },
                    options: chartOptions('Commits')
                });

                // ===== PRs Merged (Impact) =====
                // PRs Merged Over Time Line Chart
                if (prsMergedLineChart) prsMergedLineChart.destroy();
                prsMergedLineChart = new Chart(document.getElementById('prsMergedLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.prsMergedOverTime ? c.prsMergedOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('PRs Merged')
                });

                // PRs Merged Bar Chart
                if (prsMergedBarChart) prsMergedBarChart.destroy();
                prsMergedBarChart = new Chart(document.getElementById('prsMergedBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'PRs Merged',
                            data: filteredContributors.map(c => c.prsMerged || 0),
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: chartOptions('PRs Merged')
                });

                // ===== PRs Reviewed (Team Player) =====
                // PRs Reviewed Over Time Line Chart
                if (prsReviewedLineChart) prsReviewedLineChart.destroy();
                prsReviewedLineChart = new Chart(document.getElementById('prsReviewedLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.prsReviewedOverTime ? c.prsReviewedOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('PRs Reviewed')
                });

                // PRs Reviewed Bar Chart
                if (prsReviewedBarChart) prsReviewedBarChart.destroy();
                prsReviewedBarChart = new Chart(document.getElementById('prsReviewedBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'PRs Reviewed',
                            data: filteredContributors.map(c => c.prsReviewed || 0),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: chartOptions('PRs Reviewed')
                });

                // ===== Active Days (Consistency) =====
                // Active Days Over Time Line Chart
                if (activeDaysLineChart) activeDaysLineChart.destroy();
                activeDaysLineChart = new Chart(document.getElementById('activeDaysLineChart'), {
                    type: 'line',
                    data: {
                        labels: periods,
                        datasets: filteredContributors.map((c, i) => ({
                            label: getDisplayName(c.login),
                            data: c.activeDaysOverTime ? c.activeDaysOverTime.map(d => d.value) : periods.map(() => 0),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            fill: false,
                            tension: 0.3
                        }))
                    },
                    options: chartOptions('Active Days')
                });

                // Active Days Bar Chart
                if (activeDaysBarChart) activeDaysBarChart.destroy();
                activeDaysBarChart = new Chart(document.getElementById('activeDaysBarChart'), {
                    type: 'bar',
                    data: {
                        labels: filteredContributors.map(c => getDisplayName(c.login)),
                        datasets: [{
                            label: 'Active Days',
                            data: filteredContributors.map(c => c.activeDays || 0),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: chartOptions('Active Days')
                });

                console.log('‚úÖ renderCharts() completed successfully');
            } catch (err) {
                console.error('‚ùå Error in renderCharts():', err);
                console.error('Error stack:', err.stack);
                showModal('‚ùå', 'Chart Rendering Failed', `Failed to render charts: ${err.message}`);
            }
        }

        // Chart options for line and bar charts
        function chartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e4e4e7'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#a1a1aa' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            };
        }

        // Pie/Doughnut chart options
        function pieChartOptions(label) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#e4e4e7',
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
        }

        // Generate colors
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4',
                '#0ea5e9', '#3b82f6'
            ];
            return colors.slice(0, count);
        }

        // Utilities
        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>
</html>

