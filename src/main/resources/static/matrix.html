<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Matrix - Space Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 2rem;
        }

        /* Hide back button when in iframe */
        body.in-iframe .back-home-btn {
            display: none !important;
        }

        body.in-iframe {
            padding-top: 1rem;
        }

        .back-button {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(251, 146, 60, 0.3);
            border-color: rgba(251, 146, 60, 0.5);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: #e4e4e7;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #a1a1aa;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6366f1;
        }

        button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            color: #a1a1aa;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Provider Selection */
        .provider-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .provider-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .provider-option:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .provider-option.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .provider-option .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Repository List */
        .repo-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .repo-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .repo-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .repo-item.selected {
            background: rgba(99, 102, 241, 0.2);
        }

        .repo-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }

        .repo-info {
            flex: 1;
        }

        .repo-name {
            font-weight: 500;
        }

        .repo-fullname {
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .selection-info {
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Branch list styles */
        .branch-list {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .branch-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .branch-item:last-child {
            border-bottom: none;
        }

        .branch-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .branch-item.selected {
            background: rgba(34, 197, 94, 0.15);
        }

        .branch-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #22c55e;
        }

        .branch-name {
            font-size: 0.875rem;
            color: #e4e4e7;
            font-family: 'Courier New', monospace;
        }

        .branch-filter-options label {
            font-size: 0.9rem;
        }

        .branch-filter-options input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: #6366f1;
        }

        /* Metrics Matrix */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.25rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-card.elite {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .metric-card.good {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .metric-card.fair {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .metric-card.needs-focus {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .metric-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #a1a1aa;
        }

        .metric-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .metric-badge.elite {
            background: #22c55e;
            color: #052e16;
        }

        .metric-badge.good {
            background: #3b82f6;
            color: #1e3a5f;
        }

        .metric-badge.fair {
            background: #f59e0b;
            color: #451a03;
        }

        .metric-badge.needs-focus {
            background: #ef4444;
            color: #450a0a;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-description {
            font-size: 0.75rem;
            color: #71717a;
            line-height: 1.4;
        }

        /* Developer Matrix Table */
        .matrix-table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .matrix-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #a1a1aa;
            position: sticky;
            top: 0;
        }

        .matrix-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .matrix-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .matrix-cell .value {
            font-weight: 500;
        }

        .matrix-cell .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .indicator.elite { background: #22c55e; }
        .indicator.good { background: #3b82f6; }
        .indicator.fair { background: #f59e0b; }
        .indicator.needs-focus { background: #ef4444; }

        /* Chart Container */
        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.elite { background: #22c55e; }
        .legend-color.good { background: #3b82f6; }
        .legend-color.fair { background: #f59e0b; }
        .legend-color.needs-focus { background: #ef4444; }

        /* Thresholds Table */
        .thresholds-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .thresholds-table th,
        .thresholds-table td {
            padding: 0.75rem 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .thresholds-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .thresholds-table td:first-child {
            text-align: left;
            min-width: 220px;
        }

        .thresholds-table .metric-hint {
            font-size: 0.7rem;
            color: #71717a;
            display: block;
            margin-top: 0.25rem;
        }

        .thresholds-table .elite-col {
            background: rgba(34, 197, 94, 0.15);
            color: #86efac;
        }

        .thresholds-table .good-col {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
        }

        .thresholds-table .fair-col {
            background: rgba(245, 158, 11, 0.15);
            color: #fcd34d;
        }

        .thresholds-table .focus-col {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
        }

        /* Info icon tooltip styles */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
            font-size: 0.7rem;
            cursor: help;
            margin-left: 0.5rem;
            position: relative;
            vertical-align: middle;
        }

        .info-icon:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .info-tooltip {
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            padding: 1rem;
            background: #1e1e2e;
            border: 1px solid rgba(99, 102, 241, 0.5);
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            text-align: left;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .info-tooltip .tooltip-title {
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-tooltip .tooltip-desc {
            color: #a1a1aa;
            margin-bottom: 0.75rem;
        }

        .info-tooltip .tooltip-formula {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #22c55e;
            font-size: 0.75rem;
        }

        .info-tooltip .tooltip-why {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #71717a;
            font-size: 0.75rem;
        }

        .thresholds-table th.elite-col { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .thresholds-table th.good-col { background: rgba(59, 130, 246, 0.3); color: #3b82f6; }
        .thresholds-table th.fair-col { background: rgba(245, 158, 11, 0.3); color: #f59e0b; }
        .thresholds-table th.focus-col { background: rgba(239, 68, 68, 0.3); color: #ef4444; }

        .search-box {
            margin-bottom: 1rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 1rem;
        }

        /* Custom Modal/Popup */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .custom-modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-icon { font-size: 3rem; text-align: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #e4e4e7; text-align: center; margin-bottom: 0.75rem; }
        .modal-message { font-size: 0.95rem; color: #a1a1aa; text-align: center; line-height: 1.5; margin-bottom: 1.5rem; }
        .modal-buttons { display: flex; gap: 0.75rem; justify-content: center; }
        .modal-button { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .modal-button.primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .modal-button.primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }

        /* Simple Back to Home Button */
        .back-home-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #e4e4e7;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-home-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .back-home-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .back-home-btn .icon {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading Panel */
        .loading-panel { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; }
        .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .loading-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: #e4e4e7; }
        .loading-progress-bar { height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: 1rem; }
        .loading-progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 4px; transition: width 0.3s; }
        .loading-status { font-size: 0.875rem; color: #a1a1aa; }
        .pulse-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animation: pulse 1.5s infinite; }

        /* PR List Section */
        .pr-list-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .pr-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .pr-list-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: #e4e4e7;
        }

        .pr-count-badge {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pr-search-box {
            margin-bottom: 1rem;
        }

        .pr-search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 0.9rem;
        }

        .pr-search-box input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .pr-list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .pr-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .pr-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .pr-list-container::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.4);
            border-radius: 3px;
        }

        .pr-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .pr-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .pr-number {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            height: 30px;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pr-info {
            flex: 1;
            min-width: 0;
        }

        .pr-title {
            font-weight: 500;
            color: #e4e4e7;
            margin-bottom: 0.35rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pr-title a {
            color: #a5b4fc;
            text-decoration: none;
            transition: color 0.2s;
        }

        .pr-title a:hover {
            color: #818cf8;
            text-decoration: underline;
        }

        .pr-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: #71717a;
        }

        .pr-meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .pr-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .pr-metric-tag {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.7rem;
            color: #a1a1aa;
        }

        .pr-metric-tag.elite { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .pr-metric-tag.good { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .pr-metric-tag.fair { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .pr-metric-tag.needs-focus { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Contributor PR Popup Modal */
        .pr-popup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .pr-popup-modal.show {
            display: flex;
        }

        .pr-popup-content {
            background: linear-gradient(135deg, #1e1e2e 0%, #16213e 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            max-width: 800px;
            width: 95%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .pr-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pr-popup-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pr-popup-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #6366f1;
        }

        .pr-popup-name {
            font-size: 1.15rem;
            font-weight: 600;
            color: #fff;
        }

        .pr-popup-login {
            font-size: 0.85rem;
            color: #6366f1;
        }

        .pr-popup-close {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #9ca3af;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pr-popup-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .pr-popup-stats {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .pr-popup-stat {
            text-align: center;
        }

        .pr-popup-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .pr-popup-stat-label {
            font-size: 0.75rem;
            color: #71717a;
        }

        .pr-popup-body {
            padding: 1rem 1.5rem;
            max-height: 55vh;
            overflow-y: auto;
        }

        .pr-popup-body::-webkit-scrollbar {
            width: 6px;
        }

        .pr-popup-body::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.4);
            border-radius: 3px;
        }

        /* Clickable developer row */
        .matrix-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .matrix-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.1) !important;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
    </style>
</head>
<body>
    <!-- Custom Modal/Popup -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Alert</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Contributor PR Popup Modal -->
    <div id="prPopupModal" class="pr-popup-modal" onclick="closePRPopup(event)">
        <div class="pr-popup-content" onclick="event.stopPropagation()">
            <div class="pr-popup-header">
                <div class="pr-popup-user-info">
                    <img id="prPopupAvatar" class="pr-popup-avatar" src="" alt="">
                    <div>
                        <div class="pr-popup-name" id="prPopupName">Developer Name</div>
                        <div class="pr-popup-login" id="prPopupLogin">@username</div>
                    </div>
                </div>
                <button class="pr-popup-close" onclick="closePRPopup()">√ó</button>
            </div>
            <div class="pr-popup-stats" id="prPopupStats">
                <!-- Stats will be populated here -->
            </div>
            <div class="pr-popup-body" id="prPopupBody">
                <!-- PR list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="/" class="back-home-btn">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>

    <div class="container">
        <h1>‚ö° Engineering Matrix</h1>

        <!-- Step 2: Repository Selection -->
        <div class="panel" id="step2-panel">
            <h2>üìÅ Select Repositories</h2>

            <div class="search-box">
                <input type="text" id="repoSearch" placeholder="Search repositories..." oninput="filterRepos()">
            </div>

            <div class="selection-info">
                <span id="selectionCount">0</span> repositories selected
                <button class="secondary" style="float: right; padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="selectAllRepos()">Select All</button>
            </div>

            <div class="repo-list" id="repoList"></div>

            <!-- Branch Selector -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #e4e4e7;">üåø Filter by Branches</h3>

                <div class="branch-filter-options" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="branchFilter" value="all" checked onchange="handleBranchFilterChange()">
                        <span style="color: #e4e4e7;">All Branches</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.5rem;">
                        <input type="radio" name="branchFilter" value="specific" onchange="handleBranchFilterChange()">
                        <span style="color: #e4e4e7;">Specific Branches</span>
                    </label>
                </div>

                <div id="branchInputContainer" class="hidden" style="margin-top: 1rem;">
                    <label for="branchInput" style="display: block; font-size: 0.875rem; color: #a1a1aa; margin-bottom: 0.5rem;">
                        Enter branch names (comma-separated):
                    </label>
                    <input
                        type="text"
                        id="branchInput"
                        placeholder="e.g., main, develop, feature/new-api, hotfix/bug-123"
                        style="width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: #e4e4e7; font-size: 0.9rem; font-family: 'Courier New', monospace;"
                    >
                    <p style="font-size: 0.75rem; color: #71717a; margin-top: 0.5rem;">
                        üí° Tip: Separate multiple branches with commas. Example: main, develop, staging
                    </p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>

            <div class="button-group" style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button onclick="analyzeMetrics()" id="analyzeBtn" disabled>
                    <span>Analyze Metrics</span>
                    <span>‚Üí</span>
                </button>
            </div>

            <div id="analyze-error" class="error hidden"></div>

            <!-- Loading Panel -->
            <div id="loadingPanel" class="hidden"></div>
        </div>

        <!-- Step 3: Results -->
        <div class="panel hidden" id="step3-panel">
            <h2>üìä Engineering Metrics Matrix</h2>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="secondary" onclick="goToStep(1)">‚Üê Back to Selection</button>
            </div>

            <!-- Analysis Info -->
            <div id="analysisInfo" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px;"></div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item"><span class="legend-color elite"></span> Elite</div>
                <div class="legend-item"><span class="legend-color good"></span> Good</div>
                <div class="legend-item"><span class="legend-color fair"></span> Fair</div>
                <div class="legend-item"><span class="legend-color needs-focus"></span> Needs Focus</div>
            </div>

            <!-- Team Metrics Grid -->
            <h3 style="margin: 1.5rem 0 1rem;">üè¢ Team Metrics</h3>
            <div class="metrics-grid" id="teamMetricsGrid"></div>

            <!-- Trend Chart -->
            <div class="panel">
                <h3>üìà Weekly Trend</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Developer Matrix -->
            <div class="panel">
                <h3>üë• Developer Metrics Matrix</h3>
                <p style="font-size: 0.85rem; color: #71717a; margin-bottom: 1rem;">üí° Click on a developer row to view their PR details</p>
                <div class="matrix-table-container">
                    <table class="matrix-table" id="developerMatrix">
                        <thead>
                            <tr>
                                <th>Developer</th>
                                <th>PRs</th>
                                <th>Coding Time</th>
                                <th>Pickup Time</th>
                                <th>Review Time</th>
                                <th>Cycle Time</th>
                                <th>Merge Freq</th>
                                <th>PR Size</th>
                            </tr>
                        </thead>
                        <tbody id="developerMatrixBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analyzed PRs List -->
            <div class="pr-list-panel" id="prListPanel" style="display: none;">
                <div class="pr-list-header">
                    <h3>üìã Analyzed Pull Requests <span class="pr-count-badge" id="prCountBadge">0</span></h3>
                </div>
                <div class="pr-search-box">
                    <input type="text" id="prSearchInput" placeholder="Search PRs by title, author, or number..." oninput="filterPRList()">
                </div>
                <div class="pr-list-container" id="prListContainer">
                    <!-- PR items will be populated here -->
                </div>
            </div>

            <!-- Thresholds Reference - Redesigned -->
            <div class="panel" style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üìã Metric Thresholds Reference</h3>
                <div style="overflow-x: auto;">
                    <table class="thresholds-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th class="elite-col">üèÜ Elite</th>
                                <th class="good-col">‚úÖ Good</th>
                                <th class="fair-col">‚ö†Ô∏è Fair</th>
                                <th class="focus-col">üî¥ Needs Focus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>‚å®Ô∏è Coding Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">‚å®Ô∏è Coding Time</div>
                                            <div class="tooltip-desc">The time it takes from the first commit until a pull request is published. Short Coding Time correlates to low WIP, small PR Size, and clear requirements.</div>
                                            <div class="tooltip-formula">Formula: PR Created At - First Commit Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long coding time may indicate unclear requirements, scope creep, or too much work-in-progress.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First commit ‚Üí PR opened</span>
                                </td>
                                <td class="elite-col">&lt; 54 mins</td>
                                <td class="good-col">54m - 4h</td>
                                <td class="fair-col">5 - 23h</td>
                                <td class="focus-col">&gt; 23h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üëÄ Pickup Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üëÄ Pickup Time</div>
                                            <div class="tooltip-desc">The time a pull request waits for someone to start reviewing it. Low Pickup Time represents strong teamwork and a healthy review process.</div>
                                            <div class="tooltip-formula">Formula: First Review Time - PR Created At</div>
                                            <div class="tooltip-why">üí° Why it matters: Long pickup time creates bottlenecks and delays feedback, increasing context switching costs.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PR opened ‚Üí first review</span>
                                </td>
                                <td class="elite-col">&lt; 1h</td>
                                <td class="good-col">1 - 4h</td>
                                <td class="fair-col">5 - 16h</td>
                                <td class="focus-col">&gt; 16h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>‚úÖ Approve Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">‚úÖ Approve Time</div>
                                            <div class="tooltip-desc">The time from first comment/review to the first approval. This metric, along with Merge Time, is a more granular segment of Review Time.</div>
                                            <div class="tooltip-formula">Formula: First Approval Time - First Review Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long approve time may indicate complex PRs, unclear code, or slow review iterations.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First comment ‚Üí approval</span>
                                </td>
                                <td class="elite-col">&lt; 10h</td>
                                <td class="good-col">10 - 22h</td>
                                <td class="fair-col">23 - 42h</td>
                                <td class="focus-col">&gt; 42h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üîÄ Merge Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üîÄ Merge Time</div>
                                            <div class="tooltip-desc">The time from the first approval to merge. This metric, along with Approve Time, is a more granular segment of Review Time.</div>
                                            <div class="tooltip-formula">Formula: Merged At - First Approval Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long merge time after approval may indicate CI/CD issues, merge conflicts, or process bottlenecks.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First approval ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 1h</td>
                                <td class="good-col">1 - 3h</td>
                                <td class="fair-col">4 - 16h</td>
                                <td class="focus-col">&gt; 16h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìù Review Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìù Review Time</div>
                                            <div class="tooltip-desc">The time it takes to complete a code review and get a pull request merged. Low Review Time represents strong teamwork and a healthy review process.</div>
                                            <div class="tooltip-formula">Formula: Merged At - PR Created At</div>
                                            <div class="tooltip-why">üí° Why it matters: Review Time = Pickup Time + Approve Time + Merge Time. It's the total time a PR is "in review".</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PR opened ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 3h</td>
                                <td class="good-col">3 - 14h</td>
                                <td class="fair-col">15 - 24h</td>
                                <td class="focus-col">&gt; 24h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üîÑ Cycle Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üîÑ Cycle Time</div>
                                            <div class="tooltip-desc">The time it takes for a single engineering task to go through the different phases of the delivery process from 'code' to 'production'.</div>
                                            <div class="tooltip-formula">Formula: Merged At - First Commit Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Cycle Time = Coding Time + Review Time. It's your end-to-end delivery speed for a single change.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First commit ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 25h</td>
                                <td class="good-col">25 - 72h</td>
                                <td class="fair-col">73 - 161h</td>
                                <td class="focus-col">&gt; 161h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìà Merge Frequency</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìà Merge Frequency</div>
                                            <div class="tooltip-desc">The total number of pull requests merged by a developer over a period of time (per week).</div>
                                            <div class="tooltip-formula">Formula: Total PRs Merged / Weeks / Developers</div>
                                            <div class="tooltip-why">üí° Why it matters: Higher merge frequency indicates consistent delivery and smaller batch sizes, reducing risk.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PRs per developer per week</span>
                                </td>
                                <td class="elite-col">&gt; 2.0</td>
                                <td class="good-col">1.2 - 2.0</td>
                                <td class="fair-col">0.66 - 1.2</td>
                                <td class="focus-col">&lt; 0.66</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìè PR Size</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìè PR Size</div>
                                            <div class="tooltip-desc">The number of code lines modified in a pull request. Smaller pull requests are easier to review, safer to merge and correlate to a lower Cycle Time.</div>
                                            <div class="tooltip-formula">Formula: Lines Added + Lines Deleted</div>
                                            <div class="tooltip-why">üí° Why it matters: Large PRs are harder to review thoroughly, leading to more bugs and longer review times.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">Lines of code changed</span>
                                </td>
                                <td class="elite-col">&lt; 100</td>
                                <td class="good-col">100 - 155</td>
                                <td class="fair-col">156 - 228</td>
                                <td class="focus-col">&gt; 228</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let branchFilterMode = 'all'; // 'all' or 'specific'
        let trendChart = null;

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login/nickname
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            return result;
        }

        /**
         * Get avatar URL for a contributor login/nickname
         * Uses session data to find avatar
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Custom Modal Functions
        function showModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeModal();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Detect if running in iframe
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }

            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Create display name lookup map from session contributors
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                }

                // Auto-load repositories from session
                if (sessionData.repositories && sessionData.repositories.length > 0) {
                    repositories = sessionData.repositories.map(r => ({
                        fullName: r.fullName,
                        name: r.name || r.fullName.split('/').pop(),
                        isPrivate: r.private || false
                    }));
                    renderRepositoryList();
                    currentStep = 1;
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Step navigation
        function goToStep(step) {
            currentStep = step;
            document.getElementById('step2-panel').classList.toggle('hidden', step !== 1 && step !== 2);
            document.getElementById('step3-panel').classList.toggle('hidden', step !== 3);
        }

        // Fetch repositories
        async function fetchRepositories() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                showError('auth-error', 'Please enter your access token');
                return;
            }

            hideError('auth-error');
            showLoading('auth-loading');

            try {
                const response = await fetch('/api/git/repositories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: document.getElementById('baseUrl').value || null
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch repositories');

                const data = await response.json();
                repositories = data.repositories;
                selectedRepos.clear();
                renderRepositoryList();
                hideLoading('auth-loading');
                goToStep(2);
            } catch (error) {
                hideLoading('auth-loading');
                showError('auth-error', error.message);
            }
        }

        // Render repository list
        function renderRepositoryList(filter = '') {
            const container = document.getElementById('repoList');
            const filtered = repositories.filter(repo =>
                repo.fullName.toLowerCase().includes(filter.toLowerCase())
            );

            container.innerHTML = filtered.map(repo => `
                <div class="repo-item ${selectedRepos.has(repo.fullName) ? 'selected' : ''}"
                     onclick="toggleRepo('${repo.fullName}')">
                    <input type="checkbox" ${selectedRepos.has(repo.fullName) ? 'checked' : ''}
                           onclick="event.stopPropagation(); toggleRepo('${repo.fullName}')">
                    <div class="repo-info">
                        <div class="repo-name">${repo.name}</div>
                        <div class="repo-fullname">${repo.fullName}</div>
                    </div>
                </div>
            `).join('');

            updateSelectionCount();
        }

        function filterRepos() {
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function toggleRepo(fullName) {
            if (selectedRepos.has(fullName)) {
                selectedRepos.delete(fullName);
            } else {
                // Check max 10 limit
                if (selectedRepos.size >= 10) {
                    showModal('‚ö†Ô∏è', 'Maximum Limit Reached', 'You can select a maximum of 10 repositories.');
                    return;
                }
                selectedRepos.add(fullName);
            }
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function selectAllRepos() {
            // Limit to 10 max
            const toAdd = repositories.slice(0, 10);
            toAdd.forEach(repo => selectedRepos.add(repo.fullName));

            if (repositories.length > 10) {
                showModal('‚ÑπÔ∏è', 'Selection Limited', 'Only the first 10 repositories were selected. Maximum limit is 10.');
            }
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function updateSelectionCount() {
            document.getElementById('selectionCount').textContent = selectedRepos.size;
            document.getElementById('analyzeBtn').disabled = selectedRepos.size === 0;
        }

        // ==================== BRANCH FUNCTIONS ====================

        function handleBranchFilterChange() {
            const selectedMode = document.querySelector('input[name="branchFilter"]:checked').value;
            branchFilterMode = selectedMode;
            const branchInputContainer = document.getElementById('branchInputContainer');

            if (selectedMode === 'specific') {
                branchInputContainer.classList.remove('hidden');
            } else {
                branchInputContainer.classList.add('hidden');
            }
        }

        function getBranchesFromInput() {
            const input = document.getElementById('branchInput');
            if (!input || !input.value.trim()) {
                return [];
            }

            // Split by comma, trim whitespace, and filter empty strings
            return input.value
                .split(',')
                .map(b => b.trim())
                .filter(b => b.length > 0);
        }

        // ==================== END BRANCH FUNCTIONS ====================

        // Show loading panel
        function showLoadingPanel(repos) {
            const panel = document.getElementById('loadingPanel');
            if (panel) {
                panel.classList.remove('hidden');
                panel.innerHTML = `
                    <div class="loading-panel">
                        <div class="loading-header">
                            <div class="loading-title">
                                <div class="pulse-dot"></div>
                                <span>Analyzing ${repos.length} Repositories</span>
                            </div>
                            <span style="font-size: 0.875rem; color: #a1a1aa;">Please wait...</span>
                        </div>
                        <div class="loading-progress-bar">
                            <div class="loading-progress-fill" id="matrixProgressFill" style="width: 0%"></div>
                        </div>
                        <div class="loading-status" id="matrixLoadingStatus">
                            Fetching PR data from GitHub API...
                        </div>
                    </div>
                `;
            }
        }

        function hideLoadingPanel() {
            const panel = document.getElementById('loadingPanel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        function updateLoadingProgress(percent, status) {
            const fill = document.getElementById('matrixProgressFill');
            const statusEl = document.getElementById('matrixLoadingStatus');
            if (fill) fill.style.width = percent + '%';
            if (statusEl) statusEl.textContent = status;
        }

        // Analyze metrics
        async function analyzeMetrics() {
            // Validate: minimum 1 repo
            if (selectedRepos.size === 0) {
                showModal('üìÅ', 'Repositories Required', 'Please select at least 1 repository to analyze.');
                return;
            }

            // Validate: maximum 10 repos
            if (selectedRepos.size > 10) {
                showModal('‚ö†Ô∏è', 'Too Many Repositories', 'You can select a maximum of 10 repositories. Please deselect some repositories.');
                return;
            }
            analyzeBtn.disabled  = true

            hideError('analyze-error');

            const repoList = Array.from(selectedRepos);
            showLoadingPanel(repoList);
            updateLoadingProgress(10, 'Connecting to GitHub API...');

            const sessionData = getSessionData();
            const token = sessionData?.token || '';
            const startDate = document.getElementById('startDate').value || null;
            const endDate = document.getElementById('endDate').value || null;

            try {
                updateLoadingProgress(20, 'Fetching PR data...');

                // Prepare branch filter from text input
                const branchFilter = branchFilterMode === 'specific'
                    ? getBranchesFromInput()
                    : null;

                // Only send branches if there are any
                const branchesToSend = (branchFilter && branchFilter.length > 0) ? branchFilter : null;

                const response = await fetch('/api/metrics/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: sessionData?.baseUrl || null,
                        repositoryFullNames: repoList,
                        startDate: startDate,
                        endDate: endDate,
                        branches: branchesToSend
                    })
                });

                updateLoadingProgress(60, 'Processing PR metrics...');

                if (!response.ok) throw new Error('Failed to analyze metrics');

                updateLoadingProgress(80, 'Calculating developer metrics...');
                const data = await response.json();

                updateLoadingProgress(100, 'Complete!');

                setTimeout(() => {
                    hideLoadingPanel();
                    displayResults(data);
                    analyzeBtn.disabled  = false
                    goToStep(3);
                }, 500);
            } catch (error) {
                analyzeBtn.disabled  = false
                hideLoadingPanel();
                showModal('‚ùå', 'Analysis Failed', error.message);
            }
        }

        // Store metrics data globally for popup access
        let currentMetricsData = null;
        let allPRsList = [];

        // Display results
        function displayResults(data) {
            // Store data globally
            currentMetricsData = data;

            // Collect all PRs from all developers
            allPRsList = [];
            data.developerMetrics.forEach(dev => {
                if (dev.prDetails && dev.prDetails.length > 0) {
                    dev.prDetails.forEach(pr => {
                        allPRsList.push({
                            ...pr,
                            developerName: dev.developerName,
                            nickname: dev.nickname
                        });
                    });
                }
            });

            // Analysis Info
            document.getElementById('analysisInfo').innerHTML = `
                <strong>üìÅ Repositories:</strong> ${data.analyzedRepositories.join(', ')}<br>
                <strong>üìÖ Date Range:</strong> ${data.dateRange.startDate} to ${data.dateRange.endDate}<br>
                <strong>üë• Developers:</strong> ${data.teamMetrics.totalDevelopers} |
                <strong>üîÄ Total PRs:</strong> ${data.teamMetrics.totalPRs}
            `;

            // Team Metrics Grid
            renderTeamMetrics(data.teamMetrics);

            // Trend Chart
            renderTrendChart(data.weeklyTrend);

            // Developer Matrix
            renderDeveloperMatrix(data.developerMetrics);

            // PR List
            renderPRList(allPRsList, data.analyzedRepositories);
        }

        function renderTeamMetrics(metrics) {
            const metricsConfig = [
                { key: 'codingTime', name: 'Coding Time', icon: '‚å®Ô∏è', desc: 'First commit to PR opened' },
                { key: 'pickupTime', name: 'Pickup Time', icon: 'üëÄ', desc: 'PR opened to first review' },
                { key: 'approveTime', name: 'Approve Time', icon: '‚úÖ', desc: 'First comment to approval' },
                { key: 'mergeTime', name: 'Merge Time', icon: 'üîÄ', desc: 'First approval to merge' },
                { key: 'reviewTime', name: 'Review Time', icon: 'üìù', desc: 'PR opened to merge' },
                { key: 'cycleTime', name: 'Cycle Time', icon: 'üîÑ', desc: 'First commit to merge' },
                { key: 'mergeFrequency', name: 'Merge Frequency', icon: 'üìà', desc: 'PRs per developer per week' },
                { key: 'prSize', name: 'PR Size', icon: 'üìè', desc: 'Average lines changed' }
            ];

            const grid = document.getElementById('teamMetricsGrid');
            grid.innerHTML = metricsConfig.map(config => {
                const metric = metrics[config.key];
                const ratingClass = metric.rating.toLowerCase().replace('_', '-');
                return `
                    <div class="metric-card ${ratingClass}">
                        <div class="metric-header">
                            <span class="metric-name">${config.icon} ${config.name}</span>
                            <span class="metric-badge ${ratingClass}">${metric.rating.replace('_', ' ')}</span>
                        </div>
                        <div class="metric-value">${metric.displayValue}</div>
                        <div class="metric-description">${config.desc}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTrendChart(weeklyTrend) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyTrend.map(w => w.week),
                    datasets: [
                        {
                            label: 'Cycle Time (hours)',
                            data: weeklyTrend.map(w => w.cycleTime),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'PRs Merged',
                            data: weeklyTrend.map(w => w.prCount),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e4e4e7' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Cycle Time (hrs)', color: '#a1a1aa' },
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'PRs Merged', color: '#a1a1aa' },
                            ticks: { color: '#a1a1aa' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function renderDeveloperMatrix(developers) {
            const tbody = document.getElementById('developerMatrixBody');

            tbody.innerHTML = developers.map((dev, index) => {
                const displayName = getDisplayName(dev.nickname);
                const avatarUrl = getAvatarUrl(dev.nickname);

                return `
                <tr onclick="showDeveloperPRs(${index})" title="Click to view ${displayName}'s PRs">
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${avatarUrl
                                ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #6366f1;">`
                                : '<span style="font-size: 1.5em;">üë§</span>'
                            }
                            <div>
                                <strong style="display: block;">${displayName}</strong>
                                <span style="color: #6366f1; font-size: 0.8rem;">@${dev.nickname}</span>
                            </div>
                        </div>
                    </td>
                    <td>${dev.totalPRs}</td>
                    <td>${renderMatrixCell(dev.codingTime)}</td>
                    <td>${renderMatrixCell(dev.pickupTime)}</td>
                    <td>${renderMatrixCell(dev.reviewTime)}</td>
                    <td>${renderMatrixCell(dev.cycleTime)}</td>
                    <td>${renderMatrixCell(dev.mergeFrequency)}</td>
                    <td>${renderMatrixCell(dev.prSize)}</td>
                </tr>
            `;
            }).join('');
        }

        function renderMatrixCell(metric) {
            const ratingClass = metric.rating.toLowerCase().replace('_', '-');
            return `
                <div class="matrix-cell">
                    <span class="indicator ${ratingClass}"></span>
                    <span class="value">${metric.displayValue}</span>
                </div>
            `;
        }

        // Utilities
        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ==================== PR LIST FUNCTIONS ====================

        // Render PR list section
        function renderPRList(prs, repositories) {
            const panel = document.getElementById('prListPanel');
            const container = document.getElementById('prListContainer');
            const countBadge = document.getElementById('prCountBadge');

            if (!prs || prs.length === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            countBadge.textContent = prs.length;

            // Build PR URL base from repositories
            const repoUrlMap = {};
            repositories.forEach(repo => {
                repoUrlMap[repo] = `https://github.com/${repo}/pull/`;
            });

            container.innerHTML = prs.map(pr => {
                const displayName = getDisplayName(pr.nickname || pr.author);
                const avatarUrl = getAvatarUrl(pr.nickname || pr.author);
                const prUrl = buildPRUrl(pr, repositories);

                // Build timeline info (first line) with icons and colors
                const timeline = [];
                if (pr.firstCommitTime) {
                    timeline.push(`<span style="color: #a78bfa;">üìù First Commit:</span> ${formatDateTime(pr.firstCommitTime)}`);
                }
                timeline.push(`<span style="color: #60a5fa;">‚Üí üöÄ PR Created:</span> ${formatDateTime(pr.createdAt)}`);
                if (pr.firstReviewTime) {
                    timeline.push(`<span style="color: #fbbf24;">‚Üí üëÄ First Review:</span> ${formatDateTime(pr.firstReviewTime)}`);
                }
                if (pr.firstApprovalTime) {
                    timeline.push(`<span style="color: #34d399;">‚Üí ‚úÖ First Approval:</span> ${formatDateTime(pr.firstApprovalTime)}`);
                }
                if (pr.mergedAt) {
                    timeline.push(`<span style="color: #22c55e;">‚Üí üîÄ Merged:</span> ${formatDateTime(pr.mergedAt)}`);
                }

                // Build code changes (second line)
                const codeChanges = [
                    `<span style="color: #86efac;">Lines Added:</span> <span style="color: #22c55e; font-weight: 600;">+${pr.additions || 0}</span>`,
                    `<span style="color: #fca5a5;">Lines Deleted:</span> <span style="color: #ef4444; font-weight: 600;">-${pr.deletions || 0}</span>`,
                    `<span style="color: #9ca3af;">Total Changes:</span> <span style="font-weight: 600;">${pr.prSize || 0} lines</span>`
                ];

                // All 6 metrics always shown
                const metricsHTML = [
                    { label: 'Coding Time', val: pr.codingTimeHours, type: 'codingTime' },
                    { label: 'Pickup Time', val: pr.pickupTimeHours, type: 'pickupTime' },
                    { label: 'Approve Time', val: pr.approveTimeHours, type: 'approveTime' },
                    { label: 'Merge Time', val: pr.mergeTimeHours, type: 'mergeTime' },
                    { label: 'Review Time', val: pr.reviewTimeHours, type: 'reviewTime' },
                    { label: 'Cycle Time', val: pr.cycleTimeHours, type: 'cycleTime' }
                ].map(m => {
                    const rating = getRatingClass(m.val, m.type);
                    const displayVal = formatHoursShort(m.val);
                    return `<span class="pr-metric-tag ${rating}">${m.label}: ${displayVal}</span>`;
                }).join('');

                return `
                    <div class="pr-item">
                        <div class="pr-number">#${pr.prNumber}</div>
                        <div class="pr-info">
                            <div class="pr-title">
                                <a href="${prUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(pr.prTitle)}</a>
                            </div>
                            <div class="pr-meta">
                                <span class="pr-meta-item">
                                    ${avatarUrl ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 16px; height: 16px; border-radius: 50%;">` : 'üë§'}
                                    ${displayName}
                                </span>
                            </div>
                            <div style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0; line-height: 1.5;">
                                <div>${timeline.join(' &nbsp;&nbsp;')}</div>
                                <div style="margin-top: 0.25rem;">${codeChanges.join(' &nbsp;&nbsp;')}</div>
                            </div>
                            <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.5rem 0;"></div>
                            <div class="pr-metrics">
                                ${metricsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter PR list
        function filterPRList() {
            const searchTerm = document.getElementById('prSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('#prListContainer .pr-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Build PR URL
        function buildPRUrl(pr, repositories) {
            // Try to find the repository from the PR data or use the first repo
            if (repositories && repositories.length > 0) {
                const repo = repositories[0]; // Default to first repo
                return `https://github.com/${repo}/pull/${pr.prNumber}`;
            }
            return '#';
        }

        // ==================== CONTRIBUTOR PR POPUP ====================

        // Show developer PRs popup
        function showDeveloperPRs(developerIndex) {
            if (!currentMetricsData || !currentMetricsData.developerMetrics) return;

            const dev = currentMetricsData.developerMetrics[developerIndex];
            if (!dev) return;

            const displayName = getDisplayName(dev.nickname);
            const avatarUrl = getAvatarUrl(dev.nickname);
            const prs = dev.prDetails || [];

            // Update header
            document.getElementById('prPopupAvatar').src = avatarUrl || '';
            document.getElementById('prPopupAvatar').style.display = avatarUrl ? 'block' : 'none';
            document.getElementById('prPopupName').textContent = displayName;
            document.getElementById('prPopupLogin').textContent = `@${dev.nickname}`;

            // Update stats
            document.getElementById('prPopupStats').innerHTML = `
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.totalPRs}</div>
                    <div class="pr-popup-stat-label">Total PRs</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.cycleTime.displayValue}</div>
                    <div class="pr-popup-stat-label">Avg Cycle Time</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.prSize.displayValue}</div>
                    <div class="pr-popup-stat-label">Avg PR Size</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.mergeFrequency.displayValue}</div>
                    <div class="pr-popup-stat-label">Merge Freq</div>
                </div>
            `;

            // Render PR list
            const body = document.getElementById('prPopupBody');
            if (prs.length === 0) {
                body.innerHTML = '<p style="text-align: center; color: #71717a; padding: 2rem;">No PR details available</p>';
            } else {
                const repositories = currentMetricsData.analyzedRepositories;
                body.innerHTML = prs.map(pr => {
                    const prUrl = buildPRUrl(pr, repositories);

                    // Build timeline info with icons and colors
                    const timeline = [];
                    if (pr.firstCommitTime) {
                        timeline.push(`<span style="color: #a78bfa;">üìù First Commit:</span> ${formatDateTime(pr.firstCommitTime)}`);
                    }
                    timeline.push(`<span style="color: #60a5fa;">‚Üí üöÄ PR Created:</span> ${formatDateTime(pr.createdAt)}`);
                    if (pr.firstReviewTime) {
                        timeline.push(`<span style="color: #fbbf24;">‚Üí üëÄ First Review:</span> ${formatDateTime(pr.firstReviewTime)}`);
                    }
                    if (pr.firstApprovalTime) {
                        timeline.push(`<span style="color: #34d399;">‚Üí ‚úÖ First Approval:</span> ${formatDateTime(pr.firstApprovalTime)}`);
                    }
                    if (pr.mergedAt) {
                        timeline.push(`<span style="color: #22c55e;">‚Üí üîÄ Merged:</span> ${formatDateTime(pr.mergedAt)}`);
                    }

                    // Build code changes
                    const codeChanges = [
                        `<span style="color: #86efac;">Lines Added:</span> <span style="color: #22c55e; font-weight: 600;">+${pr.additions || 0}</span>`,
                        `<span style="color: #fca5a5;">Lines Deleted:</span> <span style="color: #ef4444; font-weight: 600;">-${pr.deletions || 0}</span>`,
                        `<span style="color: #9ca3af;">Total Changes:</span> <span style="font-weight: 600;">${pr.prSize || 0} lines</span>`
                    ];

                    // All 6 metrics
                    const metricsHTML = [
                        { label: 'Coding Time', val: pr.codingTimeHours, type: 'codingTime' },
                        { label: 'Pickup Time', val: pr.pickupTimeHours, type: 'pickupTime' },
                        { label: 'Approve Time', val: pr.approveTimeHours, type: 'approveTime' },
                        { label: 'Merge Time', val: pr.mergeTimeHours, type: 'mergeTime' },
                        { label: 'Review Time', val: pr.reviewTimeHours, type: 'reviewTime' },
                        { label: 'Cycle Time', val: pr.cycleTimeHours, type: 'cycleTime' }
                    ].map(m => {
                        const rating = getRatingClass(m.val, m.type);
                        const displayVal = formatHoursShort(m.val);
                        return `<span class="pr-metric-tag ${rating}">${m.label}: ${displayVal}</span>`;
                    }).join('');

                    return `
                        <div class="pr-item">
                            <div class="pr-number">#${pr.prNumber}</div>
                            <div class="pr-info">
                                <div class="pr-title">
                                    <a href="${prUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(pr.prTitle)}</a>
                                </div>
                                <div style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0; line-height: 1.5;">
                                    <div>${timeline.join(' &nbsp;&nbsp;')}</div>
                                    <div style="margin-top: 0.25rem;">${codeChanges.join(' &nbsp;&nbsp;')}</div>
                                </div>
                                <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.5rem 0;"></div>
                                <div class="pr-metrics">
                                    ${metricsHTML}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Show popup
            document.getElementById('prPopupModal').classList.add('show');
        }

        // Close PR popup
        function closePRPopup(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prPopupModal').classList.remove('show');
        }

        // Close popup on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePRPopup();
            }
        });

        // ==================== HELPER FUNCTIONS ====================

        // Format hours to readable string
        function formatHours(hours) {
            if (hours == null) return 'N/A';
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${hours.toFixed(1)}h`;
            const days = Math.floor(hours / 24);
            const remainingHours = Math.round(hours % 24);
            return `${days}d ${remainingHours}h`;
        }

        // Format hours short - always returns a value (for consistent display)
        function formatHoursShort(hours) {
            if (hours == null || hours === undefined) return '‚Äî';
            if (hours === 0) return '0m';
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${hours.toFixed(1)}h`;
            const days = Math.floor(hours / 24);
            const remainingHours = Math.round(hours % 24);
            if (remainingHours === 0) return `${days}d`;
            return `${days}d ${remainingHours}h`;
        }

        // Format date (short)
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format date and time (full)
        function formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get rating class based on metric thresholds
        function getRatingClass(hours, metricType) {
            const thresholds = {
                codingTime: { elite: 0.9, good: 4, fair: 23 },
                pickupTime: { elite: 1, good: 4, fair: 16 },
                approveTime: { elite: 10, good: 22, fair: 42 },
                mergeTime: { elite: 1, good: 3, fair: 16 },
                reviewTime: { elite: 3, good: 14, fair: 24 },
                cycleTime: { elite: 25, good: 72, fair: 161 }
            };

            const t = thresholds[metricType];
            if (!t || hours == null) return '';

            if (hours <= t.elite) return 'elite';
            if (hours <= t.good) return 'good';
            if (hours <= t.fair) return 'fair';
            return 'needs-focus';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
