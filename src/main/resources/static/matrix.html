<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow(Git) Matrix - Space Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #12122e 40%, #1a1a3e 70%, #0f0f2a 100%);
            padding: 0;
        }

        body.in-iframe .back-home-btn { display: none !important; }
        body.in-iframe { padding-top: 0; }
        body.in-iframe .container { padding-top: 1rem; }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }

        .metric-card {
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            border: 2px solid var(--border-subtle);
            transition: all var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .metric-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .metric-card:hover::after { opacity: 1; }

        .metric-card.elite { border-color: var(--color-success); }
        .metric-card.elite::after { background: var(--color-success); }
        .metric-card.good { border-color: var(--color-info); }
        .metric-card.good::after { background: var(--color-info); }
        .metric-card.fair { border-color: var(--color-warning); }
        .metric-card.fair::after { background: var(--color-warning); }
        .metric-card.needs-focus { border-color: var(--color-danger); }
        .metric-card.needs-focus::after { background: var(--color-danger); }

        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .metric-name { font-size: 0.9rem; font-weight: 500; color: var(--color-text-secondary); }
        .metric-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .metric-badge.elite { background: var(--color-success); color: #052e16; }
        .metric-badge.good { background: var(--color-info); color: #1e3a5f; }
        .metric-badge.fair { background: var(--color-warning); color: #451a03; }
        .metric-badge.needs-focus { background: var(--color-danger); color: #450a0a; }

        .metric-value { font-size: 2rem; font-weight: 700; margin-bottom: var(--space-sm); }
        .metric-description { font-size: 0.75rem; color: var(--color-text-muted); line-height: 1.4; }

        /* Matrix Table */
        .matrix-table-container { overflow-x: auto; margin-top: var(--space-xl); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); }

        .matrix-cell { display: flex; align-items: center; gap: var(--space-sm); }
        .matrix-cell .value { font-weight: 500; }
        .matrix-cell .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .indicator.elite { background: var(--color-success); }
        .indicator.good { background: var(--color-info); }
        .indicator.fair { background: var(--color-warning); }
        .indicator.needs-focus { background: var(--color-danger); }

        .matrix-table tbody tr { cursor: pointer; transition: all var(--transition-fast); }
        .matrix-table tbody tr:hover { background: rgba(99, 102, 241, 0.1) !important; }

        /* Legend */
        .legend { display: flex; gap: var(--space-xl); justify-content: center; margin: var(--space-lg) 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: var(--space-sm); font-size: 0.85rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .legend-color.elite { background: var(--color-success); }
        .legend-color.good { background: var(--color-info); }
        .legend-color.fair { background: var(--color-warning); }
        .legend-color.needs-focus { background: var(--color-danger); }

        /* Thresholds Table */
        .thresholds-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .thresholds-table th, .thresholds-table td { padding: 0.75rem 1rem; text-align: center; border-bottom: 1px solid var(--border-subtle); }
        .thresholds-table th { background: var(--color-surface); font-weight: 600; font-size: 0.8rem; }
        .thresholds-table td:first-child { text-align: left; min-width: 220px; }
        .thresholds-table .metric-hint { font-size: 0.7rem; color: var(--color-text-muted); display: block; margin-top: 0.25rem; }
        .thresholds-table .elite-col { background: rgba(34, 197, 94, 0.15); color: #86efac; }
        .thresholds-table .good-col { background: rgba(59, 130, 246, 0.15); color: #93c5fd; }
        .thresholds-table .fair-col { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
        .thresholds-table .focus-col { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
        .thresholds-table th.elite-col { background: rgba(34, 197, 94, 0.3); color: var(--color-success); }
        .thresholds-table th.good-col { background: rgba(59, 130, 246, 0.3); color: var(--color-info); }
        .thresholds-table th.fair-col { background: rgba(245, 158, 11, 0.3); color: var(--color-warning); }
        .thresholds-table th.focus-col { background: rgba(239, 68, 68, 0.3); color: var(--color-danger); }

        /* Info Tooltip */
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--color-primary-glow); color: var(--color-primary-light);
            font-size: 0.7rem; cursor: help; margin-left: var(--space-sm);
            position: relative; vertical-align: middle;
        }
        .info-icon:hover { background: rgba(99, 102, 241, 0.5); }
        .info-tooltip {
            position: absolute; left: calc(100% + 10px); top: 50%; transform: translateY(-50%);
            width: 320px; padding: var(--space-lg);
            background: #1e1e2e; border: 1px solid var(--border-primary-strong);
            border-radius: var(--radius-md); box-shadow: var(--shadow-xl);
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity var(--transition-fast), visibility var(--transition-fast);
            text-align: left; font-size: 0.8rem; line-height: 1.5;
        }
        .info-icon:hover .info-tooltip { opacity: 1; visibility: visible; }
        .info-tooltip .tooltip-title { font-weight: 600; color: var(--color-text); margin-bottom: var(--space-sm); font-size: 0.9rem; }
        .info-tooltip .tooltip-desc { color: var(--color-text-secondary); margin-bottom: 0.75rem; }
        .info-tooltip .tooltip-formula {
            background: rgba(0,0,0,0.3); padding: var(--space-sm) 0.75rem;
            border-radius: 4px; font-family: var(--font-mono); color: var(--color-success); font-size: 0.75rem;
        }
        .info-tooltip .tooltip-why { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); color: var(--color-text-muted); font-size: 0.75rem; }

        /* Branch List */
        .branch-list { border: 1px solid var(--border-subtle); border-radius: var(--radius-md); background: rgba(255,255,255,0.02); }
        .branch-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background var(--transition-fast); }
        .branch-item:last-child { border-bottom: none; }
        .branch-item:hover { background: var(--color-surface-hover); }
        .branch-item.selected { background: var(--color-success-bg); }
        .branch-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--color-success); }
        .branch-name { font-size: 0.875rem; color: var(--color-text); font-family: var(--font-mono); }

        /* Loading Panel */
        .loading-panel { background: rgba(99, 102, 241, 0.08); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); padding: var(--space-xl); margin-top: var(--space-lg); }
        .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); }
        .loading-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: var(--color-text); }
        .loading-progress-bar { height: 8px; background: rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; margin-bottom: var(--space-lg); }
        .loading-progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); border-radius: 4px; transition: width 0.3s; }
        .loading-status { font-size: 0.875rem; color: var(--color-text-secondary); }
        .pulse-dot { width: 10px; height: 10px; background: var(--color-success); border-radius: 50%; animation: pulse 1.5s infinite; }

        /* PR List Section */
        .pr-list-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: var(--space-xl); margin-top: var(--space-xl); }
        .pr-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); }
        .pr-list-header h3 { display: flex; align-items: center; gap: var(--space-sm); font-size: 1.1rem; }
        .pr-count-badge { background: var(--color-primary-glow); color: var(--color-primary-light); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; }
        .pr-search-box { margin-bottom: var(--space-lg); }
        .pr-search-box input { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-subtle); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-size: 0.9rem; }
        .pr-search-box input:focus { outline: none; border-color: var(--color-primary); }
        .pr-list-container { max-height: 400px; overflow-y: auto; }
        .pr-item { display: flex; align-items: flex-start; gap: var(--space-lg); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 0.75rem; transition: all var(--transition-fast); }
        .pr-item:hover { background: var(--color-surface-hover); border-color: var(--border-primary); }
        .pr-number { display: flex; align-items: center; justify-content: center; min-width: 50px; height: 30px; background: var(--color-primary-glow); color: var(--color-primary-light); border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 600; }
        .pr-info { flex: 1; min-width: 0; }
        .pr-title { font-weight: 500; color: var(--color-text); margin-bottom: 0.35rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pr-title a { color: var(--color-primary-light); text-decoration: none; }
        .pr-title a:hover { text-decoration: underline; }
        .pr-meta { display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.8rem; color: var(--color-text-muted); }
        .pr-meta-item { display: flex; align-items: center; gap: 0.3rem; }
        .pr-metrics { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-sm); }
        .pr-metric-tag { display: flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.5rem; background: var(--color-surface); border-radius: 4px; font-size: 0.7rem; color: var(--color-text-secondary); }
        .pr-metric-tag.elite { background: var(--color-success-bg); color: var(--color-success); }
        .pr-metric-tag.good { background: rgba(59,130,246,0.15); color: var(--color-info); }
        .pr-metric-tag.fair { background: var(--color-warning-bg); color: var(--color-warning); }
        .pr-metric-tag.needs-focus { background: var(--color-danger-bg); color: var(--color-danger); }

        /* PR Popup Modal */
        .pr-popup-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); z-index: 10001; align-items: center; justify-content: center; }
        .pr-popup-modal.show { display: flex; }
        .pr-popup-content { background: linear-gradient(135deg, #1e1e2e 0%, #16213e 100%); border: 1px solid var(--border-medium); border-radius: var(--radius-xl); max-width: 800px; width: 95%; max-height: 85vh; overflow: hidden; box-shadow: var(--shadow-xl); animation: modalSlideIn 0.3s ease-out; }
        .pr-popup-header { display: flex; align-items: center; justify-content: space-between; padding: 1.25rem var(--space-xl); border-bottom: 1px solid var(--border-subtle); }
        .pr-popup-user-info { display: flex; align-items: center; gap: var(--space-lg); }
        .pr-popup-avatar { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--color-primary); }
        .pr-popup-name { font-size: 1.15rem; font-weight: 600; color: #fff; }
        .pr-popup-login { font-size: 0.85rem; color: var(--color-primary); }
        .pr-popup-close { width: 40px; height: 40px; border: none; background: var(--color-surface-hover); color: var(--color-text-secondary); border-radius: var(--radius-md); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .pr-popup-close:hover { background: var(--color-danger-bg); color: var(--color-danger); }
        .pr-popup-stats { display: flex; gap: var(--space-xl); padding: var(--space-lg) var(--space-xl); background: var(--color-surface); border-bottom: 1px solid var(--border-subtle); }
        .pr-popup-stat { text-align: center; }
        .pr-popup-stat-value { font-size: 1.5rem; font-weight: 700; color: #fff; }
        .pr-popup-stat-label { font-size: 0.75rem; color: var(--color-text-muted); }
        .pr-popup-body { padding: 1rem var(--space-xl); max-height: 55vh; overflow-y: auto; }

        /* Results container - hidden by default, shown after analysis */
        .results-container { display: none; margin-top: 2rem; }
        .results-container.visible { display: block; animation: fadeIn 0.4s ease-out; }

        /* Loading spinner between config and results */
        .analysis-loading { display: none; text-align: center; padding: 3rem 1rem; }
        .analysis-loading.visible { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .error-box { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); border-radius: 12px; padding: 1rem; margin-top: 1rem; color: #f87171; }
        .error-box.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Repo search dropdown */
        .repo-search-wrapper { position: relative; }
        .repo-dropdown { display:none; position:absolute; top:100%; left:0; right:0; max-height:280px; overflow-y:auto; background:#1e1e2e; border:1px solid rgba(255,255,255,.15); border-radius:12px; margin-top:4px; z-index:100; box-shadow:0 8px 32px rgba(0,0,0,.5); }
        .repo-dropdown.show { display:block; }
        .repo-dropdown-item { padding:.6rem 1rem; color:#e4e4e7; font-size:.875rem; cursor:pointer; transition:background .15s; display:flex; align-items:center; gap:.5rem; border-bottom:1px solid rgba(255,255,255,.05); }
        .repo-dropdown-item:last-child { border-bottom:none; }
        .repo-dropdown-item:hover,.repo-dropdown-item.selected { background:rgba(16,185,129,.15); color:#34d399; }
        .repo-dropdown-item .repo-icon { opacity:.5; font-size:.75rem; }
        .repo-dropdown-empty { padding:1rem; text-align:center; color:#71717a; font-size:.85rem; }

        /* Analysis info banner */
        .analysis-info { margin-bottom:1.5rem; padding:1rem; background:rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.15); border-radius:12px; font-size:.9rem; color:#d4d4d8; }

        /* Overall rating badge */
        .overall-badge { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1.25rem; border-radius:20px; font-size:.9rem; font-weight:700; }
        .rating-elite { background:rgba(34,197,94,.2); color:#4ade80; }
        .rating-good { background:rgba(59,130,246,.2); color:#60a5fa; }
        .rating-fair { background:rgba(249,115,22,.2); color:#fb923c; }
        .rating-needs-focus,.rating-needs_focus { background:rgba(239,68,68,.2); color:#f87171; }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="page-bg"><div class="grid-lines"></div></div>

    <div class="page-content">
    <!-- Custom Modal/Popup -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Alert</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Contributor PR Popup Modal -->
    <div id="prPopupModal" class="pr-popup-modal" onclick="closePRPopup(event)">
        <div class="pr-popup-content" onclick="event.stopPropagation()">
            <div class="pr-popup-header">
                <div class="pr-popup-user-info">
                    <img id="prPopupAvatar" class="pr-popup-avatar" src="" alt="">
                    <div>
                        <div class="pr-popup-name" id="prPopupName">Developer Name</div>
                        <div class="pr-popup-login" id="prPopupLogin">@username</div>
                    </div>
                </div>
                <button class="pr-popup-close" onclick="closePRPopup()">√ó</button>
            </div>
            <div class="pr-popup-stats" id="prPopupStats">
                <!-- Stats will be populated here -->
            </div>
            <div class="pr-popup-body" id="prPopupBody">
                <!-- PR list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="/" class="back-home-btn">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>

    <div class="container">
        <div class="page-title">
            <h1>üîÄ Flow(Git) Matrix</h1>
            <p class="subtitle">Track Cycle Time, PR Size, Review Time, and benchmark against engineering standards</p>
        </div>

        <!-- Repository Selection -->
        <div class="config-panel" id="configPanel">
            <div style="margin-bottom:1.25rem">
                <label style="display:block;color:#9ca3af;font-size:.82rem;font-weight:500;margin-bottom:.5rem">üìÅ Select Repository</label>
                <div class="repo-search-wrapper" id="repoSearchWrapper">
                    <input type="text" id="repoSearch" placeholder="Search repositories‚Ä¶" autocomplete="off"
                           style="width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;font-size:.9rem;font-family:inherit"
                           oninput="filterRepos()" onfocus="showRepoDropdown()">
                    <div class="repo-dropdown" id="repoDropdown"></div>
                </div>
                <input type="hidden" id="repoSelectValue" value="">
            </div>
            <div class="config-grid">
                <div class="config-field">
                    <label>üåø Branch</label>
                    <input type="text" id="branchInput" placeholder="all branches (leave empty)" value="">
                    <div class="field-hint">Leave empty for all branches, or enter comma-separated names</div>
                </div>
                <div class="config-field">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="config-field">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            <div class="config-actions">
                <button class="btn-action btn-analyze" onclick="analyzeMetrics()" id="analyzeBtn" disabled>
                    üîÄ Analyze Metrics
                </button>
            </div>
            <div id="analyze-error" class="error hidden"></div>
            <div id="loadingPanel" class="hidden"></div>
        </div>

        <!-- Loading -->
        <div class="analysis-loading" id="analysisLoading">
            <div class="spinner"></div>
            <span style="color:var(--color-accent-light);font-weight:500" id="loadingText">Analyzing metrics‚Ä¶</span>
        </div>
        <div id="errorMsg" class="error-box hidden"></div>

        <!-- Results (appears below config panel on same page) -->
        <div class="results-container" id="resultsContainer">
            <!-- Analysis Info Banner -->
            <div class="analysis-info" id="analysisInfo"></div>

            <!-- Overall Rating Badge -->
            <div style="text-align:center;margin-bottom:1.5rem"><span id="overallBadge" class="overall-badge"></span></div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item"><span class="legend-color elite"></span> Elite</div>
                <div class="legend-item"><span class="legend-color good"></span> Good</div>
                <div class="legend-item"><span class="legend-color fair"></span> Fair</div>
                <div class="legend-item"><span class="legend-color needs-focus"></span> Needs Focus</div>
            </div>

            <!-- Team Metrics Grid -->
            <h3 style="margin: 1.5rem 0 1rem;">üè¢ Team Metrics</h3>
            <div class="metrics-grid" id="teamMetricsGrid"></div>

            <!-- Trend Chart -->
            <div class="panel">
                <h3>üìà Weekly Trend</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Developer Matrix -->
            <div class="panel">
                <h3>üë• Developer Metrics Matrix</h3>
                <p style="font-size: 0.85rem; color: #71717a; margin-bottom: 1rem;">üí° Click on a developer row to view their PR details</p>
                <div class="matrix-table-container">
                    <table class="matrix-table" id="developerMatrix">
                        <thead>
                            <tr>
                                <th>Developer</th>
                                <th>PRs</th>
                                <th>Coding Time</th>
                                <th>Pickup Time</th>
                                <th>Review Time</th>
                                <th>Cycle Time</th>
                                <th>Merge Freq</th>
                                <th>PR Size</th>
                            </tr>
                        </thead>
                        <tbody id="developerMatrixBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PR Quality & Size Analytics -->
            <h3 style="margin: 2rem 0 1rem;">üìä PR Quality & Size Analytics</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <!-- Quality Check Rate -->
                <div class="panel" style="min-height: 420px; display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:.25rem;">‚úÖ PR Quality Check Rate</h3>
                    <p style="font-size: 0.78rem; color: #71717a; margin-bottom: 1rem;">CI/CD check results across all PRs ‚Äî click segments to drill down</p>
                    <div id="qualityRateSummaryCards" style="display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1rem;"></div>
                    <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative;">
                        <canvas id="qualityRateChart" style="max-height:240px;"></canvas>
                    </div>
                    <div id="qualityRateStats" style="text-align:center; margin-top: 0.75rem; font-size: 0.82rem; color: #a1a1aa;"></div>
                </div>

                <!-- PR Size Distribution (BAR chart) -->
                <div class="panel" style="min-height: 420px; display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:.25rem;">üìè PR Size Distribution</h3>
                    <p style="font-size: 0.78rem; color: #71717a; margin-bottom: 1rem;">Number of PRs in each size category ‚Äî click bars to drill down</p>
                    <div id="prSizeDistStats" style="font-size: 0.82rem; color: #a1a1aa; margin-bottom:.75rem;"></div>
                    <div style="flex:1; position:relative; min-height:220px;">
                        <canvas id="prSizeDistChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <!-- Daily PR & Quality Checks -->
                <div class="panel" style="min-height: 420px; display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:.25rem;">üìÖ Daily PR Activity & Quality</h3>
                    <p style="font-size: 0.78rem; color: #71717a; margin-bottom: 1rem;">PRs merged per day with pass/fail overlay ‚Äî click bars to drill down</p>
                    <div style="flex:1; position:relative; min-height:220px;">
                        <canvas id="dailyPRChart"></canvas>
                    </div>
                </div>

                <!-- Production Readiness -->
                <div class="panel" style="min-height: 420px; display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:.25rem;">üöÄ Production Readiness</h3>
                    <p style="font-size: 0.78rem; color: #71717a; margin-bottom: 1rem;">PRs that passed all checks when opened ‚Äî click to drill down</p>
                    <div id="prodReadySummaryCards" style="display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1rem;"></div>
                    <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative;">
                        <canvas id="productionReadyChart" style="max-height:240px;"></canvas>
                    </div>
                    <div id="productionReadyStats" style="text-align:center; margin-top: 0.75rem; font-size: 0.82rem; color: #a1a1aa;"></div>
                </div>
            </div>

            <!-- Chart Drill-Down Popup -->
            <div id="chartDrilldownModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(6px); z-index:10002; align-items:center; justify-content:center; padding:1rem;" onclick="closeChartDrilldown(event)">
                <div style="background:#1a1a2e; border:1px solid rgba(255,255,255,.12); border-radius:16px; width:100%; max-width:700px; max-height:80vh; display:flex; flex-direction:column; overflow:hidden;" onclick="event.stopPropagation()">
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.08);">
                        <div>
                            <div id="drilldownTitle" style="font-size:1.05rem; font-weight:600; color:#fff;"></div>
                            <div id="drilldownSubtitle" style="font-size:.78rem; color:#71717a; margin-top:.15rem;"></div>
                        </div>
                        <button onclick="closeChartDrilldown()" style="width:36px; height:36px; border:none; background:rgba(255,255,255,.05); color:#9ca3af; border-radius:8px; font-size:1.4rem; cursor:pointer; display:flex; align-items:center; justify-content:center;" onmouseover="this.style.background='rgba(239,68,68,.15)';this.style.color='#ef4444'" onmouseout="this.style.background='rgba(255,255,255,.05)';this.style.color='#9ca3af'">√ó</button>
                    </div>
                    <div style="padding:.5rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.06);">
                        <input type="text" id="drilldownSearchInput" placeholder="Search PRs by title, author, number‚Ä¶" oninput="filterDrilldownList()" style="width:100%; padding:.55rem 1rem; border:1px solid rgba(255,255,255,.1); border-radius:10px; background:rgba(255,255,255,.04); color:#fff; font-size:.85rem; font-family:inherit;">
                    </div>
                    <div id="drilldownBody" style="flex:1; overflow-y:auto; padding:.75rem 1.5rem 1.5rem; max-height:55vh;"></div>
                </div>
            </div>

            <!-- Analyzed PRs List -->
            <div class="pr-list-panel" id="prListPanel" style="display: none;">
                <div class="pr-list-header">
                    <h3>üìã Analyzed Pull Requests <span class="pr-count-badge" id="prCountBadge">0</span></h3>
                </div>
                <div class="pr-search-box">
                    <input type="text" id="prSearchInput" placeholder="Search PRs by title, author, or number..." oninput="filterPRList()">
                </div>
                <div class="pr-list-container" id="prListContainer">
                    <!-- PR items will be populated here -->
                </div>
            </div>

            <!-- Thresholds Reference - Redesigned -->
            <div class="panel" style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üìã Metric Thresholds Reference</h3>
                <div style="overflow-x: auto;">
                    <table class="thresholds-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th class="elite-col">üèÜ Elite</th>
                                <th class="good-col">‚úÖ Good</th>
                                <th class="fair-col">‚ö†Ô∏è Fair</th>
                                <th class="focus-col">üî¥ Needs Focus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>‚å®Ô∏è Coding Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">‚å®Ô∏è Coding Time</div>
                                            <div class="tooltip-desc">The time it takes from the first commit until a pull request is published. Short Coding Time correlates to low WIP, small PR Size, and clear requirements.</div>
                                            <div class="tooltip-formula">Formula: PR Created At - First Commit Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long coding time may indicate unclear requirements, scope creep, or too much work-in-progress.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First commit ‚Üí PR opened</span>
                                </td>
                                <td class="elite-col">&lt; 54 mins</td>
                                <td class="good-col">54m - 4h</td>
                                <td class="fair-col">5 - 23h</td>
                                <td class="focus-col">&gt; 23h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üëÄ Pickup Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üëÄ Pickup Time</div>
                                            <div class="tooltip-desc">The time a pull request waits for someone to start reviewing it. Low Pickup Time represents strong teamwork and a healthy review process.</div>
                                            <div class="tooltip-formula">Formula: First Review Time - PR Created At</div>
                                            <div class="tooltip-why">üí° Why it matters: Long pickup time creates bottlenecks and delays feedback, increasing context switching costs.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PR opened ‚Üí first review</span>
                                </td>
                                <td class="elite-col">&lt; 1h</td>
                                <td class="good-col">1 - 4h</td>
                                <td class="fair-col">5 - 16h</td>
                                <td class="focus-col">&gt; 16h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>‚úÖ Approve Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">‚úÖ Approve Time</div>
                                            <div class="tooltip-desc">The time from first comment/review to the first approval. This metric, along with Merge Time, is a more granular segment of Review Time.</div>
                                            <div class="tooltip-formula">Formula: First Approval Time - First Review Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long approve time may indicate complex PRs, unclear code, or slow review iterations.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First comment ‚Üí approval</span>
                                </td>
                                <td class="elite-col">&lt; 10h</td>
                                <td class="good-col">10 - 22h</td>
                                <td class="fair-col">23 - 42h</td>
                                <td class="focus-col">&gt; 42h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üîÄ Merge Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üîÄ Merge Time</div>
                                            <div class="tooltip-desc">The time from the first approval to merge. This metric, along with Approve Time, is a more granular segment of Review Time.</div>
                                            <div class="tooltip-formula">Formula: Merged At - First Approval Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Long merge time after approval may indicate CI/CD issues, merge conflicts, or process bottlenecks.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First approval ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 1h</td>
                                <td class="good-col">1 - 3h</td>
                                <td class="fair-col">4 - 16h</td>
                                <td class="focus-col">&gt; 16h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìù Review Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìù Review Time</div>
                                            <div class="tooltip-desc">The time it takes to complete a code review and get a pull request merged. Low Review Time represents strong teamwork and a healthy review process.</div>
                                            <div class="tooltip-formula">Formula: Merged At - PR Created At</div>
                                            <div class="tooltip-why">üí° Why it matters: Review Time = Pickup Time + Approve Time + Merge Time. It's the total time a PR is "in review".</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PR opened ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 3h</td>
                                <td class="good-col">3 - 14h</td>
                                <td class="fair-col">15 - 24h</td>
                                <td class="focus-col">&gt; 24h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üîÑ Cycle Time</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üîÑ Cycle Time</div>
                                            <div class="tooltip-desc">The time it takes for a single engineering task to go through the different phases of the delivery process from 'code' to 'production'.</div>
                                            <div class="tooltip-formula">Formula: Merged At - First Commit Time</div>
                                            <div class="tooltip-why">üí° Why it matters: Cycle Time = Coding Time + Review Time. It's your end-to-end delivery speed for a single change.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">First commit ‚Üí merge</span>
                                </td>
                                <td class="elite-col">&lt; 25h</td>
                                <td class="good-col">25 - 72h</td>
                                <td class="fair-col">73 - 161h</td>
                                <td class="focus-col">&gt; 161h</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìà Merge Frequency</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìà Merge Frequency</div>
                                            <div class="tooltip-desc">The total number of pull requests merged by a developer over a period of time (per week).</div>
                                            <div class="tooltip-formula">Formula: Total PRs Merged / Weeks / Developers</div>
                                            <div class="tooltip-why">üí° Why it matters: Higher merge frequency indicates consistent delivery and smaller batch sizes, reducing risk.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">PRs per developer per week</span>
                                </td>
                                <td class="elite-col">&gt; 2.0</td>
                                <td class="good-col">1.2 - 2.0</td>
                                <td class="fair-col">0.66 - 1.2</td>
                                <td class="focus-col">&lt; 0.66</td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>üìè PR Size</strong>
                                    <span class="info-icon">‚Ñπ
                                        <div class="info-tooltip">
                                            <div class="tooltip-title">üìè PR Size</div>
                                            <div class="tooltip-desc">The number of code lines modified in a pull request. Smaller pull requests are easier to review, safer to merge and correlate to a lower Cycle Time.</div>
                                            <div class="tooltip-formula">Formula: Lines Added + Lines Deleted</div>
                                            <div class="tooltip-why">üí° Why it matters: Large PRs are harder to review thoroughly, leading to more bugs and longer review times.</div>
                                        </div>
                                    </span>
                                    <br><span class="metric-hint">Lines of code changed</span>
                                </td>
                                <td class="elite-col">&lt; 100</td>
                                <td class="good-col">100 - 155</td>
                                <td class="fair-col">156 - 228</td>
                                <td class="focus-col">&gt; 228</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let trendChart = null;
        let qualityRateChart = null;
        let prSizeDistChart = null;
        let dailyPRChart = null;
        let productionReadyChart = null;

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login/nickname
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            return result;
        }

        /**
         * Get avatar URL for a contributor login/nickname
         * Uses session data to find avatar
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Custom Modal Functions
        function showModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeModal();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Detect if running in iframe
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }

            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Create display name lookup map from session contributors
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                }

                // Auto-load repositories from session
                if (sessionData.repositories && sessionData.repositories.length > 0) {
                    repositories = sessionData.repositories.map(r => ({
                        fullName: r.fullName,
                        name: r.name || r.fullName.split('/').pop(),
                        isPrivate: r.private || false
                    }));
                    renderRepoDropdown(repositories);
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Show/hide results (config panel always stays visible)
        function showResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.add('visible');
            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.remove('visible');
        }

        // Legacy goToStep calls mapped to new pattern
        function goToStep(step) {
            if (step === 3) {
                showResults();
            } else {
                hideResults();
            }
        }

        // Fetch repositories
        async function fetchRepositories() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                showError('auth-error', 'Please enter your access token');
                return;
            }

            hideError('auth-error');
            showLoading('auth-loading');

            try {
                const response = await fetch('/api/git/repositories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: document.getElementById('baseUrl').value || null
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch repositories');

                const data = await response.json();
                repositories = data.repositories;
                selectedRepos.clear();
                renderRepoDropdown(repositories);
                hideLoading('auth-loading');
                goToStep(2);
            } catch (error) {
                hideLoading('auth-loading');
                showError('auth-error', error.message);
            }
        }


        // Render repo dropdown (single select)
        function renderRepoDropdown(repos) {
            const dd = document.getElementById('repoDropdown');
            if (!repos.length) {
                dd.innerHTML = '<div class="repo-dropdown-empty">No repositories found</div>';
                return;
            }
            dd.innerHTML = repos.map(repo => {
                const icon = repo.isPrivate ? 'üîí' : 'üìÇ';
                return `<div class="repo-dropdown-item" onclick="selectRepo('${repo.fullName.replace(/'/g, "\\'")}')">
                    <span class="repo-icon">${icon}</span>
                    ${repo.fullName}
                </div>`;
            }).join('');
        }

        function filterRepos() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = repositories.filter(r => r.fullName.toLowerCase().includes(q));
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function showRepoDropdown() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => r.fullName.toLowerCase().includes(q)) : repositories;
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function selectRepo(fullName) {
            document.getElementById('repoSearch').value = fullName;
            document.getElementById('repoSelectValue').value = fullName;
            document.getElementById('repoDropdown').classList.remove('show');
            document.getElementById('analyzeBtn').disabled = false;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const wrapper = document.getElementById('repoSearchWrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('repoDropdown').classList.remove('show');
            }
        });

        // Branch helper ‚Äî reads comma-separated input
        function getBranchesFromInput() {
            const input = document.getElementById('branchInput');
            if (!input || !input.value.trim()) return [];
            return input.value.split(',').map(b => b.trim()).filter(b => b.length > 0);
        }

        // Show loading panel
        function showLoadingPanel(repos) {
            const panel = document.getElementById('loadingPanel');
            if (panel) {
                panel.classList.remove('hidden');
                panel.innerHTML = `
                    <div class="loading-panel">
                        <div class="loading-header">
                            <div class="loading-title">
                                <div class="pulse-dot"></div>
                                <span>Analyzing ${repos.length} Repositories</span>
                            </div>
                            <span style="font-size: 0.875rem; color: #a1a1aa;">Please wait...</span>
                        </div>
                        <div class="loading-progress-bar">
                            <div class="loading-progress-fill" id="matrixProgressFill" style="width: 0%"></div>
                        </div>
                        <div class="loading-status" id="matrixLoadingStatus">
                            Fetching PR data from GitHub API...
                        </div>
                    </div>
                `;
            }
        }

        function hideLoadingPanel() {
            const panel = document.getElementById('loadingPanel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        function updateLoadingProgress(percent, status) {
            const fill = document.getElementById('matrixProgressFill');
            const statusEl = document.getElementById('matrixLoadingStatus');
            if (fill) fill.style.width = percent + '%';
            if (statusEl) statusEl.textContent = status;
        }

        // Analyze metrics
        async function analyzeMetrics() {
            const selectedRepo = document.getElementById('repoSelectValue').value;
            if (!selectedRepo) {
                showModal('üìÅ', 'Repository Required', 'Please select a repository to analyze.');
                return;
            }
            analyzeBtn.disabled = true;

            hideError('analyze-error');

            const repoList = [selectedRepo];
            showLoadingPanel(repoList);
            updateLoadingProgress(10, 'Connecting to GitHub API...');

            const sessionData = getSessionData();
            const token = sessionData?.token || '';
            const startDate = document.getElementById('startDate').value || null;
            const endDate = document.getElementById('endDate').value || null;

            try {
                updateLoadingProgress(20, 'Fetching PR data...');

                // Prepare branch filter from text input
                const branches = getBranchesFromInput();
                const branchesToSend = branches.length > 0 ? branches : null;

                const response = await fetch('/api/metrics/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: sessionData?.baseUrl || null,
                        repositoryFullNames: repoList,
                        startDate: startDate,
                        endDate: endDate,
                        branches: branchesToSend
                    })
                });

                updateLoadingProgress(60, 'Processing PR metrics...');

                if (!response.ok) throw new Error('Failed to analyze metrics');

                updateLoadingProgress(80, 'Calculating developer metrics...');
                const data = await response.json();

                updateLoadingProgress(100, 'Complete!');

                setTimeout(() => {
                    hideLoadingPanel();
                    displayResults(data);
                    analyzeBtn.disabled = false;
                    goToStep(3);
                }, 500);
            } catch (error) {
                analyzeBtn.disabled = false;
                hideLoadingPanel();
                showModal('‚ùå', 'Analysis Failed', error.message);
            }
        }

        // Store metrics data globally for popup access
        let currentMetricsData = null;
        let allPRsList = [];

        // Display results
        function displayResults(data) {
            // Store data globally
            currentMetricsData = data;

            // Collect all PRs from all developers
            allPRsList = [];
            data.developerMetrics.forEach(dev => {
                if (dev.prDetails && dev.prDetails.length > 0) {
                    dev.prDetails.forEach(pr => {
                        allPRsList.push({
                            ...pr,
                            developerName: dev.developerName,
                            nickname: dev.nickname
                        });
                    });
                }
            });

            // Analysis Info Banner (trunk-matrix style)
            const repos = data.analyzedRepositories || [];
            document.getElementById('analysisInfo').innerHTML =
                'üì¶ <strong>' + repos.join(', ') + '</strong> ‚Ä¢ ' +
                data.dateRange.startDate + ' ‚Üí ' + data.dateRange.endDate +
                ' ‚Ä¢ ' + data.teamMetrics.totalPRs + ' PRs ‚Ä¢ ' +
                data.teamMetrics.totalDevelopers + ' developers';

            // Overall Rating Badge
            const overallRating = computeOverallRating(data.teamMetrics);
            const ob = document.getElementById('overallBadge');
            ob.className = 'overall-badge rating-' + overallRating.toLowerCase().replace('_', '-').replace(' ', '-');
            ob.innerHTML = 'üèÜ Overall Rating: <strong>' + overallRating + '</strong>';

            // Team Metrics Grid
            renderTeamMetrics(data.teamMetrics);

            // Trend Chart
            renderTrendChart(data.weeklyTrend);

            // Developer Matrix
            renderDeveloperMatrix(data.developerMetrics);

            // PR Quality & Size Analytics
            renderQualityRateChart(allPRsList);
            renderPRSizeDistribution(allPRsList);
            renderDailyPRChart(allPRsList);
            renderProductionReadiness(allPRsList);

            // PR List
            renderPRList(allPRsList, data.analyzedRepositories);
        }

        // Compute overall rating from team metrics
        function computeOverallRating(teamMetrics) {
            const ratingOrder = ['ELITE', 'GOOD', 'FAIR', 'NEEDS_FOCUS'];
            const ratingScore = { 'ELITE': 4, 'GOOD': 3, 'FAIR': 2, 'NEEDS_FOCUS': 1 };
            const metrics = ['cycleTime', 'codingTime', 'pickupTime', 'reviewTime', 'mergeFrequency', 'prSize'];
            let totalScore = 0;
            let count = 0;
            metrics.forEach(key => {
                const m = teamMetrics[key];
                if (m && m.rating) {
                    const r = m.rating.toUpperCase().replace(' ', '_');
                    totalScore += (ratingScore[r] || 2);
                    count++;
                }
            });
            if (count === 0) return 'Fair';
            const avg = totalScore / count;
            if (avg >= 3.5) return 'Elite';
            if (avg >= 2.5) return 'Good';
            if (avg >= 1.5) return 'Fair';
            return 'Needs Focus';
        }

        function renderTeamMetrics(metrics) {
            const metricsConfig = [
                { key: 'codingTime', name: 'Coding Time', icon: '‚å®Ô∏è', desc: 'First commit to PR opened' },
                { key: 'pickupTime', name: 'Pickup Time', icon: 'üëÄ', desc: 'PR opened to first review' },
                { key: 'approveTime', name: 'Approve Time', icon: '‚úÖ', desc: 'First comment to approval' },
                { key: 'mergeTime', name: 'Merge Time', icon: 'üîÄ', desc: 'First approval to merge' },
                { key: 'reviewTime', name: 'Review Time', icon: 'üìù', desc: 'PR opened to merge' },
                { key: 'cycleTime', name: 'Cycle Time', icon: 'üîÑ', desc: 'First commit to merge' },
                { key: 'mergeFrequency', name: 'Merge Frequency', icon: 'üìà', desc: 'PRs per developer per week' },
                { key: 'prSize', name: 'PR Size', icon: 'üìè', desc: 'Average lines changed' }
            ];

            const grid = document.getElementById('teamMetricsGrid');
            grid.innerHTML = metricsConfig.map(config => {
                const metric = metrics[config.key];
                const ratingClass = metric.rating.toLowerCase().replace('_', '-');
                return `
                    <div class="metric-card ${ratingClass}">
                        <div class="metric-header">
                            <span class="metric-name">${config.icon} ${config.name}</span>
                            <span class="metric-badge ${ratingClass}">${metric.rating.replace('_', ' ')}</span>
                        </div>
                        <div class="metric-value">${metric.displayValue}</div>
                        <div class="metric-description">${config.desc}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTrendChart(weeklyTrend) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyTrend.map(w => w.week),
                    datasets: [
                        {
                            label: 'Cycle Time (hours)',
                            data: weeklyTrend.map(w => w.cycleTime),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'PRs Merged',
                            data: weeklyTrend.map(w => w.prCount),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e4e4e7' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Cycle Time (hrs)', color: '#a1a1aa' },
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'PRs Merged', color: '#a1a1aa' },
                            ticks: { color: '#a1a1aa' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // ==================== PR QUALITY & SIZE ANALYTICS ====================

        // Global buckets for drill-down
        let _qualityBuckets = {};
        let _sizeBuckets = {};
        let _dailyBuckets = {};
        let _prodBuckets = {};
        let _drilldownPRs = [];

        function renderQualityRateChart(prs) {
            const categories = [
                { key: 'passed',   label: '‚úÖ Passed',   filter: p => p.checkStatus === 'SUCCESS', bg: 'rgba(34,197,94,.75)', border: '#16a34a', chipBg: 'rgba(34,197,94,.15)', chipBorder: 'rgba(34,197,94,.4)', chipColor: '#4ade80' },
                { key: 'failed',   label: '‚ùå Failed',   filter: p => p.checkStatus === 'FAILURE' || p.checkStatus === 'ERROR', bg: 'rgba(239,68,68,.75)', border: '#dc2626', chipBg: 'rgba(239,68,68,.15)', chipBorder: 'rgba(239,68,68,.4)', chipColor: '#f87171' },
                { key: 'pending',  label: '‚è≥ Pending',  filter: p => p.checkStatus === 'PENDING' || p.checkStatus === 'EXPECTED', bg: 'rgba(245,158,11,.75)', border: '#d97706', chipBg: 'rgba(245,158,11,.15)', chipBorder: 'rgba(245,158,11,.4)', chipColor: '#fbbf24' },
                { key: 'noChecks', label: '‚ö™ No Checks', filter: p => !p.checkStatus, bg: 'rgba(255,255,255,.08)', border: 'rgba(255,255,255,.2)', chipBg: 'rgba(255,255,255,.06)', chipBorder: 'rgba(255,255,255,.15)', chipColor: '#71717a' }
            ];
            const total = prs.length;
            categories.forEach(c => { c.prs = prs.filter(c.filter); c.count = c.prs.length; });
            _qualityBuckets = Object.fromEntries(categories.map(c => [c.key, c.prs]));

            // Summary chips
            document.getElementById('qualityRateSummaryCards').innerHTML = categories.map(c =>
                `<div onclick="openChartDrilldown('${c.label}', '${c.key}', 'quality')" style="flex:1; min-width:100px; padding:.6rem .75rem; background:${c.chipBg}; border:1px solid ${c.chipBorder}; border-radius:10px; cursor:pointer; transition:transform .15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div style="font-size:1.3rem; font-weight:700; color:${c.chipColor}">${c.count}</div>
                    <div style="font-size:.72rem; color:#a1a1aa;">${c.label} <span style="opacity:.7">(${total>0?Math.round(c.count/total*100):0}%)</span></div>
                </div>`
            ).join('');

            if (qualityRateChart) qualityRateChart.destroy();
            qualityRateChart = new Chart(document.getElementById('qualityRateChart'), {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c.label),
                    datasets: [{ data: categories.map(c => c.count), backgroundColor: categories.map(c => c.bg), borderColor: categories.map(c => c.border), borderWidth: 2, hoverOffset: 8 }]
                },
                options: {
                    responsive: true, cutout: '62%',
                    onClick: (evt, els) => { if (els.length) { const c = categories[els[0].index]; openChartDrilldown(c.label, c.key, 'quality'); } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed} PRs (${total>0?Math.round(ctx.parsed/total*100):0}%)` } }
                    }
                },
                plugins: [{ id: 'centerTotal', afterDraw(chart) { const { ctx: c2, chartArea } = chart; const cx = (chartArea.left+chartArea.right)/2, cy = (chartArea.top+chartArea.bottom)/2; c2.save(); c2.textAlign='center'; c2.textBaseline='middle'; c2.font='bold 1.5rem Inter,sans-serif'; c2.fillStyle='#fff'; c2.fillText(total, cx, cy-7); c2.font='0.65rem Inter,sans-serif'; c2.fillStyle='#71717a'; c2.fillText('total PRs', cx, cy+11); c2.restore(); } }]
            });
            document.getElementById('qualityRateChart').style.cursor = 'pointer';

            const successRate = total > 0 ? Math.round(categories[0].count / total * 100) : 0;
            document.getElementById('qualityRateStats').innerHTML = `<strong style="color:${successRate>=80?'#22c55e':successRate>=50?'#f59e0b':'#ef4444'}">${successRate}%</strong> pass rate across <strong>${total}</strong> PRs`;
        }

        function renderPRSizeDistribution(prs) {
            const buckets = [
                { key: 'elite', label: 'üèÜ Elite', range: '< 100 lines', min: 0, max: 99, bg: 'rgba(34,197,94,.8)', border: '#16a34a' },
                { key: 'good',  label: '‚úÖ Good',  range: '100‚Äì155',     min: 100, max: 155, bg: 'rgba(59,130,246,.8)', border: '#2563eb' },
                { key: 'fair',  label: '‚ö†Ô∏è Fair',  range: '156‚Äì228',     min: 156, max: 228, bg: 'rgba(245,158,11,.8)', border: '#d97706' },
                { key: 'focus', label: 'üî¥ Needs Focus', range: '> 228', min: 229, max: Infinity, bg: 'rgba(239,68,68,.8)', border: '#dc2626' }
            ];
            const total = prs.length;
            buckets.forEach(b => { b.prs = prs.filter(p => p.prSize >= b.min && p.prSize <= b.max); b.count = b.prs.length; });
            _sizeBuckets = Object.fromEntries(buckets.map(b => [b.key, b.prs]));

            const wellSized = total > 0 ? Math.round((buckets[0].count + buckets[1].count) / total * 100) : 0;
            document.getElementById('prSizeDistStats').innerHTML = `<strong style="color:${wellSized>=70?'#22c55e':wellSized>=40?'#f59e0b':'#ef4444'}">${wellSized}%</strong> well-sized (Elite + Good) ¬∑ <strong>${total}</strong> total`;

            if (prSizeDistChart) prSizeDistChart.destroy();
            prSizeDistChart = new Chart(document.getElementById('prSizeDistChart'), {
                type: 'bar',
                data: {
                    labels: buckets.map(b => b.label + '\n' + b.range),
                    datasets: [{
                        label: 'PRs',
                        data: buckets.map(b => b.count),
                        backgroundColor: buckets.map(b => b.bg),
                        borderColor: buckets.map(b => b.border),
                        borderWidth: 2, borderRadius: 8, borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => { if (els.length) { const b = buckets[els[0].index]; openChartDrilldown(b.label + ' (' + b.range + ')', b.key, 'size'); } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,.05)' }, ticks: { color: '#a1a1aa', font: { size: 11 } } },
                        y: { grid: { color: 'rgba(255,255,255,.05)' }, ticks: { color: '#71717a', stepSize: 1 }, title: { display: true, text: 'Number of PRs', color: '#71717a', font: { size: 11 } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y} PRs (${total>0?Math.round(ctx.parsed.y/total*100):0}%)` } }
                    }
                }
            });
            document.getElementById('prSizeDistChart').style.cursor = 'pointer';
        }

        function renderDailyPRChart(prs) {
            const dayMap = {};
            prs.forEach(pr => {
                if (!pr.mergedAt) return;
                const day = pr.mergedAt.substring(0, 10);
                if (!dayMap[day]) dayMap[day] = { passed: [], failed: [], noChecks: [] };
                if (pr.checkStatus === 'SUCCESS') dayMap[day].passed.push(pr);
                else if (pr.checkStatus === 'FAILURE' || pr.checkStatus === 'ERROR') dayMap[day].failed.push(pr);
                else dayMap[day].noChecks.push(pr);
            });
            _dailyBuckets = dayMap;

            const sortedDays = Object.keys(dayMap).sort();
            const labels = sortedDays.map(d => { const dt = new Date(d + 'T00:00:00'); return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); });

            if (dailyPRChart) dailyPRChart.destroy();
            dailyPRChart = new Chart(document.getElementById('dailyPRChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: '‚úÖ Passed',    data: sortedDays.map(d => dayMap[d].passed.length),   backgroundColor: 'rgba(34,197,94,.75)',   borderRadius: 4 },
                        { label: '‚ùå Failed',    data: sortedDays.map(d => dayMap[d].failed.length),   backgroundColor: 'rgba(239,68,68,.75)',  borderRadius: 4 },
                        { label: '‚ö™ No Checks', data: sortedDays.map(d => dayMap[d].noChecks.length), backgroundColor: 'rgba(255,255,255,.12)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => {
                        if (!els.length) return;
                        const dayIdx = els[0].index;
                        const dsIdx = els[0].datasetIndex;
                        const day = sortedDays[dayIdx];
                        const types = ['passed', 'failed', 'noChecks'];
                        const typeLabels = ['‚úÖ Passed', '‚ùå Failed', '‚ö™ No Checks'];
                        _drilldownPRs = dayMap[day][types[dsIdx]];
                        showChartDrilldown(labels[dayIdx] + ' ‚Äî ' + typeLabels[dsIdx], _drilldownPRs.length + ' PRs');
                    },
                    scales: {
                        x: { stacked: true, grid: { color: 'rgba(255,255,255,.04)' }, ticks: { color: '#71717a', font: { size: 10 }, maxRotation: 45 } },
                        y: { stacked: true, grid: { color: 'rgba(255,255,255,.04)' }, ticks: { color: '#71717a', stepSize: 1 }, title: { display: true, text: 'PRs', color: '#71717a' } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#a1a1aa', padding: 12, font: { size: 11 } } },
                        tooltip: { callbacks: { title: ctx => sortedDays[ctx[0].dataIndex], afterBody: ctx => { const d = sortedDays[ctx[0].dataIndex]; return 'Total: ' + (dayMap[d].passed.length + dayMap[d].failed.length + dayMap[d].noChecks.length) + ' PRs'; } } }
                    }
                }
            });
            document.getElementById('dailyPRChart').style.cursor = 'pointer';
        }

        function renderProductionReadiness(prs) {
            const readyPRs = prs.filter(p => p.checkStatus === 'SUCCESS');
            const notReadyPRs = prs.filter(p => p.checkStatus && p.checkStatus !== 'SUCCESS');
            const noCheckPRs = prs.filter(p => !p.checkStatus);
            const withChecks = readyPRs.length + notReadyPRs.length;
            const pct = withChecks > 0 ? Math.round(readyPRs.length / withChecks * 100) : 0;
            const total = prs.length;
            _prodBuckets = { ready: readyPRs, notReady: notReadyPRs, noChecks: noCheckPRs };

            const chips = [
                { key: 'ready',    icon: 'üöÄ', label: 'Prod Ready', prs: readyPRs, chipBg: 'rgba(34,197,94,.15)', chipBorder: 'rgba(34,197,94,.4)', chipColor: '#4ade80' },
                { key: 'notReady', icon: '‚õî', label: 'Not Ready',  prs: notReadyPRs, chipBg: 'rgba(239,68,68,.15)', chipBorder: 'rgba(239,68,68,.4)', chipColor: '#f87171' },
                { key: 'noChecks', icon: '‚ö™', label: 'No Checks',  prs: noCheckPRs, chipBg: 'rgba(255,255,255,.06)', chipBorder: 'rgba(255,255,255,.15)', chipColor: '#71717a' }
            ];
            document.getElementById('prodReadySummaryCards').innerHTML = chips.map(c =>
                `<div onclick="openChartDrilldown('${c.label}', '${c.key}', 'prod')" style="flex:1; min-width:90px; padding:.6rem .75rem; background:${c.chipBg}; border:1px solid ${c.chipBorder}; border-radius:10px; cursor:pointer; transition:transform .15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    <div style="font-size:1.3rem; font-weight:700; color:${c.chipColor}">${c.prs.length}</div>
                    <div style="font-size:.72rem; color:#a1a1aa;">${c.icon} ${c.label} <span style="opacity:.7">(${total>0?Math.round(c.prs.length/total*100):0}%)</span></div>
                </div>`
            ).join('');

            if (productionReadyChart) productionReadyChart.destroy();
            productionReadyChart = new Chart(document.getElementById('productionReadyChart'), {
                type: 'doughnut',
                data: {
                    labels: chips.map(c => c.icon + ' ' + c.label),
                    datasets: [{ data: chips.map(c => c.prs.length), backgroundColor: ['rgba(34,197,94,.75)', 'rgba(239,68,68,.75)', 'rgba(255,255,255,.08)'], borderColor: ['#16a34a', '#dc2626', 'rgba(255,255,255,.15)'], borderWidth: 2, hoverOffset: 8 }]
                },
                options: {
                    responsive: true, cutout: '65%',
                    onClick: (evt, els) => { if (els.length) { const c = chips[els[0].index]; openChartDrilldown(c.label, c.key, 'prod'); } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed} PRs (${withChecks>0?Math.round(ctx.parsed/withChecks*100):0}%)` } }
                    }
                },
                plugins: [{ id: 'centerPct', afterDraw(chart) { const { ctx: c2, chartArea } = chart; const cx = (chartArea.left+chartArea.right)/2, cy = (chartArea.top+chartArea.bottom)/2; c2.save(); c2.textAlign='center'; c2.textBaseline='middle'; c2.font='bold 2rem Inter,sans-serif'; c2.fillStyle = pct>=80?'#22c55e':pct>=50?'#f59e0b':'#ef4444'; c2.fillText(pct+'%',cx,cy-10); c2.font='0.65rem Inter,sans-serif'; c2.fillStyle='#71717a'; c2.fillText('prod ready',cx,cy+12); c2.restore(); } }]
            });
            document.getElementById('productionReadyChart').style.cursor = 'pointer';

            document.getElementById('productionReadyStats').innerHTML =
                `<strong>${readyPRs.length}</strong> of <strong>${withChecks}</strong> checked PRs passed` +
                (noCheckPRs.length > 0 ? ` ¬∑ <span style="color:#71717a">${noCheckPRs.length} had no checks</span>` : '');
        }

        // ==================== CHART DRILL-DOWN POPUP ====================

        function openChartDrilldown(label, bucketKey, chartType) {
            let prsList = [];
            if (chartType === 'quality') prsList = _qualityBuckets[bucketKey] || [];
            else if (chartType === 'size') prsList = _sizeBuckets[bucketKey] || [];
            else if (chartType === 'prod') prsList = _prodBuckets[bucketKey] || [];
            _drilldownPRs = prsList;
            showChartDrilldown(label, prsList.length + ' PRs');
        }

        function showChartDrilldown(title, subtitle) {
            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownSubtitle').textContent = subtitle;
            document.getElementById('drilldownSearchInput').value = '';
            renderDrilldownPRList(_drilldownPRs);
            const modal = document.getElementById('chartDrilldownModal');
            modal.style.display = 'flex';
        }

        function closeChartDrilldown(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('chartDrilldownModal').style.display = 'none';
        }

        function filterDrilldownList() {
            const q = (document.getElementById('drilldownSearchInput').value || '').toLowerCase();
            const filtered = q
                ? _drilldownPRs.filter(pr =>
                    (pr.prTitle || pr.title || '').toLowerCase().includes(q) ||
                    String(pr.prNumber || pr.number || '').includes(q) ||
                    (pr.author || pr.authorLogin || pr.nickname || '').toLowerCase().includes(q) ||
                    (pr.repositoryFullName || '').toLowerCase().includes(q)
                ) : _drilldownPRs;
            renderDrilldownPRList(filtered);
        }

        function renderDrilldownPRList(prs) {
            const body = document.getElementById('drilldownBody');
            if (!prs || prs.length === 0) {
                body.innerHTML = '<p style="text-align:center;color:#71717a;padding:2rem;">No PRs in this category</p>';
                return;
            }
            const statusDot = s => {
                if (s === 'SUCCESS') return '#22c55e';
                if (s === 'FAILURE' || s === 'ERROR') return '#ef4444';
                if (s === 'PENDING' || s === 'EXPECTED') return '#f59e0b';
                return '#71717a';
            };
            const sizeTag = size => {
                if (size == null) return '';
                if (size < 100) return '<span style="color:#4ade80;">üèÜ Elite</span>';
                if (size <= 155) return '<span style="color:#60a5fa;">‚úÖ Good</span>';
                if (size <= 228) return '<span style="color:#fbbf24;">‚ö†Ô∏è Fair</span>';
                return '<span style="color:#f87171;">üî¥ Large</span>';
            };
            body.innerHTML = prs.map(pr => {
                const num = pr.prNumber || pr.number;
                const title = pr.prTitle || pr.title || 'PR #' + num;
                const repo = pr.repositoryFullName || '';
                const repoShort = repo.split('/').pop();
                const author = getDisplayName(pr.author || pr.authorLogin || pr.nickname || '');
                const url = repo ? 'https://github.com/' + repo + '/pull/' + num : '#';
                const titleEl = document.createElement('span'); titleEl.textContent = title;
                const safeTitle = titleEl.innerHTML;
                const mergedDate = pr.mergedAt ? new Date(pr.mergedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
                const dot = statusDot(pr.checkStatus);
                const sz = sizeTag(pr.prSize);
                return `
                    <div style="display:flex; gap:.75rem; padding:.65rem .75rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:10px; margin-bottom:.4rem; transition:all .15s; cursor:default;" onmouseover="this.style.background='rgba(99,102,241,.08)';this.style.borderColor='rgba(99,102,241,.2)'" onmouseout="this.style.background='rgba(255,255,255,.03)';this.style.borderColor='rgba(255,255,255,.06)'">
                        <div style="font-family:'Courier New',monospace; font-size:.78rem; color:#818cf8; min-width:48px; padding-top:2px;"><a href="${url}" target="_blank" style="color:#818cf8; text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">#${num}</a></div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-size:.85rem; color:#e4e4e7; margin-bottom:.25rem; word-break:break-word;"><a href="${url}" target="_blank" style="color:#e4e4e7; text-decoration:none;" onmouseover="this.style.color='#818cf8';this.style.textDecoration='underline'" onmouseout="this.style.color='#e4e4e7';this.style.textDecoration='none'">${safeTitle}</a></div>
                            <div style="display:flex; flex-wrap:wrap; gap:.5rem; font-size:.73rem; color:#71717a; align-items:center;">
                                <span style="width:8px; height:8px; border-radius:50%; background:${dot}; display:inline-block;" title="Check: ${pr.checkStatus || 'none'}"></span>
                                ${author ? '<span>üë§ ' + author + '</span>' : ''}
                                ${repoShort ? '<span>üì¶ ' + repoShort + '</span>' : ''}
                                ${mergedDate ? '<span>üìÖ ' + mergedDate + '</span>' : ''}
                                ${pr.prSize != null ? '<span>üìè ' + pr.prSize + ' lines ¬∑ ' + sz + '</span>' : ''}
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // Close drill-down on Escape
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeChartDrilldown(); });

        function renderDeveloperMatrix(developers) {
            const tbody = document.getElementById('developerMatrixBody');

            tbody.innerHTML = developers.map((dev, index) => {
                const displayName = getDisplayName(dev.nickname);
                const avatarUrl = getAvatarUrl(dev.nickname);

                return `
                <tr onclick="showDeveloperPRs(${index})" title="Click to view ${displayName}'s PRs">
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${avatarUrl
                                ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #6366f1;">`
                                : '<span style="font-size: 1.5em;">üë§</span>'
                            }
                            <div>
                                <strong style="display: block;">${displayName}</strong>
                                <span style="color: #6366f1; font-size: 0.8rem;">@${dev.nickname}</span>
                            </div>
                        </div>
                    </td>
                    <td>${dev.totalPRs}</td>
                    <td>${renderMatrixCell(dev.codingTime)}</td>
                    <td>${renderMatrixCell(dev.pickupTime)}</td>
                    <td>${renderMatrixCell(dev.reviewTime)}</td>
                    <td>${renderMatrixCell(dev.cycleTime)}</td>
                    <td>${renderMatrixCell(dev.mergeFrequency)}</td>
                    <td>${renderMatrixCell(dev.prSize)}</td>
                </tr>
            `;
            }).join('');
        }

        function renderMatrixCell(metric) {
            const ratingClass = metric.rating.toLowerCase().replace('_', '-');
            return `
                <div class="matrix-cell">
                    <span class="indicator ${ratingClass}"></span>
                    <span class="value">${metric.displayValue}</span>
                </div>
            `;
        }

        // Utilities
        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ==================== PR LIST FUNCTIONS ====================

        // Render PR list section
        function renderPRList(prs, repositories) {
            const panel = document.getElementById('prListPanel');
            const container = document.getElementById('prListContainer');
            const countBadge = document.getElementById('prCountBadge');

            if (!prs || prs.length === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            countBadge.textContent = prs.length;

            // Build PR URL base from repositories
            const repoUrlMap = {};
            repositories.forEach(repo => {
                repoUrlMap[repo] = `https://github.com/${repo}/pull/`;
            });

            container.innerHTML = prs.map(pr => {
                const displayName = getDisplayName(pr.nickname || pr.author);
                const avatarUrl = getAvatarUrl(pr.nickname || pr.author);
                const prUrl = buildPRUrl(pr, repositories);

                // Build timeline info (first line) with icons and colors
                const timeline = [];
                if (pr.firstCommitTime) {
                    timeline.push(`<span style="color: #a78bfa;">üìù First Commit:</span> ${formatDateTime(pr.firstCommitTime)}`);
                }
                timeline.push(`<span style="color: #60a5fa;">‚Üí üöÄ PR Created:</span> ${formatDateTime(pr.createdAt)}`);
                if (pr.firstReviewTime) {
                    timeline.push(`<span style="color: #fbbf24;">‚Üí üëÄ First Review:</span> ${formatDateTime(pr.firstReviewTime)}`);
                }
                if (pr.firstApprovalTime) {
                    timeline.push(`<span style="color: #34d399;">‚Üí ‚úÖ First Approval:</span> ${formatDateTime(pr.firstApprovalTime)}`);
                }
                if (pr.mergedAt) {
                    timeline.push(`<span style="color: #22c55e;">‚Üí üîÄ Merged:</span> ${formatDateTime(pr.mergedAt)}`);
                }

                // Build code changes (second line)
                const codeChanges = [
                    `<span style="color: #86efac;">Lines Added:</span> <span style="color: #22c55e; font-weight: 600;">+${pr.additions || 0}</span>`,
                    `<span style="color: #fca5a5;">Lines Deleted:</span> <span style="color: #ef4444; font-weight: 600;">-${pr.deletions || 0}</span>`,
                    `<span style="color: #9ca3af;">Total Changes:</span> <span style="font-weight: 600;">${pr.prSize || 0} lines</span>`
                ];

                // All 6 metrics always shown
                const metricsHTML = [
                    { label: 'Coding Time', val: pr.codingTimeHours, type: 'codingTime' },
                    { label: 'Pickup Time', val: pr.pickupTimeHours, type: 'pickupTime' },
                    { label: 'Approve Time', val: pr.approveTimeHours, type: 'approveTime' },
                    { label: 'Merge Time', val: pr.mergeTimeHours, type: 'mergeTime' },
                    { label: 'Review Time', val: pr.reviewTimeHours, type: 'reviewTime' },
                    { label: 'Cycle Time', val: pr.cycleTimeHours, type: 'cycleTime' }
                ].map(m => {
                    const rating = getRatingClass(m.val, m.type);
                    const displayVal = formatHoursShort(m.val);
                    return `<span class="pr-metric-tag ${rating}">${m.label}: ${displayVal}</span>`;
                }).join('');

                return `
                    <div class="pr-item">
                        <div class="pr-number">#${pr.prNumber}</div>
                        <div class="pr-info">
                            <div class="pr-title">
                                <a href="${prUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(pr.prTitle)}</a>
                            </div>
                            <div class="pr-meta">
                                <span class="pr-meta-item">
                                    ${avatarUrl ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 16px; height: 16px; border-radius: 50%;">` : 'üë§'}
                                    ${displayName}
                                </span>
                            </div>
                            <div style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0; line-height: 1.5;">
                                <div>${timeline.join(' &nbsp;&nbsp;')}</div>
                                <div style="margin-top: 0.25rem;">${codeChanges.join(' &nbsp;&nbsp;')}</div>
                            </div>
                            <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.5rem 0;"></div>
                            <div class="pr-metrics">
                                ${metricsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter PR list
        function filterPRList() {
            const searchTerm = document.getElementById('prSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('#prListContainer .pr-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Build PR URL
        function buildPRUrl(pr, repositories) {
            // Try to find the repository from the PR data or use the first repo
            if (repositories && repositories.length > 0) {
                const repo = repositories[0]; // Default to first repo
                return `https://github.com/${repo}/pull/${pr.prNumber}`;
            }
            return '#';
        }

        // ==================== CONTRIBUTOR PR POPUP ====================

        // Show developer PRs popup
        function showDeveloperPRs(developerIndex) {
            if (!currentMetricsData || !currentMetricsData.developerMetrics) return;

            const dev = currentMetricsData.developerMetrics[developerIndex];
            if (!dev) return;

            const displayName = getDisplayName(dev.nickname);
            const avatarUrl = getAvatarUrl(dev.nickname);
            const prs = dev.prDetails || [];

            // Update header
            document.getElementById('prPopupAvatar').src = avatarUrl || '';
            document.getElementById('prPopupAvatar').style.display = avatarUrl ? 'block' : 'none';
            document.getElementById('prPopupName').textContent = displayName;
            document.getElementById('prPopupLogin').textContent = `@${dev.nickname}`;

            // Update stats
            document.getElementById('prPopupStats').innerHTML = `
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.totalPRs}</div>
                    <div class="pr-popup-stat-label">Total PRs</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.cycleTime.displayValue}</div>
                    <div class="pr-popup-stat-label">Avg Cycle Time</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.prSize.displayValue}</div>
                    <div class="pr-popup-stat-label">Avg PR Size</div>
                </div>
                <div class="pr-popup-stat">
                    <div class="pr-popup-stat-value">${dev.mergeFrequency.displayValue}</div>
                    <div class="pr-popup-stat-label">Merge Freq</div>
                </div>
            `;

            // Render PR list
            const body = document.getElementById('prPopupBody');
            if (prs.length === 0) {
                body.innerHTML = '<p style="text-align: center; color: #71717a; padding: 2rem;">No PR details available</p>';
            } else {
                const repositories = currentMetricsData.analyzedRepositories;
                body.innerHTML = prs.map(pr => {
                    const prUrl = buildPRUrl(pr, repositories);

                    // Build timeline info with icons and colors
                    const timeline = [];
                    if (pr.firstCommitTime) {
                        timeline.push(`<span style="color: #a78bfa;">üìù First Commit:</span> ${formatDateTime(pr.firstCommitTime)}`);
                    }
                    timeline.push(`<span style="color: #60a5fa;">‚Üí üöÄ PR Created:</span> ${formatDateTime(pr.createdAt)}`);
                    if (pr.firstReviewTime) {
                        timeline.push(`<span style="color: #fbbf24;">‚Üí üëÄ First Review:</span> ${formatDateTime(pr.firstReviewTime)}`);
                    }
                    if (pr.firstApprovalTime) {
                        timeline.push(`<span style="color: #34d399;">‚Üí ‚úÖ First Approval:</span> ${formatDateTime(pr.firstApprovalTime)}`);
                    }
                    if (pr.mergedAt) {
                        timeline.push(`<span style="color: #22c55e;">‚Üí üîÄ Merged:</span> ${formatDateTime(pr.mergedAt)}`);
                    }

                    // Build code changes
                    const codeChanges = [
                        `<span style="color: #86efac;">Lines Added:</span> <span style="color: #22c55e; font-weight: 600;">+${pr.additions || 0}</span>`,
                        `<span style="color: #fca5a5;">Lines Deleted:</span> <span style="color: #ef4444; font-weight: 600;">-${pr.deletions || 0}</span>`,
                        `<span style="color: #9ca3af;">Total Changes:</span> <span style="font-weight: 600;">${pr.prSize || 0} lines</span>`
                    ];

                    // All 6 metrics
                    const metricsHTML = [
                        { label: 'Coding Time', val: pr.codingTimeHours, type: 'codingTime' },
                        { label: 'Pickup Time', val: pr.pickupTimeHours, type: 'pickupTime' },
                        { label: 'Approve Time', val: pr.approveTimeHours, type: 'approveTime' },
                        { label: 'Merge Time', val: pr.mergeTimeHours, type: 'mergeTime' },
                        { label: 'Review Time', val: pr.reviewTimeHours, type: 'reviewTime' },
                        { label: 'Cycle Time', val: pr.cycleTimeHours, type: 'cycleTime' }
                    ].map(m => {
                        const rating = getRatingClass(m.val, m.type);
                        const displayVal = formatHoursShort(m.val);
                        return `<span class="pr-metric-tag ${rating}">${m.label}: ${displayVal}</span>`;
                    }).join('');

                    return `
                        <div class="pr-item">
                            <div class="pr-number">#${pr.prNumber}</div>
                            <div class="pr-info">
                                <div class="pr-title">
                                    <a href="${prUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(pr.prTitle)}</a>
                                </div>
                                <div style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0; line-height: 1.5;">
                                    <div>${timeline.join(' &nbsp;&nbsp;')}</div>
                                    <div style="margin-top: 0.25rem;">${codeChanges.join(' &nbsp;&nbsp;')}</div>
                                </div>
                                <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.5rem 0;"></div>
                                <div class="pr-metrics">
                                    ${metricsHTML}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Show popup
            document.getElementById('prPopupModal').classList.add('show');
        }

        // Close PR popup
        function closePRPopup(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prPopupModal').classList.remove('show');
        }

        // Close popup on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePRPopup();
            }
        });

        // ==================== HELPER FUNCTIONS ====================

        // Format hours to readable string
        function formatHours(hours) {
            if (hours == null) return 'N/A';
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${hours.toFixed(1)}h`;
            const days = Math.floor(hours / 24);
            const remainingHours = Math.round(hours % 24);
            return `${days}d ${remainingHours}h`;
        }

        // Format hours short - always returns a value (for consistent display)
        function formatHoursShort(hours) {
            if (hours == null || hours === undefined) return '‚Äî';
            if (hours === 0) return '0m';
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${hours.toFixed(1)}h`;
            const days = Math.floor(hours / 24);
            const remainingHours = Math.round(hours % 24);
            if (remainingHours === 0) return `${days}d`;
            return `${days}d ${remainingHours}h`;
        }

        // Format date (short)
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format date and time (full)
        function formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get rating class based on metric thresholds
        function getRatingClass(hours, metricType) {
            const thresholds = {
                codingTime: { elite: 0.9, good: 4, fair: 23 },
                pickupTime: { elite: 1, good: 4, fair: 16 },
                approveTime: { elite: 10, good: 22, fair: 42 },
                mergeTime: { elite: 1, good: 3, fair: 16 },
                reviewTime: { elite: 3, good: 14, fair: 24 },
                cycleTime: { elite: 25, good: 72, fair: 161 }
            };

            const t = thresholds[metricType];
            if (!t || hours == null) return '';

            if (hours <= t.elite) return 'elite';
            if (hours <= t.good) return 'good';
            if (hours <= t.fair) return 'fair';
            return 'needs-focus';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
