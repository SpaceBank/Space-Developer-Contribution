<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Contribution - Space Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
        }

        .back-button {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #fff;
            font-size: 2.5rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .step.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .step.completed {
            background: rgba(34, 197, 94, 0.3);
            border: 1px solid #22c55e;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #a1a1aa;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6366f1;
        }

        input[type="password"] {
            font-family: monospace;
            letter-spacing: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        button.secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: none;
        }

        .repo-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .repo-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .repo-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .repo-item.selected {
            background: rgba(99, 102, 241, 0.2);
            border-left: 3px solid #6366f1;
        }

        .repo-item input[type="checkbox"] {
            width: auto;
            margin-right: 1rem;
            cursor: pointer;
        }

        .repo-info {
            flex: 1;
        }

        .repo-name {
            font-weight: 500;
            color: #fff;
        }

        .repo-fullname {
            font-size: 0.75rem;
            color: #a1a1aa;
            margin-top: 0.25rem;
        }

        .repo-badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-left: 0.5rem;
        }

        .repo-badge.private {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .selection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #6366f1;
        }

        .summary-card p {
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .chart-wrapper h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: #fff;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            color: #a1a1aa;
        }

        /* Parallel loading progress panel */
        .parallel-loading-panel {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .loading-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: #e4e4e7;
        }

        .loading-title .pulse-dot {
            width: 10px;
            height: 10px;
            background: #6366f1;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        .loading-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a78bfa);
            border-radius: 3px;
            transition: width 0.5s ease-out;
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-status-text {
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-status-text .current-action {
            color: #c4b5fd;
            font-weight: 500;
        }

        .repo-status-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .repo-status-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.875rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
            flex-wrap: wrap;
        }

        .repo-status-item.pending {
            opacity: 0.6;
        }

        .repo-status-item.loading {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
        }

        .repo-status-item.success {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }

        .repo-status-item.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .repo-status-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: transform 0.3s ease;
        }

        /* Pulse animation for loading states */
        .repo-status-item.loading .repo-status-icon {
            animation: iconPulse 1.5s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        /* Bounce animation for success */
        .repo-status-item.success .repo-status-icon {
            animation: iconBounce 0.6s ease-out;
        }

        @keyframes iconBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Shake animation for error */
        .repo-status-item.error .repo-status-icon {
            animation: iconShake 0.5s ease-out;
        }

        @keyframes iconShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        /* Special animations for specific loading stages */
        @keyframes downloadBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        @keyframes rotateAnalyze {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(4px); }
        }

        @keyframes prSlide {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(4px); }
        }

        /* Override animations for specific states */
        .repo-icon-cloning {
            animation: downloadBounce 1s ease-in-out infinite !important;
        }

        .repo-icon-analyzing {
            animation: rotateAnalyze 2s linear infinite !important;
        }

        .repo-icon-prs {
            animation: prSlide 1.2s ease-in-out infinite !important;
        }

        .repo-icon-starting {
            animation: iconPulse 1s ease-in-out infinite !important;
        }

        .repo-status-name {
            flex: 1;
            font-size: 0.875rem;
            color: #e4e4e7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 120px;
        }

        .repo-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .repo-status-item.pending .repo-status-badge {
            background: rgba(113, 113, 122, 0.2);
            color: #71717a;
        }

        .repo-status-item.loading .repo-status-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .repo-status-item.success .repo-status-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .repo-status-item.error .repo-status-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Mini progress bar for each repo */
        .repo-mini-progress {
            width: 100%;
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .repo-mini-progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .repo-mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 2px;
            transition: width 0.3s ease-out;
        }

        .repo-mini-progress.success .repo-mini-progress-fill {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }

        .repo-mini-progress.error .repo-mini-progress-fill {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .repo-progress-steps {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #71717a;
        }

        .repo-progress-step {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .repo-progress-step.active {
            opacity: 1;
            color: #fbbf24;
        }

        .repo-progress-step.complete {
            opacity: 1;
            color: #22c55e;
        }

        .repo-progress-step.error {
            opacity: 1;
            color: #ef4444;
        }

        .mini-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #fca5a5;
            margin-top: 1rem;
        }

        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #86efac;
            margin-top: 1rem;
        }

        .developer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .developer-table th,
        .developer-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .developer-table th {
            color: #a1a1aa;
            font-weight: 500;
        }

        .developer-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .hidden {
            display: none !important;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .repo-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.875rem;
            color: #e4e4e7;
        }

        .repo-tag .repo-icon {
            font-size: 0.75rem;
        }

        .dev-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.875rem;
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dev-chip:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .dev-chip.selected {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #86efac;
        }

        .dev-chip .dev-commits {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .token-hint {
            font-size: 0.75rem;
            color: #a1a1aa;
            margin-top: 0.5rem;
        }

        .token-hint a {
            color: #6366f1;
            text-decoration: none;
        }

        .token-hint a:hover {
            text-decoration: underline;
        }

        .provider-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .provider-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .provider-option:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .provider-option.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .provider-option .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">‚Üê Back to Home</a>

    <div class="container">
        <h1 style="margin-bottom: 1.5rem;">üìä Developer Contribution Dashboard</h1>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step2-indicator">
                <span class="step-number">1</span>
                <span>Select Repos</span>
            </div>
            <div class="step" id="step3-indicator">
                <span class="step-number">2</span>
                <span>View Report</span>
            </div>
        </div>

        <!-- Step 2: Repository Selection -->
        <div class="panel" id="step2-panel">
            <h2>üìÅ Select Repositories</h2>

            <a href="/" class="secondary" style="display: inline-block; margin-bottom: 1rem; text-decoration: none;">‚Üê Back to Home</a>

            <div class="search-box">
                <input type="text" id="repoSearch" placeholder="Search repositories..." oninput="filterRepos()">
            </div>

            <div class="selection-info">
                <span><strong id="selectedCount">0</strong> repositories selected</span>
                <div>
                    <button class="secondary" onclick="selectAll()">Select All</button>
                    <button class="secondary" onclick="deselectAll()">Deselect All</button>
                </div>
            </div>

            <div class="repo-list" id="repoList"></div>

            <div class="form-row" style="margin-top: 1rem;">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="period">Aggregation Period</label>
                    <select id="period">
                        <option value="DAILY">Daily</option>
                        <option value="WEEKLY" selected>Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-top: 1rem;">
                <div class="form-group">
                    <label for="branch">Branch</label>
                    <select id="branch">
                        <option value="">All Branches</option>
                        <option value="master">master</option>
                        <option value="main">main</option>
                        <option value="develop">develop</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: center; padding-top: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="excludeMerges" checked style="width: auto;">
                        <span>Exclude merge commits</span>
                    </label>
                    <span style="margin-left: 0.5rem; font-size: 0.75rem; color: #a1a1aa;" title="Like GitHub's default behavior">‚ÑπÔ∏è</span>
                </div>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="goToStep(1)">‚Üê Back</button>
                <button onclick="analyzeRepositories()" id="analyzeBtn" disabled>
                    <span>Analyze Selected Repositories</span>
                    <span>‚Üí</span>
                </button>
            </div>

            <div id="analyze-error" class="error hidden"></div>

            <!-- Parallel Loading Progress Panel -->
            <div id="parallel-loading-panel" class="parallel-loading-panel hidden">
                <div class="loading-header">
                    <div class="loading-title">
                        <div class="pulse-dot"></div>
                        <span>Analyzing Repositories in Parallel</span>
                    </div>
                    <span id="loading-progress-text" style="font-size: 0.875rem; color: #a1a1aa;">0 / 0 completed</span>
                </div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="loading-progress-fill" style="width: 0%"></div>
                </div>
                <div class="loading-status-text">
                    <span>Current:</span>
                    <span class="current-action" id="loading-current-action">Initializing...</span>
                </div>
                <div class="repo-status-list" id="repo-status-list">
                    <!-- Repo status items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="panel hidden" id="step3-panel">
            <h2>üìä Step 3: Contribution Report</h2>

            <div class="button-group" style="margin-bottom: 1rem;">
                <button class="secondary" onclick="goToStep(2)">‚Üê Back to Selection</button>
                <button class="secondary" onclick="goToStep(1)">üîÑ Start Over</button>
            </div>

            <!-- Analyzed Repositories Section -->
            <div class="analyzed-repos-section" id="analyzedReposSection" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                <h3 style="margin-bottom: 0.75rem; font-size: 1rem; color: #a1a1aa;">üìÅ Analyzed Repositories (<span id="analyzedRepoCount">0</span>)</h3>
                <div id="analyzedReposList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                <div id="dateRangeInfo" style="margin-top: 0.75rem; font-size: 0.875rem; color: #a1a1aa;"></div>
            </div>

            <!-- Developer Filter Section -->
            <div class="developer-filter-section" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <h3 style="font-size: 1rem; color: #a1a1aa;">üë• Filter by Developers (<span id="selectedDevCount">0</span>/<span id="totalDevCount">0</span> selected)</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="secondary" onclick="selectAllDevelopers()" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Select All</button>
                        <button class="secondary" onclick="deselectAllDevelopers()" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">Deselect All</button>
                    </div>
                </div>
                <div id="developerFilterList" style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 150px; overflow-y: auto;"></div>
            </div>

            <div class="summary-cards" id="summaryCards"></div>

            <div class="charts-container">
                <!-- Overall Activity Charts (not filtered by developer selection) -->
                <div class="chart-wrapper">
                    <h2>üìà Total Commits Over Time (All Developers)</h2>
                    <div class="chart-container">
                        <canvas id="totalCommitsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üèÜ Top Committers</h2>
                    <div class="chart-container">
                        <canvas id="topCommittersChart"></canvas>
                    </div>
                </div>

                <!-- Filtered by developer selection -->
                <div class="chart-wrapper">
                    <h2>üìà Commits Over Time (by Developer)</h2>
                    <div class="chart-container">
                        <canvas id="commitsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üîÄ PRs Merged Over Time</h2>
                    <div class="chart-container">
                        <canvas id="prsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üöÄ Top PR Authors</h2>
                    <div class="chart-container">
                        <canvas id="prAuthorsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üìä Lines of Code Changed</h2>
                    <div class="chart-container">
                        <canvas id="linesChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üë• Developer Contributions</h2>
                    <div class="chart-container">
                        <canvas id="developerPieChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üìã Developer Summary</h2>
                    <table class="developer-table">
                        <thead>
                            <tr>
                                <th>Developer</th>
                                <th>Nickname</th>
                                <th>Commits</th>
                                <th>Lines Added</th>
                                <th>Lines Deleted</th>
                                <th>Repositories</th>
                            </tr>
                        </thead>
                        <tbody id="developerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let selectedRepos = new Set();
        let commitsChart = null;
        let linesChart = null;
        let pieChart = null;
        let totalCommitsChart = null;
        let topCommittersChart = null;
        let prsChart = null;
        let prAuthorsChart = null;

        // Developer filter state
        let fullAnalysisData = null;  // Store the complete analysis data
        let selectedDevelopers = new Set();  // Selected developer emails for filtering

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login/nickname
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present (nicknames have @)
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            // Debug logging
            if (displayName && displayName !== loginOrNickname) {
                console.debug(`‚úÖ getDisplayName('${loginOrNickname}') -> '${displayName}'`);
            }

            return result;
        }

        /**
         * Get avatar URL for a contributor login/nickname
         * Uses session data to find avatar
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Create display name lookup map from session contributors
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });
                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                    console.log('üìã Sample displayNameMap:', Object.entries(window.displayNameMap).slice(0, 5));
                }

                // Auto-load repositories from session
                if (sessionData.repositories && sessionData.repositories.length > 0) {
                    repositories = sessionData.repositories.map(r => ({
                        fullName: r.fullName,
                        name: r.name || r.fullName.split('/').pop(),
                        isPrivate: r.private || false
                    }));
                    renderRepositoryList();
                    currentStep = 1;
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Step navigation
        function goToStep(step) {
            currentStep = step;

            document.getElementById('step2-panel').classList.toggle('hidden', step !== 1 && step !== 2);
            document.getElementById('step3-panel').classList.toggle('hidden', step !== 3);

            // Update step indicators (only 2 steps: Select Repos and View Report)
            document.getElementById('step2-indicator').classList.toggle('active', step === 1 || step === 2);
            document.getElementById('step2-indicator').classList.toggle('completed', step > 2);
            document.getElementById('step3-indicator').classList.toggle('active', step === 3);
        }

        // Fetch repositories
        async function fetchRepositories() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                showError('auth-error', 'Please enter your access token');
                return;
            }

            hideError('auth-error');
            showLoading('auth-loading');

            try {
                const response = await fetch('/api/git/repositories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: document.getElementById('baseUrl').value || null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch repositories. Check your token.');
                }

                const data = await response.json();
                repositories = data.repositories;
                selectedRepos.clear();

                renderRepositoryList();
                hideLoading('auth-loading');
                goToStep(2);

            } catch (error) {
                hideLoading('auth-loading');
                showError('auth-error', error.message);
            }
        }

        // Render repository list
        function renderRepositoryList(filter = '') {
            const container = document.getElementById('repoList');
            const filtered = repositories.filter(repo =>
                repo.fullName.toLowerCase().includes(filter.toLowerCase()) ||
                repo.name.toLowerCase().includes(filter.toLowerCase())
            );

            container.innerHTML = filtered.map(repo => `
                <div class="repo-item ${selectedRepos.has(repo.fullName) ? 'selected' : ''}"
                     onclick="toggleRepo('${repo.fullName}')">
                    <input type="checkbox" ${selectedRepos.has(repo.fullName) ? 'checked' : ''}
                           onclick="event.stopPropagation(); toggleRepo('${repo.fullName}')">
                    <div class="repo-info">
                        <div class="repo-name">
                            ${repo.name}
                            ${repo.isPrivate ? '<span class="repo-badge private">Private</span>' : ''}
                        </div>
                        <div class="repo-fullname">${repo.fullName}</div>
                    </div>
                </div>
            `).join('');

            updateSelectionCount();
        }

        function filterRepos() {
            const filter = document.getElementById('repoSearch').value;
            renderRepositoryList(filter);
        }

        function toggleRepo(fullName) {
            if (selectedRepos.has(fullName)) {
                selectedRepos.delete(fullName);
            } else {
                selectedRepos.add(fullName);
            }
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function selectAll() {
            const filter = document.getElementById('repoSearch').value.toLowerCase();
            repositories.forEach(repo => {
                if (repo.fullName.toLowerCase().includes(filter) || repo.name.toLowerCase().includes(filter)) {
                    selectedRepos.add(repo.fullName);
                }
            });
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function deselectAll() {
            selectedRepos.clear();
            renderRepositoryList(document.getElementById('repoSearch').value);
        }

        function updateSelectionCount() {
            document.getElementById('selectedCount').textContent = selectedRepos.size;
            document.getElementById('analyzeBtn').disabled = selectedRepos.size === 0;
        }

        // Repository status tracking for parallel loading
        let repoStatuses = {};
        let completedCount = 0;
        let totalRepoCount = 0;
        let allRepoResults = [];
        let loadingStartTime = null;

        // Logging helper
        function log(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const prefix = `[${timestamp}] [${level.toUpperCase()}]`;
            if (data) {
                console[level](`${prefix} ${message}`, data);
            } else {
                console[level](`${prefix} ${message}`);
            }
        }

        // Initialize parallel loading UI
        function initParallelLoading(repoList) {
            repoStatuses = {};
            completedCount = 0;
            totalRepoCount = repoList.length;
            allRepoResults = [];
            loadingStartTime = Date.now();

            log('info', `üöÄ Starting parallel analysis of ${repoList.length} repositories`);
            log('info', 'Repositories:', repoList);

            const panel = document.getElementById('parallel-loading-panel');
            const statusList = document.getElementById('repo-status-list');

            // Build status list with mini progress bars for each repo
            statusList.innerHTML = repoList.map(repo => {
                const safeId = repo.replace(/[^a-zA-Z0-9]/g, '_');
                return `
                <div class="repo-status-item pending" id="repo-status-${safeId}">
                    <div class="repo-status-icon">‚è≥</div>
                    <div class="repo-status-name">${repo}</div>
                    <div class="repo-status-detail" id="repo-detail-${safeId}" style="font-size: 0.7rem; color: #71717a; margin-left: auto; margin-right: 0.5rem;"></div>
                    <div class="repo-status-badge" id="repo-badge-${safeId}">Queued</div>

                    <!-- Mini progress bar for this repo -->
                    <div class="repo-mini-progress" id="repo-progress-${safeId}">
                        <div class="repo-mini-progress-bar">
                            <div class="repo-mini-progress-fill" id="repo-progress-fill-${safeId}" style="width: 0%"></div>
                        </div>
                        <div class="repo-progress-steps">
                            <span class="repo-progress-step" id="step-init-${safeId}">üìã Init</span>
                            <span class="repo-progress-step" id="step-clone-${safeId}">üì• Clone</span>
                            <span class="repo-progress-step" id="step-analyze-${safeId}">üîç Analyze</span>
                            <span class="repo-progress-step" id="step-prs-${safeId}">üîÄ PRs</span>
                            <span class="repo-progress-step" id="step-done-${safeId}">‚úÖ Done</span>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Initialize statuses with step tracking
            repoList.forEach(repo => {
                repoStatuses[repo] = {
                    status: 'pending',
                    startTime: null,
                    detail: '',
                    currentStep: 0,  // 0=pending, 1=init, 2=clone, 3=analyze, 4=prs, 5=done
                    steps: ['init', 'clone', 'analyze', 'prs', 'done']
                };
            });

            // Show panel and start timer
            panel.classList.remove('hidden');
            startProgressTimer();
            updateProgressBar();
            updateCurrentAction('Initializing parallel requests...');
        }

        // Update mini progress bar for a repo
        function updateRepoProgress(repoName, stepIndex, stepStatus = 'active') {
            const safeId = repoName.replace(/[^a-zA-Z0-9]/g, '_');
            const progressFill = document.getElementById(`repo-progress-fill-${safeId}`);
            const progressContainer = document.getElementById(`repo-progress-${safeId}`);

            if (!progressFill || !repoStatuses[repoName]) return;

            const steps = repoStatuses[repoName].steps;
            const totalSteps = steps.length;

            // Update progress bar fill (each step = 20%)
            const percent = Math.min((stepIndex / totalSteps) * 100, 100);
            progressFill.style.width = `${percent}%`;

            // Update step indicators
            steps.forEach((step, idx) => {
                const stepEl = document.getElementById(`step-${step}-${safeId}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'complete', 'error');
                    if (idx < stepIndex) {
                        stepEl.classList.add('complete');
                    } else if (idx === stepIndex && stepStatus === 'active') {
                        stepEl.classList.add('active');
                    } else if (idx === stepIndex && stepStatus === 'error') {
                        stepEl.classList.add('error');
                    }
                }
            });

            // Update progress bar color on completion
            if (stepStatus === 'complete' && stepIndex >= totalSteps) {
                progressContainer.classList.add('success');
            } else if (stepStatus === 'error') {
                progressContainer.classList.add('error');
            }

            repoStatuses[repoName].currentStep = stepIndex;
        }

        // Update repository status with detailed info
        function updateRepoStatus(repoName, status, detail = null, extraInfo = null) {
            const safeId = repoName.replace(/[^a-zA-Z0-9]/g, '_');
            const item = document.getElementById(`repo-status-${safeId}`);
            const detailEl = document.getElementById(`repo-detail-${safeId}`);

            if (!item) {
                log('warn', `Could not find status element for: ${repoName}`);
                return;
            }

            // Track status
            if (!repoStatuses[repoName]) {
                repoStatuses[repoName] = { status: 'pending', startTime: null, detail: '' };
            }

            const wasCompleted = repoStatuses[repoName].status === 'success' || repoStatuses[repoName].status === 'error';
            const isNowCompleted = status === 'success' || status === 'error';

            repoStatuses[repoName].status = status;
            repoStatuses[repoName].detail = detail || '';

            if (!repoStatuses[repoName].startTime && status !== 'pending') {
                repoStatuses[repoName].startTime = Date.now();
            }

            // Log the status change
            const emoji = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : 'üîÑ';
            log('info', `${emoji} [${repoName}] ${status.toUpperCase()}: ${detail || ''}`);
            if (extraInfo) {
                log('info', `   ‚îî‚îÄ Details:`, extraInfo);
            }

            // Remove all status classes
            item.classList.remove('pending', 'loading', 'success', 'error');

            const icon = item.querySelector('.repo-status-icon');
            const badge = item.querySelector('.repo-status-badge');

            // Remove all animation classes
            icon.classList.remove('repo-icon-starting', 'repo-icon-cloning', 'repo-icon-analyzing', 'repo-icon-prs');

            switch (status) {
                case 'pending':
                    item.classList.add('pending');
                    icon.innerHTML = '‚è≥';
                    badge.textContent = 'Queued';
                    updateRepoProgress(repoName, 0, 'pending');
                    break;
                case 'starting':
                    item.classList.add('loading');
                    icon.innerHTML = 'üöÄ';
                    icon.classList.add('repo-icon-starting');
                    badge.textContent = 'Starting...';
                    updateRepoProgress(repoName, 1, 'active');  // Step 1: Init
                    break;
                case 'cloning':
                    item.classList.add('loading');
                    icon.innerHTML = 'üì•';
                    icon.classList.add('repo-icon-cloning');
                    badge.textContent = 'Cloning repo...';
                    if (detailEl) detailEl.textContent = 'Downloading repository files';
                    updateRepoProgress(repoName, 2, 'active');  // Step 2: Clone
                    break;
                case 'analyzing':
                    item.classList.add('loading');
                    icon.innerHTML = 'üîç';
                    icon.classList.add('repo-icon-analyzing');
                    badge.textContent = 'Analyzing commits...';
                    if (detailEl) detailEl.textContent = detail || 'Reading git history';
                    updateRepoProgress(repoName, 3, 'active');  // Step 3: Analyze
                    break;
                case 'fetching-prs':
                    item.classList.add('loading');
                    icon.innerHTML = 'üîÄ';
                    icon.classList.add('repo-icon-prs');
                    badge.textContent = 'Fetching PRs...';
                    if (detailEl) detailEl.textContent = 'Loading merged pull requests';
                    updateRepoProgress(repoName, 4, 'active');  // Step 4: PRs
                    break;
                case 'processing':
                    item.classList.add('loading');
                    icon.innerHTML = '‚öôÔ∏è';
                    badge.textContent = detail || 'Processing...';
                    break;
                case 'success':
                    item.classList.add('success');
                    icon.innerHTML = '‚úÖ';
                    badge.textContent = detail || 'Complete';
                    if (detailEl) {
                        const elapsed = repoStatuses[repoName].startTime
                            ? ((Date.now() - repoStatuses[repoName].startTime) / 1000).toFixed(1) + 's'
                            : '';
                        detailEl.textContent = elapsed;
                    }
                    updateRepoProgress(repoName, 5, 'complete');  // Step 5: Done
                    if (!wasCompleted && isNowCompleted) {
                        completedCount++;
                        log('info', `üìä Progress: ${completedCount}/${totalRepoCount} repositories completed`);
                    }
                    break;
                case 'error':
                    item.classList.add('error');
                    icon.innerHTML = '‚ùå';
                    badge.textContent = detail || 'Failed';
                    if (detailEl) detailEl.textContent = 'Error';
                    updateRepoProgress(repoName, repoStatuses[repoName].currentStep || 1, 'error');
                    if (!wasCompleted && isNowCompleted) {
                        completedCount++;
                    }
                    break;
            }

            updateProgressBar();
        }

        // Update progress bar with percentage
        function updateProgressBar() {
            const fill = document.getElementById('loading-progress-fill');
            const text = document.getElementById('loading-progress-text');

            // Calculate progress based on completed repos
            const percent = totalRepoCount > 0 ? (completedCount / totalRepoCount) * 100 : 0;

            fill.style.width = `${percent}%`;
            text.textContent = `${completedCount} / ${totalRepoCount} completed (${Math.round(percent)}%)`;

            // Calculate elapsed time
            if (loadingStartTime) {
                const elapsed = ((Date.now() - loadingStartTime) / 1000).toFixed(0);
                if (elapsed > 0) {
                    text.textContent += ` ‚Ä¢ ${elapsed}s`;
                }
            }
        }

        // Timer interval for updating elapsed time
        let progressTimerInterval = null;

        function startProgressTimer() {
            if (progressTimerInterval) clearInterval(progressTimerInterval);
            progressTimerInterval = setInterval(() => {
                updateProgressBar();
            }, 1000);
        }

        function stopProgressTimer() {
            if (progressTimerInterval) {
                clearInterval(progressTimerInterval);
                progressTimerInterval = null;
            }
        }

        // Update current action text
        function updateCurrentAction(text) {
            document.getElementById('loading-current-action').textContent = text;
            log('info', `üîÑ Current action: ${text}`);
        }

        // Hide parallel loading panel
        function hideParallelLoading() {
            stopProgressTimer();
            const totalTime = loadingStartTime ? ((Date.now() - loadingStartTime) / 1000).toFixed(2) : 0;
            log('info', `\n‚úÖ Loading panel hidden. Total loading time: ${totalTime}s`);
            document.getElementById('parallel-loading-panel').classList.add('hidden');
        }

        // Merge multiple analysis results into one
        function mergeAnalysisResults(results) {
            if (results.length === 0) return null;
            if (results.length === 1) return results[0];

            // Merge developers by authorName
            const developerMap = new Map();

            results.forEach(result => {
                result.developers.forEach(dev => {
                    const key = dev.authorName;
                    if (developerMap.has(key)) {
                        const existing = developerMap.get(key);
                        // Merge data points
                        const mergedDataPoints = existing.dataPoints.map((dp, idx) => {
                            const otherDp = dev.dataPoints[idx] || { commits: 0, linesAdded: 0, linesDeleted: 0, filesChanged: 0 };
                            return {
                                ...dp,
                                commits: dp.commits + otherDp.commits,
                                linesAdded: dp.linesAdded + otherDp.linesAdded,
                                linesDeleted: dp.linesDeleted + otherDp.linesDeleted,
                                filesChanged: dp.filesChanged + otherDp.filesChanged
                            };
                        });
                        developerMap.set(key, {
                            ...existing,
                            dataPoints: mergedDataPoints,
                            emails: new Set([...existing.emails, ...dev.emails]),
                            repositories: new Set([...existing.repositories, ...dev.repositories])
                        });
                    } else {
                        developerMap.set(key, {
                            ...dev,
                            emails: new Set(dev.emails),
                            repositories: new Set(dev.repositories)
                        });
                    }
                });
            });

            // Convert Sets back to arrays and compute total commits for sorting
            const mergedDevelopers = Array.from(developerMap.values()).map(dev => ({
                ...dev,
                emails: Array.from(dev.emails),
                repositories: Array.from(dev.repositories)
            })).sort((a, b) => {
                const totalA = a.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const totalB = b.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                return totalB - totalA;
            });

            // Merge PR counts
            const mergedPRCounts = results[0].prCountByPeriod.map((_, idx) =>
                results.reduce((sum, r) => sum + (r.prCountByPeriod[idx] || 0), 0)
            );

            // Merge PR author stats
            const prAuthorMap = new Map();
            results.forEach(result => {
                (result.prAuthorStats || []).forEach(stat => {
                    if (prAuthorMap.has(stat.authorName)) {
                        prAuthorMap.set(stat.authorName, prAuthorMap.get(stat.authorName) + stat.prCount);
                    } else {
                        prAuthorMap.set(stat.authorName, stat.prCount);
                    }
                });
            });
            const mergedPRAuthorStats = Array.from(prAuthorMap.entries())
                .map(([authorName, prCount]) => ({ authorName, prCount }))
                .sort((a, b) => b.prCount - a.prCount);

            // Merge summaries
            const mergedSummary = {
                totalDevelopers: mergedDevelopers.length,
                totalCommits: results.reduce((sum, r) => sum + r.summary.totalCommits, 0),
                totalLinesAdded: results.reduce((sum, r) => sum + r.summary.totalLinesAdded, 0),
                totalLinesDeleted: results.reduce((sum, r) => sum + r.summary.totalLinesDeleted, 0),
                totalPRs: results.reduce((sum, r) => sum + (r.summary.totalPRs || 0), 0),
                mostActiveAuthor: mergedDevelopers[0]?.authorName || null,
                mostActiveRepository: null
            };

            return {
                analyzedRepositories: results.flatMap(r => r.analyzedRepositories),
                dateRange: results[0].dateRange,
                period: results[0].period,
                developers: mergedDevelopers,
                summary: mergedSummary,
                prCountByPeriod: mergedPRCounts,
                prAuthorStats: mergedPRAuthorStats
            };
        }

        // Analyze repositories in PARALLEL
        async function analyzeRepositories() {
            if (selectedRepos.size === 0) {
                showError('analyze-error', 'Please select at least one repository');
                return;
            }

            hideError('analyze-error');

            const sessionData = getSessionData();
            const token = sessionData?.token || '';
            const startDate = document.getElementById('startDate').value || null;
            const endDate = document.getElementById('endDate').value || null;
            const period = document.getElementById('period').value;
            const branch = document.getElementById('branch').value || null;
            const excludeMerges = document.getElementById('excludeMerges').checked;

            const repoList = Array.from(selectedRepos);

            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üöÄ STARTING REPOSITORY ANALYSIS');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', `Provider: ${selectedProvider}`);
            log('info', `Date Range: ${startDate || 'default'} to ${endDate || 'default'}`);
            log('info', `Period: ${period}`);
            log('info', `Branch: ${branch || 'all branches'}`);
            log('info', `Exclude merges: ${excludeMerges}`);
            log('info', `Total repositories: ${repoList.length}`);

            // Initialize parallel loading UI
            initParallelLoading(repoList);
            document.getElementById('analyzeBtn').disabled = true;

            // Create promises for all repositories with detailed progress simulation
            const analyzePromises = repoList.map(async (repoFullName) => {
                const repoStartTime = Date.now();

                log('info', `\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
                log('info', `‚îÇ üì¶ Starting: ${repoFullName}`);
                log('info', `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);

                // Stage 1: Starting/Init
                updateRepoStatus(repoFullName, 'starting', 'Initializing...');
                updateCurrentAction(`Starting analysis for ${repoFullName}...`);

                // Small delay to show the starting state
                await new Promise(r => setTimeout(r, 150));

                // Stage 2: Cloning
                updateRepoStatus(repoFullName, 'cloning', 'Downloading repository...');
                log('info', `‚îÇ üì• [${repoFullName}] Cloning repository...`);

                try {
                    // Make the API call
                    log('info', `‚îÇ üåê [${repoFullName}] Sending API request to /api/git/analyze/single`);

                    const requestBody = {
                        token: token,
                        provider: selectedProvider,
                        baseUrl: sessionData?.baseUrl || null,
                        repositoryFullName: repoFullName,
                        startDate: startDate,
                        endDate: endDate,
                        period: period,
                        branch: branch,
                        excludeMerges: excludeMerges
                    };

                    log('info', `‚îÇ üì§ [${repoFullName}] Request payload:`, {
                        ...requestBody,
                        token: token ? `${token.substring(0, 8)}...` : 'none'
                    });

                    // Start simulated progress stages while waiting for API
                    let progressSimulator = null;
                    let currentSimStage = 2; // Start at cloning

                    // Simulate progress through stages every 2 seconds
                    progressSimulator = setInterval(() => {
                        currentSimStage++;
                        if (currentSimStage === 3) {
                            updateRepoStatus(repoFullName, 'analyzing', 'Reading git history...');
                        } else if (currentSimStage === 4) {
                            updateRepoStatus(repoFullName, 'fetching-prs', 'Loading PRs...');
                        }
                        // Stop simulating after stage 4
                        if (currentSimStage >= 4) {
                            clearInterval(progressSimulator);
                        }
                    }, 2500);

                    const response = await fetch('/api/git/analyze/single', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    // Stop progress simulation
                    if (progressSimulator) clearInterval(progressSimulator);

                    log('info', `‚îÇ üì® [${repoFullName}] Response status: ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        log('error', `‚îÇ ‚ùå [${repoFullName}] API Error:`, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                    }

                    // Final stage: Processing response
                    updateRepoStatus(repoFullName, 'fetching-prs', 'Finalizing...');

                    const data = await response.json();

                    const elapsed = ((Date.now() - repoStartTime) / 1000).toFixed(2);
                    const commits = data.summary?.totalCommits || 0;
                    const devs = data.developers?.length || 0;
                    const prs = data.summary?.totalPRs || 0;

                    log('info', `‚îÇ ‚úÖ [${repoFullName}] Analysis complete in ${elapsed}s`);
                    log('info', `‚îÇ    ‚îî‚îÄ Commits: ${commits}, Developers: ${devs}, PRs: ${prs}`);

                    updateRepoStatus(repoFullName, 'success', `${commits} commits, ${prs} PRs`, {
                        commits, developers: devs, prs, elapsed
                    });

                    return { success: true, data, repoFullName, elapsed };

                } catch (error) {
                    const elapsed = ((Date.now() - repoStartTime) / 1000).toFixed(2);
                    log('error', `‚îÇ ‚ùå [${repoFullName}] Failed after ${elapsed}s: ${error.message}`);

                    updateRepoStatus(repoFullName, 'error', error.message.substring(0, 30));
                    return { success: false, error: error.message, repoFullName, elapsed };
                }
            });

            // Wait for all to complete (parallel execution)
            log('info', '\n‚è≥ Waiting for all parallel requests to complete...');
            updateCurrentAction(`Analyzing ${repoList.length} repositories in parallel...`);

            const results = await Promise.all(analyzePromises);

            // Filter successful results
            const successfulResults = results.filter(r => r.success).map(r => r.data);
            const failedRepos = results.filter(r => !r.success);

            const totalElapsed = ((Date.now() - loadingStartTime) / 1000).toFixed(2);

            log('info', '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üìä ANALYSIS COMPLETE');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', `Total time: ${totalElapsed}s`);
            log('info', `Successful: ${successfulResults.length}/${repoList.length}`);
            log('info', `Failed: ${failedRepos.length}/${repoList.length}`);

            if (failedRepos.length > 0) {
                log('warn', 'Failed repositories:', failedRepos.map(r => `${r.repoFullName}: ${r.error}`));
            }

            if (successfulResults.length === 0) {
                hideParallelLoading();
                document.getElementById('analyzeBtn').disabled = false;
                showError('analyze-error', 'Failed to analyze any repositories. Please check your permissions and try again.');
                return;
            }

            // Merge all results
            updateCurrentAction('Merging results from all repositories...');
            log('info', 'üîÄ Merging results from all repositories...');

            const mergedData = mergeAnalysisResults(successfulResults);

            log('info', 'üìà Merged data summary:', {
                totalCommits: mergedData.summary.totalCommits,
                totalDevelopers: mergedData.summary.totalDevelopers,
                totalPRs: mergedData.summary.totalPRs,
                repositories: mergedData.analyzedRepositories.length
            });

            // Brief delay to show completion
            await new Promise(resolve => setTimeout(resolve, 500));

            hideParallelLoading();
            document.getElementById('analyzeBtn').disabled = false;

            if (failedRepos.length > 0) {
                console.warn('Some repositories failed to analyze:', failedRepos);
            }

            displayResults(mergedData);
            goToStep(3);
        }

        // Display results
        function displayResults(data) {
            // Store full data for filtering
            fullAnalysisData = data;

            // Initialize selected developers with all developers (use name as key since we group by name)
            selectedDevelopers = new Set(data.developers.map(d => d.authorName));

            // Show analyzed repositories
            const reposList = document.getElementById('analyzedReposList');
            const repoCount = document.getElementById('analyzedRepoCount');
            const dateRangeInfo = document.getElementById('dateRangeInfo');

            repoCount.textContent = data.analyzedRepositories.length;
            reposList.innerHTML = data.analyzedRepositories.map(repo => `
                <span class="repo-tag">
                    <span class="repo-icon">üì¶</span>
                    ${repo}
                </span>
            `).join('');

            // Show date range and period
            const periodLabels = { 'DAILY': 'Daily', 'WEEKLY': 'Weekly', 'MONTHLY': 'Monthly' };
            dateRangeInfo.innerHTML = `
                <span>üìÖ Date Range: <strong>${data.dateRange.startDate}</strong> to <strong>${data.dateRange.endDate}</strong></span>
                <span style="margin-left: 1rem;">üìä Aggregation: <strong>${periodLabels[data.period] || data.period}</strong></span>
            `;

            // Render developer filter chips
            renderDeveloperFilter(data.developers);

            // Render overall charts (not affected by developer filter)
            renderOverallCharts(data.developers);

            // Render charts with all developers initially
            renderChartsAndTable(data.developers);
        }

        // Render overall charts that show all data regardless of developer filter
        function renderOverallCharts(allDevelopers) {
            if (allDevelopers.length === 0) return;

            const labels = allDevelopers[0]?.dataPoints.map(dp => dp.period) || [];
            const colors = generateColors(allDevelopers.length);

            // 1. Total Commits Over Time (aggregate all developers)
            const totalCommitsByPeriod = labels.map((_, periodIndex) =>
                allDevelopers.reduce((sum, dev) => sum + dev.dataPoints[periodIndex].commits, 0)
            );

            if (totalCommitsChart) totalCommitsChart.destroy();
            totalCommitsChart = new Chart(document.getElementById('totalCommitsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Commits',
                        data: totalCommitsByPeriod,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...chartOptions(),
                    plugins: {
                        ...chartOptions().plugins,
                        legend: { display: false }
                    }
                }
            });

            // 2. Top Committers (horizontal bar chart)
            const developerCommits = allDevelopers.map(dev => ({
                name: getDisplayName(dev.authorName),
                commits: dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0)
            })).sort((a, b) => b.commits - a.commits).slice(0, 10); // Top 10

            if (topCommittersChart) topCommittersChart.destroy();
            topCommittersChart = new Chart(document.getElementById('topCommittersChart'), {
                type: 'bar',
                data: {
                    labels: developerCommits.map(d => d.name),
                    datasets: [{
                        label: 'Commits',
                        data: developerCommits.map(d => d.commits),
                        backgroundColor: colors.slice(0, developerCommits.length),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#e4e4e7',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return developerCommits[context[0].dataIndex].name;
                                },
                                label: function(context) {
                                    return `Commits: ${context.parsed.x}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#e4e4e7' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // 3. PRs Merged Over Time - use data from backend
            const prData = fullAnalysisData.prCountByPeriod || labels.map(() => 0);
            const hasPRData = prData.some(v => v > 0);
            const totalPRs = prData.reduce((a, b) => a + b, 0);

            if (prsChart) prsChart.destroy();
            prsChart = new Chart(document.getElementById('prsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Merged PRs',
                        data: prData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...chartOptions(),
                    plugins: {
                        ...chartOptions().plugins,
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Total Merged PRs: ${totalPRs}`,
                            color: '#22c55e',
                            font: { size: 14 }
                        }
                    }
                }
            });

            // 4. PR Authors (horizontal bar chart)
            const prAuthorStats = fullAnalysisData.prAuthorStats || [];
            const topPRAuthors = prAuthorStats.slice(0, 10); // Top 10 PR authors

            if (prAuthorsChart) prAuthorsChart.destroy();

            if (topPRAuthors.length > 0) {
                prAuthorsChart = new Chart(document.getElementById('prAuthorsChart'), {
                    type: 'bar',
                    data: {
                        labels: topPRAuthors.map(a => getDisplayName(a.authorName)),
                        datasets: [{
                            label: 'PRs Merged',
                            data: topPRAuthors.map(a => a.prCount),
                            backgroundColor: topPRAuthors.map((_, i) => {
                                const hue = (i * 137.5) % 360;
                                return `hsla(${hue}, 70%, 60%, 0.8)`;
                            }),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `${prAuthorStats.length} developers opened PRs`,
                                color: '#a1a1aa',
                                font: { size: 12 }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#e4e4e7',
                                borderColor: '#22c55e',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return getDisplayName(topPRAuthors[context[0].dataIndex].authorName);
                                    },
                                    label: function(context) {
                                        return `PRs Merged: ${context.parsed.x}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#a1a1aa', stepSize: 1 },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                title: { display: true, text: 'Number of PRs', color: '#a1a1aa' }
                            },
                            y: { ticks: { color: '#e4e4e7' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            } else {
                // No PR data - show a message
                const canvas = document.getElementById('prAuthorsChart');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#71717a';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No PR data available', canvas.width / 2, canvas.height / 2);
            }
        }

        // Render developer filter chips
        function renderDeveloperFilter(developers) {
            const container = document.getElementById('developerFilterList');
            document.getElementById('totalDevCount').textContent = developers.length;

            container.innerHTML = developers.map(dev => {
                const totalCommits = dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const displayName = getDisplayName(dev.authorName);
                const avatarUrl = getAvatarUrl(dev.authorName);
                const isSelected = selectedDevelopers.has(dev.authorName);
                const escapedName = dev.authorName.replace(/'/g, "\\'");
                return `
                    <div class="dev-chip ${isSelected ? 'selected' : ''}"
                         onclick="toggleDeveloper('${escapedName}')"
                         title="${displayName} - ${totalCommits} commits">
                        ${avatarUrl
                            ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid #6366f1;">`
                            : '<span style="font-size: 1.2em;">üë§</span>'
                        }
                        <span>${displayName}</span>
                        <span class="dev-commits">${totalCommits} commits</span>
                    </div>
                `;
            }).join('');

            updateSelectedDevCount();
        }

        // Toggle developer selection
        function toggleDeveloper(name) {
            if (selectedDevelopers.has(name)) {
                selectedDevelopers.delete(name);
            } else {
                selectedDevelopers.add(name);
            }

            // Re-render filter chips
            renderDeveloperFilter(fullAnalysisData.developers);

            // Re-render charts with filtered developers
            const filteredDevelopers = fullAnalysisData.developers.filter(d => selectedDevelopers.has(d.authorName));
            renderChartsAndTable(filteredDevelopers);
        }

        // Select all developers
        function selectAllDevelopers() {
            selectedDevelopers = new Set(fullAnalysisData.developers.map(d => d.authorName));
            renderDeveloperFilter(fullAnalysisData.developers);
            renderChartsAndTable(fullAnalysisData.developers);
        }

        // Deselect all developers
        function deselectAllDevelopers() {
            selectedDevelopers.clear();
            renderDeveloperFilter(fullAnalysisData.developers);
            renderChartsAndTable([]);
        }

        // Update selected developer count
        function updateSelectedDevCount() {
            document.getElementById('selectedDevCount').textContent = selectedDevelopers.size;
        }

        // Render charts and table with given developers
        function renderChartsAndTable(developers) {
            // Summary cards - calculate from filtered developers
            const totalCommits = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.commits, 0), 0);
            const totalLinesAdded = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.linesAdded, 0), 0);
            const totalLinesDeleted = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.linesDeleted, 0), 0);

            const summaryHtml = `
                <div class="summary-card">
                    <h3>${developers.length}</h3>
                    <p>Developers</p>
                </div>
                <div class="summary-card">
                    <h3>${totalCommits}</h3>
                    <p>Total Commits</p>
                </div>
                <div class="summary-card">
                    <h3>${totalLinesAdded.toLocaleString()}</h3>
                    <p>Lines Added</p>
                </div>
                <div class="summary-card">
                    <h3>${totalLinesDeleted.toLocaleString()}</h3>
                    <p>Lines Deleted</p>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHtml;

            if (developers.length === 0) {
                document.getElementById('developerTableBody').innerHTML = '<tr><td colspan="6">No developers selected</td></tr>';
                // Clear charts
                return;
            }

            const labels = developers[0]?.dataPoints.map(dp => dp.period) || [];
            const colors = generateColors(developers.length);

            // Commits chart
            if (commitsChart) commitsChart.destroy();
            commitsChart = new Chart(document.getElementById('commitsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: developers.map((dev, i) => ({
                        label: getDisplayName(dev.authorName),
                        data: dev.dataPoints.map(dp => dp.commits),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions()
            });

            // Lines chart
            if (linesChart) linesChart.destroy();
            linesChart = new Chart(document.getElementById('linesChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: developers.map((dev, i) => ({
                        label: getDisplayName(dev.authorName),
                        data: dev.dataPoints.map(dp => dp.linesAdded),
                        backgroundColor: colors[i],
                        stack: 'added'
                    }))
                },
                options: { ...chartOptions(), scales: { x: { stacked: true, ...chartOptions().scales.x }, y: { stacked: true, ...chartOptions().scales.y } } }
            });

            // Pie chart
            if (pieChart) pieChart.destroy();
            const commitTotals = developers.map(dev => dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0));
            pieChart = new Chart(document.getElementById('developerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: developers.map(dev => getDisplayName(dev.authorName)),
                    datasets: [{ data: commitTotals, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#e4e4e7' } } }
                }
            });

            // Developer table
            document.getElementById('developerTableBody').innerHTML = developers.map(dev => {
                const commits = dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const added = dev.dataPoints.reduce((sum, dp) => sum + dp.linesAdded, 0);
                const deleted = dev.dataPoints.reduce((sum, dp) => sum + dp.linesDeleted, 0);
                const displayName = getDisplayName(dev.authorName);
                const avatarUrl = getAvatarUrl(dev.authorName);

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${avatarUrl
                                    ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #6366f1;">`
                                    : '<span style="font-size: 1.5em;">üë§</span>'
                                }
                                <span style="font-weight: 500;">${displayName}</span>
                            </div>
                        </td>
                        <td>${dev.authorName}</td>
                        <td>${commits}</td>
                        <td style="color: #22c55e;">+${added.toLocaleString()}</td>
                        <td style="color: #ef4444;">-${deleted.toLocaleString()}</td>
                        <td>${Array.from(dev.repositories).join(', ')}</td>
                    </tr>
                `;
            }).join('');
        }

        // Utilities
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4',
                '#0ea5e9', '#3b82f6'
            ];
            return colors.slice(0, count);
        }

        function chartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { labels: { color: '#e4e4e7' } },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            };
        }

        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>
</html>

