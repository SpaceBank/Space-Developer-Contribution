<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Contribution - Space Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #12122e 40%, #1a1a3e 70%, #0f0f2a 100%);
        }

        /* Hide back button when in iframe */
        body.in-iframe .back-home-btn {
            display: none !important;
        }

        body.in-iframe .container {
            padding-top: 1rem;
        }

        /* Parallel loading progress panel */
        .parallel-loading-panel {
            margin-top: var(--space-xl);
            padding: var(--space-xl);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            animation: fadeIn 0.3s ease-out;
        }

        .loading-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
        }

        .loading-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .loading-title .pulse-dot {
            width: 10px;
            height: 10px;
            background: var(--color-primary);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: var(--space-lg);
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent), var(--color-accent-light));
            border-radius: 3px;
            transition: width 0.5s ease-out;
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        .loading-status-text {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .loading-status-text .current-action {
            color: var(--color-accent-light);
            font-weight: 500;
        }

        .repo-status-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-height: 300px;
            overflow-y: auto;
        }

        .repo-status-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.875rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            flex-wrap: wrap;
            border-left: 3px solid transparent;
        }

        .repo-status-item.pending { opacity: 0.6; }
        .repo-status-item.loading { background: var(--color-warning-bg); border-left-color: var(--color-warning); }
        .repo-status-item.success { background: var(--color-success-bg); border-left-color: var(--color-success); }
        .repo-status-item.error { background: var(--color-danger-bg); border-left-color: var(--color-danger); }

        .repo-status-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .repo-status-item.loading .repo-status-icon { animation: pulse 1.5s ease-in-out infinite; }
        .repo-status-item.success .repo-status-icon { animation: iconBounce 0.6s ease-out; }
        .repo-status-item.error .repo-status-icon { animation: iconShake 0.5s ease-out; }

        @keyframes iconBounce { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes iconShake { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-3px); } 50% { transform: translateX(3px); } }

        .repo-icon-cloning { animation: downloadBounce 1s ease-in-out infinite !important; }
        .repo-icon-analyzing { animation: rotateAnalyze 2s linear infinite !important; }
        .repo-icon-prs { animation: prSlide 1.2s ease-in-out infinite !important; }
        .repo-icon-starting { animation: pulse 1s ease-in-out infinite !important; }

        @keyframes downloadBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes rotateAnalyze { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(4px); } }
        @keyframes prSlide { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(4px); } }

        .repo-status-name {
            flex: 1;
            font-size: 0.875rem;
            color: var(--color-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 120px;
        }

        .repo-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .repo-status-item.pending .repo-status-badge { background: rgba(113, 113, 122, 0.2); color: var(--color-text-muted); }
        .repo-status-item.loading .repo-status-badge { background: rgba(251, 191, 36, 0.2); color: var(--color-warning-light); }
        .repo-status-item.success .repo-status-badge { background: rgba(34, 197, 94, 0.2); color: var(--color-success); }
        .repo-status-item.error .repo-status-badge { background: rgba(239, 68, 68, 0.2); color: var(--color-danger); }

        .repo-mini-progress { width: 100%; margin-top: var(--space-sm); display: flex; flex-direction: column; gap: 0.25rem; }
        .repo-mini-progress-bar { height: 4px; background: rgba(255, 255, 255, 0.08); border-radius: 2px; overflow: hidden; }
        .repo-mini-progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); border-radius: 2px; transition: width 0.3s ease-out; }
        .repo-mini-progress.success .repo-mini-progress-fill { background: linear-gradient(90deg, var(--color-success), var(--color-success-light)); }
        .repo-mini-progress.error .repo-mini-progress-fill { background: linear-gradient(90deg, var(--color-danger), var(--color-danger-light)); }

        .repo-progress-steps { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--color-text-muted); }
        .repo-progress-step { display: flex; align-items: center; gap: 0.25rem; opacity: 0.5; transition: opacity 0.2s; }
        .repo-progress-step.active { opacity: 1; color: var(--color-warning-light); }
        .repo-progress-step.complete { opacity: 1; color: var(--color-success); }
        .repo-progress-step.error { opacity: 1; color: var(--color-danger); }

        /* Tags and chips */
        .repo-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 0.375rem 0.75rem;
            background: var(--color-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--color-text);
        }

        /* Developer Filter Section */
        .dev-filter-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; flex-wrap:wrap; gap:.5rem; }
        .dev-filter-title { display:flex; align-items:center; gap:.6rem; }
        .dev-filter-title h3 { font-size:1rem; color:var(--color-text-secondary); margin:0; }
        .dev-filter-badge { display:inline-flex; align-items:center; padding:.2rem .55rem; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:12px; font-size:.78rem; color:#818cf8; font-weight:600; }
        .dev-filter-actions { display:flex; align-items:center; gap:.4rem; }
        .dev-filter-search { padding:.4rem .75rem; border:1px solid rgba(255,255,255,.1); border-radius:8px; background:rgba(255,255,255,.04); color:#fff; font-size:.82rem; font-family:inherit; width:160px; transition:border-color .15s; }
        .dev-filter-search:focus { outline:none; border-color:#6366f1; }
        .dev-filter-btn { display:inline-flex; align-items:center; gap:.25rem; padding:.35rem .65rem; border:1px solid rgba(255,255,255,.12); border-radius:8px; background:rgba(255,255,255,.04); color:#9ca3af; font-size:.78rem; font-family:inherit; cursor:pointer; transition:all .15s; }
        .dev-filter-btn:hover { background:rgba(255,255,255,.08); color:#e4e4e7; }
        .dev-filter-btn.select-all:hover { border-color:rgba(34,197,94,.4); color:#4ade80; }
        .dev-filter-btn.deselect-all:hover { border-color:rgba(239,68,68,.4); color:#f87171; }
        .dev-filter-grid { display:flex; flex-wrap:wrap; gap:.4rem; max-height:180px; overflow-y:auto; padding:.25rem 0; }

        .dev-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.7rem;
            background: rgba(255,255,255,.04);
            border: 1.5px solid rgba(255,255,255,.1);
            border-radius: 10px;
            font-size: 0.82rem;
            color: #a1a1aa;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }

        .dev-chip:hover {
            background: rgba(99,102,241,.08);
            border-color: rgba(99,102,241,.25);
            color: #e4e4e7;
        }

        .dev-chip.selected {
            background: rgba(99,102,241,.12);
            border-color: rgba(99,102,241,.4);
            color: #a5b4fc;
        }

        .dev-chip .dev-avatar { width:22px; height:22px; border-radius:50%; border:1.5px solid rgba(255,255,255,.15); }
        .dev-chip.selected .dev-avatar { border-color:rgba(99,102,241,.5); }
        .dev-chip .dev-commits {
            font-size: 0.68rem;
            padding: 0.1rem 0.35rem;
            background: rgba(255,255,255,.06);
            border-radius: 6px;
            color: #71717a;
        }
        .dev-chip.selected .dev-commits { background:rgba(99,102,241,.15); color:#818cf8; }

        /* Results panel sections */
        .analyzed-repos-section {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.06));
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }

        .developer-filter-section {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--color-success-bg);
            border-radius: var(--radius-md);
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        /* Chart container override */
        .chart-container {
            height: 380px;
        }

        /* Two-column chart grid for results */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-xl);
        }

        .charts-container .chart-wrapper:first-child,
        .charts-container .chart-wrapper:nth-child(2) {
            grid-column: span 1;
        }

        .charts-container .chart-wrapper:last-child {
            grid-column: span 2;
        }

        @media (max-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .charts-container .chart-wrapper:last-child {
                grid-column: span 1;
            }
        }

        /* Results container - hidden by default, shown after analysis */
        .results-container { display: none; margin-top: 2rem; }
        .results-container.visible { display: block; animation: fadeIn 0.4s ease-out; }

        /* Loading spinner between config and results */
        .analysis-loading { display: none; text-align: center; padding: 3rem 1rem; }
        .analysis-loading.visible { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .error-box { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); border-radius: 12px; padding: 1rem; margin-top: 1rem; color: #f87171; }
        .error-box.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Repo search dropdown */
        .repo-search-wrapper { position: relative; }
        .repo-dropdown { display:none; position:absolute; top:100%; left:0; right:0; max-height:280px; overflow-y:auto; background:#1e1e2e; border:1px solid rgba(255,255,255,.15); border-radius:12px; margin-top:4px; z-index:100; box-shadow:0 8px 32px rgba(0,0,0,.5); }
        .repo-dropdown.show { display:block; }
        .repo-dropdown-item { padding:.6rem 1rem; color:#e4e4e7; font-size:.875rem; cursor:pointer; transition:background .15s; display:flex; align-items:center; gap:.5rem; border-bottom:1px solid rgba(255,255,255,.05); }
        .repo-dropdown-item:last-child { border-bottom:none; }
        .repo-dropdown-item:hover { background:rgba(99,102,241,.15); }
        .repo-dropdown-item.selected { background:rgba(99,102,241,.2); color:#818cf8; }
        .repo-dropdown-item .repo-check { width:16px; height:16px; border-radius:4px; border:2px solid rgba(255,255,255,.2); display:flex; align-items:center; justify-content:center; font-size:.7rem; flex-shrink:0; transition:all .15s; }
        .repo-dropdown-item.selected .repo-check { background:#6366f1; border-color:#6366f1; color:#fff; }
        .repo-dropdown-item .repo-icon { opacity:.5; font-size:.75rem; }
        .repo-dropdown-empty { padding:1rem; text-align:center; color:#71717a; font-size:.85rem; }

        /* Selected tags */
        .repo-tag { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; background:rgba(99,102,241,.15); border:1px solid rgba(99,102,241,.3); border-radius:8px; font-size:.78rem; color:#a5b4fc; cursor:default; }
        .repo-tag .tag-remove { cursor:pointer; color:#71717a; font-size:.85rem; line-height:1; margin-left:.15rem; transition:color .15s; }
        .repo-tag .tag-remove:hover { color:#ef4444; }

        /* Commit Popup Modal */
        .commit-popup-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.75); backdrop-filter:blur(8px); z-index:10001; align-items:center; justify-content:center; }
        .commit-popup-modal.show { display:flex; }
        .commit-popup-content { background:linear-gradient(135deg,#1e1e2e,#16213e); border:1px solid rgba(255,255,255,.1); border-radius:16px; max-width:900px; width:95%; max-height:85vh; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,.5); animation:fadeIn .3s ease-out; }
        .commit-popup-header { display:flex; align-items:center; justify-content:space-between; padding:1.25rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.08); }
        .commit-popup-user-info { display:flex; align-items:center; gap:1rem; }
        .commit-popup-avatar { width:48px; height:48px; border-radius:50%; border:2px solid #6366f1; }
        .commit-popup-name { font-size:1.15rem; font-weight:600; color:#fff; }
        .commit-popup-login { font-size:.85rem; color:#818cf8; }
        .commit-popup-close { width:40px; height:40px; border:none; background:rgba(255,255,255,.05); color:#9ca3af; border-radius:10px; font-size:1.5rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; }
        .commit-popup-close:hover { background:rgba(239,68,68,.15); color:#ef4444; }
        .commit-popup-stats { display:flex; gap:1.5rem; padding:1rem 1.5rem; background:rgba(255,255,255,.03); border-bottom:1px solid rgba(255,255,255,.06); flex-wrap:wrap; }
        .commit-popup-stat { text-align:center; }
        .commit-popup-stat-value { font-size:1.3rem; font-weight:700; color:#fff; }
        .commit-popup-stat-label { font-size:.72rem; color:#71717a; }
        .commit-popup-search { padding:.75rem 1.5rem; border-bottom:1px solid rgba(255,255,255,.06); }
        .commit-popup-search input { width:100%; padding:.6rem 1rem; border:1px solid rgba(255,255,255,.1); border-radius:10px; background:rgba(255,255,255,.04); color:#fff; font-size:.85rem; font-family:inherit; }
        .commit-popup-search input:focus { outline:none; border-color:#6366f1; }
        .commit-popup-body { padding:.75rem 1.5rem 1.5rem; max-height:48vh; overflow-y:auto; }
        .commit-item { display:flex; gap:1rem; padding:.75rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:10px; margin-bottom:.5rem; transition:all .15s; }
        .commit-item:hover { background:rgba(99,102,241,.08); border-color:rgba(99,102,241,.2); }
        .commit-hash { font-family:'Courier New',monospace; font-size:.8rem; color:#818cf8; min-width:70px; padding-top:2px; }
        .commit-hash a { color:#818cf8; text-decoration:none; }
        .commit-hash a:hover { text-decoration:underline; color:#a5b4fc; }
        .commit-info { flex:1; min-width:0; }
        .commit-message { font-size:.875rem; color:#e4e4e7; margin-bottom:.3rem; word-break:break-word; }
        .commit-message a { color:#e4e4e7; text-decoration:none; }
        .commit-message a:hover { color:#818cf8; text-decoration:underline; }
        .commit-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.75rem; color:#71717a; }
        .commit-meta-item { display:flex; align-items:center; gap:.25rem; }

        /* Popup Tabs */
        .popup-tabs { display:flex; border-bottom:1px solid rgba(255,255,255,.08); padding:0 1.5rem; gap:0; }
        .popup-tab { padding:.65rem 1.1rem; border:none; background:none; color:#71717a; font-size:.85rem; font-family:inherit; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; display:flex; align-items:center; gap:.4rem; }
        .popup-tab:hover { color:#a5b4fc; background:rgba(99,102,241,.05); }
        .popup-tab.active { color:#a5b4fc; border-bottom-color:#6366f1; }
        .popup-tab-badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:18px; padding:0 5px; border-radius:9px; background:rgba(255,255,255,.08); font-size:.7rem; font-weight:600; color:#71717a; }
        .popup-tab.active .popup-tab-badge { background:rgba(99,102,241,.2); color:#818cf8; }

        /* PR Item in popup */
        .pr-item { display:flex; gap:1rem; padding:.75rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:10px; margin-bottom:.5rem; transition:all .15s; }
        .pr-item:hover { background:rgba(99,102,241,.08); border-color:rgba(99,102,241,.2); }
        .pr-number { font-family:'Courier New',monospace; font-size:.8rem; color:#818cf8; min-width:55px; padding-top:2px; }
        .pr-number a { color:#818cf8; text-decoration:none; }
        .pr-number a:hover { text-decoration:underline; color:#a5b4fc; }
        .pr-info { flex:1; min-width:0; }
        .pr-title { font-size:.875rem; color:#e4e4e7; margin-bottom:.3rem; word-break:break-word; }
        .pr-title a { color:#e4e4e7; text-decoration:none; }
        .pr-title a:hover { color:#818cf8; text-decoration:underline; }
        .pr-state-badge { padding:.1rem .4rem; border-radius:4px; font-size:.7rem; font-weight:600; }
        .pr-state-badge.merged { background:rgba(139,92,246,.2); color:#a78bfa; }
        .pr-state-badge.open { background:rgba(34,197,94,.2); color:#4ade80; }
        .pr-state-badge.closed { background:rgba(239,68,68,.2); color:#f87171; }

        /* Clickable developer row */
        .developer-table tbody tr { cursor:pointer; transition:background .15s; }
        .developer-table tbody tr:hover { background:rgba(99,102,241,.1) !important; }
    </style>
</head>
<body>
    <!-- Custom Modal/Popup -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Alert</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="/" class="back-home-btn">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>

    <!-- Background -->
    <div class="page-bg"><div class="grid-lines"></div></div>

    <div class="page-content">
    <div class="container">
        <div class="page-title">
            <h1>üìä Developer Contribution</h1>
            <p class="subtitle">Analyze commits, code changes, and contribution patterns across repositories</p>
        </div>

        <!-- Repository Selection -->
        <div class="config-panel" id="configPanel">
            <div style="margin-bottom:1.25rem">
                <label style="display:block;color:#9ca3af;font-size:.82rem;font-weight:500;margin-bottom:.5rem">üìÅ Select Repositories <span id="selectedCount" style="color:#818cf8;font-weight:600">0</span> selected (1-10)</label>
                <div class="repo-search-wrapper" id="repoSearchWrapper">
                    <input type="text" id="repoSearch" placeholder="Search repositories‚Ä¶" autocomplete="off"
                           style="width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;font-size:.9rem;font-family:inherit"
                           oninput="filterRepos()" onfocus="showRepoDropdown()">
                    <div class="repo-dropdown" id="repoDropdown"></div>
                </div>
                <div class="repo-selected-tags" id="repoSelectedTags" style="display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.6rem"></div>
            </div>

            <div class="config-grid">
                <div class="config-field">
                    <label>üåø Branch</label>
                    <input type="text" id="branchInput" placeholder="all branches (leave empty)" value="">
                    <div class="field-hint">Leave empty for all branches, or enter comma-separated names</div>
                </div>
                <div class="config-field">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="config-field">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="config-field">
                    <label>Aggregation Period</label>
                    <select id="period">
                        <option value="DAILY">Daily</option>
                        <option value="WEEKLY" selected>Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>
            </div>

            <div class="config-checkbox">
                <input type="checkbox" id="excludeMerges" checked>
                <label for="excludeMerges">üîÄ Exclude merge commits (recommended)</label>
            </div>

            <div class="config-actions">
                <button class="btn-action btn-analyze" onclick="analyzeRepositories()" id="analyzeBtn" disabled>
                    üìä Analyze Selected Repositories
                </button>
            </div>

            <div id="analyze-error" class="error hidden"></div>

            <!-- Parallel Loading Progress Panel -->
            <div id="parallel-loading-panel" class="parallel-loading-panel hidden">
                <div class="loading-header">
                    <div class="loading-title">
                        <div class="pulse-dot"></div>
                        <span>Analyzing Repositories in Parallel</span>
                    </div>
                    <span id="loading-progress-text" style="font-size: 0.875rem; color: #a1a1aa;">0 / 0 completed</span>
                </div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="loading-progress-fill" style="width: 0%"></div>
                </div>
                <div class="loading-status-text">
                    <span>Current:</span>
                    <span class="current-action" id="loading-current-action">Initializing...</span>
                </div>
                <div class="repo-status-list" id="repo-status-list"></div>
            </div>
        </div>

        <!-- Loading -->
        <div class="analysis-loading" id="analysisLoading">
            <div class="spinner"></div>
            <span style="color:var(--color-accent-light);font-weight:500" id="loadingText">Analyzing repositories‚Ä¶</span>
        </div>
        <div id="errorMsg" class="error-box hidden"></div>

        <!-- Results (appears below config panel on same page) -->
        <div class="results-container" id="resultsContainer">
            <h2 style="color:#fff;margin-bottom:1rem;">üìä Contribution Report</h2>

            <!-- Analyzed Repositories Section -->
            <div class="analyzed-repos-section" id="analyzedReposSection">
                <h3 style="margin-bottom: 0.75rem; font-size: 1rem; color: var(--color-text-secondary);">üìÅ Analyzed Repositories (<span id="analyzedRepoCount">0</span>)</h3>
                <div id="analyzedReposList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                <div id="dateRangeInfo" style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--color-text-secondary);"></div>
            </div>

            <!-- Developer Filter Section -->
            <div class="developer-filter-section">
                <div class="dev-filter-header">
                    <div class="dev-filter-title">
                        <h3>üë• Filter by Developers</h3>
                        <span class="dev-filter-badge"><span id="selectedDevCount">0</span> / <span id="totalDevCount">0</span></span>
                    </div>
                    <div class="dev-filter-actions">
                        <input type="text" id="devFilterSearch" placeholder="Search developers‚Ä¶" oninput="filterDeveloperChips()" class="dev-filter-search">
                        <button class="dev-filter-btn select-all" onclick="selectAllDevelopers()" title="Select All">
                            <span>‚úì</span> All
                        </button>
                        <button class="dev-filter-btn deselect-all" onclick="deselectAllDevelopers()" title="Deselect All">
                            <span>‚úï</span> None
                        </button>
                    </div>
                </div>
                <div id="developerFilterList" class="dev-filter-grid"></div>
            </div>

            <div class="summary-cards" id="summaryCards"></div>

            <div class="charts-container">
                <!-- Overall Activity Charts (not filtered by developer selection) -->
                <div class="chart-wrapper">
                    <h2>üìà Total Commits Over Time (All Developers)</h2>
                    <div class="chart-container">
                        <canvas id="totalCommitsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üèÜ Top Committers</h2>
                    <div class="chart-container">
                        <canvas id="topCommittersChart"></canvas>
                    </div>
                </div>

                <!-- Filtered by developer selection -->
                <div class="chart-wrapper">
                    <h2>üìà Commits Over Time (by Developer)</h2>
                    <div class="chart-container">
                        <canvas id="commitsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üîÄ PRs Authored Over Time</h2>
                    <div class="chart-container">
                        <canvas id="prsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üöÄ Top PR Authors</h2>
                    <div class="chart-container">
                        <canvas id="prAuthorsChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üìä Lines of Code Changed</h2>
                    <div class="chart-container">
                        <canvas id="linesChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üë• Developer Contributions</h2>
                    <div class="chart-container">
                        <canvas id="developerPieChart"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <h2>üìã Developer Summary</h2>
                    <p style="font-size: 0.82rem; color: #a1a1aa; margin: -0.25rem 0 0.75rem; background: rgba(99,102,241,.06); border: 1px solid rgba(99,102,241,.15); border-radius: 8px; padding: 0.5rem 0.75rem;">
                        üí° <strong>Click any developer row</strong> to view their commits, PRs authored, and PRs reviewed
                    </p>
                    <table class="developer-table">
                        <thead>
                            <tr>
                                <th>Developer</th>
                                <th>Nickname</th>
                                <th>Commits</th>
                                <th>Lines Added</th>
                                <th>Lines Deleted</th>
                                <th>Repositories</th>
                            </tr>
                        </thead>
                        <tbody id="developerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Commit Popup Modal -->
    <div id="commitPopupModal" class="commit-popup-modal" onclick="closeCommitPopup(event)">
        <div class="commit-popup-content" onclick="event.stopPropagation()">
            <div class="commit-popup-header">
                <div class="commit-popup-user-info">
                    <img id="commitPopupAvatar" class="commit-popup-avatar" src="" alt="">
                    <div>
                        <div class="commit-popup-name" id="commitPopupName">Developer Name</div>
                        <div class="commit-popup-login" id="commitPopupLogin">@username</div>
                    </div>
                </div>
                <button class="commit-popup-close" onclick="closeCommitPopup()">√ó</button>
            </div>
            <div class="commit-popup-stats" id="commitPopupStats"></div>
            <div class="commit-popup-search">
                <input type="text" id="commitSearchInput" placeholder="Search commits by message or hash‚Ä¶" oninput="filterCommitList()">
            </div>
            <div class="commit-popup-body" id="commitPopupBody"></div>
        </div>
    </div>
    </div>

    <script>
        // State
        let currentStep = 1;
        let selectedProvider = 'GITHUB';
        let repositories = [];
        let contributors = [];
        let organizations = [];

        let selectedRepos = new Set();
        let commitsChart = null;
        let linesChart = null;
        let pieChart = null;
        let totalCommitsChart = null;
        let topCommittersChart = null;
        let prsChart = null;
        let prAuthorsChart = null;

        // Developer filter state
        let fullAnalysisData = null;  // Store the complete analysis data
        let selectedDevelopers = new Set();  // Selected developer emails for filtering

        // Display name lookup map (populated from session)
        window.displayNameMap = {};

        /**
         * Get display name for a contributor login/nickname
         * Uses the displayNameMap populated from session data
         */
        function getDisplayName(loginOrNickname) {
            if (!loginOrNickname) return 'Unknown';

            // Remove @ prefix if present (nicknames have @)
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();
            const displayName = window.displayNameMap[cleanLogin];
            const result = displayName || loginOrNickname;

            // Debug logging
            if (displayName && displayName !== loginOrNickname) {
                console.debug(`‚úÖ getDisplayName('${loginOrNickname}') -> '${displayName}'`);
            }

            return result;
        }

        /**
         * Get avatar URL for a contributor login/nickname
         * Uses session data to find avatar
         */
        function getAvatarUrl(loginOrNickname) {
            if (!loginOrNickname) return null;

            const sessionData = getSessionData();
            if (!sessionData?.contributors) return null;

            // Remove @ prefix if present
            const cleanLogin = loginOrNickname.replace('@', '').toLowerCase();

            // Find contributor by login
            const contributor = sessionData.contributors.find(c =>
                c.login && c.login.toLowerCase() === cleanLogin
            );

            return contributor?.avatarUrl || contributor?.avatar_url || null;
        }

        // Get session data from sessionStorage
        function getSessionData() {
            const data = sessionStorage.getItem('spaceAnalyticsSession');
            return data ? JSON.parse(data) : null;
        }

        // Custom Modal Functions
        function showModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeModal();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Detect if running in iframe
            if (window.self !== window.top) {
                document.body.classList.add('in-iframe');
            }

            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // Load session data if available
            const sessionData = getSessionData();
            if (sessionData && sessionData.token) {
                // Set provider from session
                selectedProvider = sessionData.provider || 'GITHUB';

                // Create display name lookup map from session contributors
                if (sessionData.contributors && sessionData.contributors.length > 0) {
                    window.displayNameMap = {};
                    sessionData.contributors.forEach(c => {
                        if (c.login) {
                            window.displayNameMap[c.login.toLowerCase()] = c.name || c.login;
                        }
                    });

                    organizations = sessionData.organizations || [];
                    contributors = sessionData.contributors || [];

                    console.log('‚úÖ Created displayNameMap with', Object.keys(window.displayNameMap).length, 'entries');
                    console.log('üìã Sample displayNameMap:', Object.entries(window.displayNameMap).slice(0, 5));
                }

                // Auto-load repositories from session
                if (sessionData.repositories && sessionData.repositories.length > 0) {
                    repositories = sessionData.repositories.map(r => ({
                        fullName: r.fullName,
                        name: r.name || r.fullName.split('/').pop(),
                        isPrivate: r.private || false
                    }));
                    renderRepoDropdown(repositories);
                    renderSelectedTags();
                    currentStep = 1;
                }
            } else {
                // Redirect to login if no session
                window.location.href = '/';
            }
        });

        // Show/hide results (config panel always stays visible)
        function showResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.add('visible');
            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideResults() {
            const results = document.getElementById('resultsContainer');
            results.classList.remove('visible');
        }

        // Legacy goToStep calls mapped to new pattern
        function goToStep(step) {
            if (step === 3) {
                showResults();
            } else {
                hideResults();
            }
        }

        // Fetch repositories
        async function fetchRepositories() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                showError('auth-error', 'Please enter your access token');
                return;
            }

            hideError('auth-error');
            showLoading('auth-loading');

            try {
                const response = await fetch('/api/git/repositories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        provider: selectedProvider,
                        baseUrl: document.getElementById('baseUrl').value || null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch repositories. Check your token.');
                }

                const data = await response.json();
                repositories = data.repositories;
                selectedRepos.clear();

                renderRepoDropdown(repositories);
                renderSelectedTags();
                hideLoading('auth-loading');

            } catch (error) {
                hideLoading('auth-loading');
                showError('auth-error', error.message);
            }
        }

        // Render repository list
        // Render repo dropdown with checkboxes
        function renderRepoDropdown(repos) {
            const dd = document.getElementById('repoDropdown');
            if (!repos.length) {
                dd.innerHTML = '<div class="repo-dropdown-empty">No repositories found</div>';
                return;
            }
            dd.innerHTML = repos.map(repo => {
                const isSelected = selectedRepos.has(repo.fullName);
                const icon = repo.isPrivate ? 'üîí' : 'üìÇ';
                return `<div class="repo-dropdown-item ${isSelected ? 'selected' : ''}" onclick="toggleRepo('${repo.fullName.replace(/'/g, "\\'")}')">
                    <span class="repo-check">${isSelected ? '‚úì' : ''}</span>
                    <span class="repo-icon">${icon}</span>
                    ${repo.fullName}
                </div>`;
            }).join('');
        }

        function filterRepos() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = repositories.filter(r => r.fullName.toLowerCase().includes(q));
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function showRepoDropdown() {
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => r.fullName.toLowerCase().includes(q)) : repositories;
            renderRepoDropdown(filtered);
            document.getElementById('repoDropdown').classList.add('show');
        }

        function toggleRepo(fullName) {
            if (selectedRepos.has(fullName)) {
                selectedRepos.delete(fullName);
            } else {
                if (selectedRepos.size >= 10) {
                    showModal('‚ö†Ô∏è', 'Maximum Limit Reached', 'You can select a maximum of 10 repositories.');
                    return;
                }
                selectedRepos.add(fullName);
            }
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => r.fullName.toLowerCase().includes(q)) : repositories;
            renderRepoDropdown(filtered);
            renderSelectedTags();
            updateSelectionCount();
        }

        function removeRepo(fullName) {
            selectedRepos.delete(fullName);
            const q = document.getElementById('repoSearch').value.toLowerCase();
            const filtered = q ? repositories.filter(r => r.fullName.toLowerCase().includes(q)) : repositories;
            renderRepoDropdown(filtered);
            renderSelectedTags();
            updateSelectionCount();
        }

        function renderSelectedTags() {
            const container = document.getElementById('repoSelectedTags');
            if (selectedRepos.size === 0) {
                container.innerHTML = '<span style="color:#52525b;font-size:.8rem">No repositories selected</span>';
                return;
            }
            container.innerHTML = Array.from(selectedRepos).map(name => {
                const short = name.split('/').pop();
                return `<span class="repo-tag">${short}<span class="tag-remove" onclick="removeRepo('${name.replace(/'/g, "\\'")}')">&times;</span></span>`;
            }).join('');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const wrapper = document.getElementById('repoSearchWrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('repoDropdown').classList.remove('show');
            }
        });

        // Branch helper ‚Äî reads comma-separated input
        function getBranchesFromInput() {
            const input = document.getElementById('branchInput');
            if (!input || !input.value.trim()) return [];
            return input.value.split(',').map(b => b.trim()).filter(b => b.length > 0);
        }

        function updateSelectionCount() {
            document.getElementById('selectedCount').textContent = selectedRepos.size;
            document.getElementById('analyzeBtn').disabled = selectedRepos.size === 0;
        }

        // Repository status tracking for parallel loading
        let repoStatuses = {};
        let completedCount = 0;
        let totalRepoCount = 0;
        let allRepoResults = [];
        let loadingStartTime = null;

        // Logging helper
        function log(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const prefix = `[${timestamp}] [${level.toUpperCase()}]`;
            if (data) {
                console[level](`${prefix} ${message}`, data);
            } else {
                console[level](`${prefix} ${message}`);
            }
        }

        // Initialize parallel loading UI
        function initParallelLoading(repoList) {
            repoStatuses = {};
            completedCount = 0;
            totalRepoCount = repoList.length;
            allRepoResults = [];
            loadingStartTime = Date.now();

            log('info', `üöÄ Starting parallel analysis of ${repoList.length} repositories`);
            log('info', 'Repositories:', repoList);

            const panel = document.getElementById('parallel-loading-panel');
            const statusList = document.getElementById('repo-status-list');

            // Build status list with mini progress bars for each repo
            statusList.innerHTML = repoList.map(repo => {
                const safeId = repo.replace(/[^a-zA-Z0-9]/g, '_');
                return `
                <div class="repo-status-item pending" id="repo-status-${safeId}">
                    <div class="repo-status-icon">‚è≥</div>
                    <div class="repo-status-name">${repo}</div>
                    <div class="repo-status-detail" id="repo-detail-${safeId}" style="font-size: 0.7rem; color: #71717a; margin-left: auto; margin-right: 0.5rem;"></div>
                    <div class="repo-status-badge" id="repo-badge-${safeId}">Queued</div>

                    <!-- Mini progress bar for this repo -->
                    <div class="repo-mini-progress" id="repo-progress-${safeId}">
                        <div class="repo-mini-progress-bar">
                            <div class="repo-mini-progress-fill" id="repo-progress-fill-${safeId}" style="width: 0%"></div>
                        </div>
                        <div class="repo-progress-steps">
                            <span class="repo-progress-step" id="step-init-${safeId}">üìã Init</span>
                            <span class="repo-progress-step" id="step-clone-${safeId}">üì• Clone</span>
                            <span class="repo-progress-step" id="step-analyze-${safeId}">üîç Analyze</span>
                            <span class="repo-progress-step" id="step-prs-${safeId}">üîÄ PRs</span>
                            <span class="repo-progress-step" id="step-done-${safeId}">‚úÖ Done</span>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Initialize statuses with step tracking
            repoList.forEach(repo => {
                repoStatuses[repo] = {
                    status: 'pending',
                    startTime: null,
                    detail: '',
                    currentStep: 0,  // 0=pending, 1=init, 2=clone, 3=analyze, 4=prs, 5=done
                    steps: ['init', 'clone', 'analyze', 'prs', 'done']
                };
            });

            // Show panel and start timer
            panel.classList.remove('hidden');
            startProgressTimer();
            updateProgressBar();
            updateCurrentAction('Initializing parallel requests...');
        }

        // Update mini progress bar for a repo
        function updateRepoProgress(repoName, stepIndex, stepStatus = 'active') {
            const safeId = repoName.replace(/[^a-zA-Z0-9]/g, '_');
            const progressFill = document.getElementById(`repo-progress-fill-${safeId}`);
            const progressContainer = document.getElementById(`repo-progress-${safeId}`);

            if (!progressFill || !repoStatuses[repoName]) return;

            const steps = repoStatuses[repoName].steps;
            const totalSteps = steps.length;

            // Update progress bar fill (each step = 20%)
            const percent = Math.min((stepIndex / totalSteps) * 100, 100);
            progressFill.style.width = `${percent}%`;

            // Update step indicators
            steps.forEach((step, idx) => {
                const stepEl = document.getElementById(`step-${step}-${safeId}`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'complete', 'error');
                    if (idx < stepIndex) {
                        stepEl.classList.add('complete');
                    } else if (idx === stepIndex && stepStatus === 'active') {
                        stepEl.classList.add('active');
                    } else if (idx === stepIndex && stepStatus === 'error') {
                        stepEl.classList.add('error');
                    }
                }
            });

            // Update progress bar color on completion
            if (stepStatus === 'complete' && stepIndex >= totalSteps) {
                progressContainer.classList.add('success');
            } else if (stepStatus === 'error') {
                progressContainer.classList.add('error');
            }

            repoStatuses[repoName].currentStep = stepIndex;
        }

        // Update repository status with detailed info
        function updateRepoStatus(repoName, status, detail = null, extraInfo = null) {
            const safeId = repoName.replace(/[^a-zA-Z0-9]/g, '_');
            const item = document.getElementById(`repo-status-${safeId}`);
            const detailEl = document.getElementById(`repo-detail-${safeId}`);

            if (!item) {
                log('warn', `Could not find status element for: ${repoName}`);
                return;
            }

            // Track status
            if (!repoStatuses[repoName]) {
                repoStatuses[repoName] = { status: 'pending', startTime: null, detail: '' };
            }

            const wasCompleted = repoStatuses[repoName].status === 'success' || repoStatuses[repoName].status === 'error';
            const isNowCompleted = status === 'success' || status === 'error';

            repoStatuses[repoName].status = status;
            repoStatuses[repoName].detail = detail || '';

            if (!repoStatuses[repoName].startTime && status !== 'pending') {
                repoStatuses[repoName].startTime = Date.now();
            }

            // Log the status change
            const emoji = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : 'üîÑ';
            log('info', `${emoji} [${repoName}] ${status.toUpperCase()}: ${detail || ''}`);
            if (extraInfo) {
                log('info', `   ‚îî‚îÄ Details:`, extraInfo);
            }

            // Remove all status classes
            item.classList.remove('pending', 'loading', 'success', 'error');

            const icon = item.querySelector('.repo-status-icon');
            const badge = item.querySelector('.repo-status-badge');

            // Remove all animation classes
            icon.classList.remove('repo-icon-starting', 'repo-icon-cloning', 'repo-icon-analyzing', 'repo-icon-prs');

            switch (status) {
                case 'pending':
                    item.classList.add('pending');
                    icon.innerHTML = '‚è≥';
                    badge.textContent = 'Queued';
                    updateRepoProgress(repoName, 0, 'pending');
                    break;
                case 'starting':
                    item.classList.add('loading');
                    icon.innerHTML = 'üöÄ';
                    icon.classList.add('repo-icon-starting');
                    badge.textContent = 'Starting...';
                    updateRepoProgress(repoName, 1, 'active');  // Step 1: Init
                    break;
                case 'cloning':
                    item.classList.add('loading');
                    icon.innerHTML = 'üì•';
                    icon.classList.add('repo-icon-cloning');
                    badge.textContent = 'Cloning repo...';
                    if (detailEl) detailEl.textContent = 'Downloading repository files';
                    updateRepoProgress(repoName, 2, 'active');  // Step 2: Clone
                    break;
                case 'analyzing':
                    item.classList.add('loading');
                    icon.innerHTML = 'üîç';
                    icon.classList.add('repo-icon-analyzing');
                    badge.textContent = 'Analyzing commits...';
                    if (detailEl) detailEl.textContent = detail || 'Reading git history';
                    updateRepoProgress(repoName, 3, 'active');  // Step 3: Analyze
                    break;
                case 'fetching-prs':
                    item.classList.add('loading');
                    icon.innerHTML = 'üîÄ';
                    icon.classList.add('repo-icon-prs');
                    badge.textContent = 'Fetching PRs...';
                    if (detailEl) detailEl.textContent = 'Loading merged pull requests';
                    updateRepoProgress(repoName, 4, 'active');  // Step 4: PRs
                    break;
                case 'processing':
                    item.classList.add('loading');
                    icon.innerHTML = '‚öôÔ∏è';
                    badge.textContent = detail || 'Processing...';
                    break;
                case 'success':
                    item.classList.add('success');
                    icon.innerHTML = '‚úÖ';
                    badge.textContent = detail || 'Complete';
                    if (detailEl) {
                        const elapsed = repoStatuses[repoName].startTime
                            ? ((Date.now() - repoStatuses[repoName].startTime) / 1000).toFixed(1) + 's'
                            : '';
                        detailEl.textContent = elapsed;
                    }
                    updateRepoProgress(repoName, 5, 'complete');  // Step 5: Done
                    if (!wasCompleted && isNowCompleted) {
                        completedCount++;
                        log('info', `üìä Progress: ${completedCount}/${totalRepoCount} repositories completed`);
                    }
                    break;
                case 'error':
                    item.classList.add('error');
                    icon.innerHTML = '‚ùå';
                    badge.textContent = detail || 'Failed';
                    if (detailEl) detailEl.textContent = 'Error';
                    updateRepoProgress(repoName, repoStatuses[repoName].currentStep || 1, 'error');
                    if (!wasCompleted && isNowCompleted) {
                        completedCount++;
                    }
                    break;
            }

            updateProgressBar();
        }

        // Update progress bar with percentage
        function updateProgressBar() {
            const fill = document.getElementById('loading-progress-fill');
            const text = document.getElementById('loading-progress-text');

            // Calculate progress based on completed repos
            const percent = totalRepoCount > 0 ? (completedCount / totalRepoCount) * 100 : 0;

            fill.style.width = `${percent}%`;
            text.textContent = `${completedCount} / ${totalRepoCount} completed (${Math.round(percent)}%)`;

            // Calculate elapsed time
            if (loadingStartTime) {
                const elapsed = ((Date.now() - loadingStartTime) / 1000).toFixed(0);
                if (elapsed > 0) {
                    text.textContent += ` ‚Ä¢ ${elapsed}s`;
                }
            }
        }

        // Timer interval for updating elapsed time
        let progressTimerInterval = null;

        function startProgressTimer() {
            if (progressTimerInterval) clearInterval(progressTimerInterval);
            progressTimerInterval = setInterval(() => {
                updateProgressBar();
            }, 1000);
        }

        function stopProgressTimer() {
            if (progressTimerInterval) {
                clearInterval(progressTimerInterval);
                progressTimerInterval = null;
            }
        }

        // Update current action text
        function updateCurrentAction(text) {
            document.getElementById('loading-current-action').textContent = text;
            log('info', `üîÑ Current action: ${text}`);
        }

        // Hide parallel loading panel
        function hideParallelLoading() {
            stopProgressTimer();
            const totalTime = loadingStartTime ? ((Date.now() - loadingStartTime) / 1000).toFixed(2) : 0;
            log('info', `\n‚úÖ Loading panel hidden. Total loading time: ${totalTime}s`);
            document.getElementById('parallel-loading-panel').classList.add('hidden');
        }

        // Merge multiple analysis results into one
        function mergeAnalysisResults(results) {
            if (results.length === 0) return null;
            if (results.length === 1) return results[0];

            // Merge developers by authorName
            const developerMap = new Map();

            results.forEach(result => {
                result.developers.forEach(dev => {
                    const key = dev.authorName;
                    if (developerMap.has(key)) {
                        const existing = developerMap.get(key);
                        // Merge data points
                        const mergedDataPoints = existing.dataPoints.map((dp, idx) => {
                            const otherDp = dev.dataPoints[idx] || { commits: 0, linesAdded: 0, linesDeleted: 0, filesChanged: 0 };
                            return {
                                ...dp,
                                commits: dp.commits + otherDp.commits,
                                linesAdded: dp.linesAdded + otherDp.linesAdded,
                                linesDeleted: dp.linesDeleted + otherDp.linesDeleted,
                                filesChanged: dp.filesChanged + otherDp.filesChanged
                            };
                        });
                        developerMap.set(key, {
                            ...existing,
                            dataPoints: mergedDataPoints,
                            emails: new Set([...existing.emails, ...dev.emails]),
                            repositories: new Set([...existing.repositories, ...dev.repositories]),
                            commits: [...(existing.commits || []), ...(dev.commits || [])]
                        });
                    } else {
                        developerMap.set(key, {
                            ...dev,
                            emails: new Set(dev.emails),
                            repositories: new Set(dev.repositories),
                            commits: dev.commits || []
                        });
                    }
                });
            });

            // Convert Sets back to arrays and compute total commits for sorting
            const mergedDevelopers = Array.from(developerMap.values()).map(dev => ({
                ...dev,
                emails: Array.from(dev.emails),
                repositories: Array.from(dev.repositories)
            })).sort((a, b) => {
                const totalA = a.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const totalB = b.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                return totalB - totalA;
            });

            // Merge PR counts
            const mergedPRCounts = results[0].prCountByPeriod.map((_, idx) =>
                results.reduce((sum, r) => sum + (r.prCountByPeriod[idx] || 0), 0)
            );

            // Merge PR author stats
            const prAuthorMap = new Map();
            results.forEach(result => {
                (result.prAuthorStats || []).forEach(stat => {
                    if (prAuthorMap.has(stat.authorName)) {
                        prAuthorMap.set(stat.authorName, prAuthorMap.get(stat.authorName) + stat.prCount);
                    } else {
                        prAuthorMap.set(stat.authorName, stat.prCount);
                    }
                });
            });
            const mergedPRAuthorStats = Array.from(prAuthorMap.entries())
                .map(([authorName, prCount]) => ({ authorName, prCount }))
                .sort((a, b) => b.prCount - a.prCount);

            // Merge summaries
            const mergedSummary = {
                totalDevelopers: mergedDevelopers.length,
                totalCommits: results.reduce((sum, r) => sum + r.summary.totalCommits, 0),
                totalLinesAdded: results.reduce((sum, r) => sum + r.summary.totalLinesAdded, 0),
                totalLinesDeleted: results.reduce((sum, r) => sum + r.summary.totalLinesDeleted, 0),
                totalPRs: results.reduce((sum, r) => sum + (r.summary.totalPRs || 0), 0),
                mostActiveAuthor: mergedDevelopers[0]?.authorName || null,
                mostActiveRepository: null
            };

            return {
                analyzedRepositories: results.flatMap(r => r.analyzedRepositories),
                dateRange: results[0].dateRange,
                period: results[0].period,
                developers: mergedDevelopers,
                summary: mergedSummary,
                prCountByPeriod: mergedPRCounts,
                prAuthorStats: mergedPRAuthorStats
            };
        }

        // Analyze repositories in PARALLEL
        async function analyzeRepositories() {
            // Validate: minimum 1 repo
            if (selectedRepos.size === 0) {
                showModal('üìÅ', 'Repositories Required', 'Please select at least 1 repository to analyze.');
                return;
            }

            // Validate: maximum 10 repos
            if (selectedRepos.size > 10) {
                showModal('‚ö†Ô∏è', 'Too Many Repositories', 'You can select a maximum of 10 repositories. Please deselect some repositories.');
                return;
            }

            hideError('analyze-error');

            const sessionData = getSessionData();
            const token = sessionData?.token || '';
            const startDate = document.getElementById('startDate').value || null;
            const endDate = document.getElementById('endDate').value || null;
            const period = document.getElementById('period').value;

            // Get branch filter from input
            const branches = getBranchesFromInput();
            const branch = branches.length > 0 ? branches[0] : null;

            const excludeMerges = document.getElementById('excludeMerges').checked;

            const repoList = Array.from(selectedRepos);

            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üöÄ STARTING REPOSITORY ANALYSIS');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', `Provider: ${selectedProvider}`);
            log('info', `Date Range: ${startDate || 'default'} to ${endDate || 'default'}`);
            log('info', `Period: ${period}`);
            log('info', `Branch: ${branches && branches.length > 0 ? branches.join(', ') : 'all branches'}`);
            log('info', `Exclude merges: ${excludeMerges}`);
            log('info', `Total repositories: ${repoList.length}`);

            // Initialize parallel loading UI
            initParallelLoading(repoList);
            document.getElementById('analyzeBtn').disabled = true;

            // Create promises for all repositories with detailed progress simulation
            const analyzePromises = repoList.map(async (repoFullName) => {
                const repoStartTime = Date.now();

                log('info', `\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
                log('info', `‚îÇ üì¶ Starting: ${repoFullName}`);
                log('info', `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);

                // Stage 1: Starting/Init
                updateRepoStatus(repoFullName, 'starting', 'Initializing...');
                updateCurrentAction(`Starting analysis for ${repoFullName}...`);

                // Small delay to show the starting state
                await new Promise(r => setTimeout(r, 150));

                // Stage 2: Cloning
                updateRepoStatus(repoFullName, 'cloning', 'Downloading repository...');
                log('info', `‚îÇ üì• [${repoFullName}] Cloning repository...`);

                try {
                    // Make the API call
                    log('info', `‚îÇ üåê [${repoFullName}] Sending API request to /api/git/analyze/single`);

                    const requestBody = {
                        token: token,
                        provider: selectedProvider,
                        baseUrl: sessionData?.baseUrl || null,
                        repositoryFullName: repoFullName,
                        startDate: startDate,
                        endDate: endDate,
                        period: period,
                        branch: branch,
                        excludeMerges: excludeMerges
                    };

                    log('info', `‚îÇ üì§ [${repoFullName}] Request payload:`, {
                        ...requestBody,
                        token: token ? `${token.substring(0, 8)}...` : 'none'
                    });

                    // Start simulated progress stages while waiting for API
                    let progressSimulator = null;
                    let currentSimStage = 2; // Start at cloning

                    // Simulate progress through stages every 2 seconds
                    progressSimulator = setInterval(() => {
                        currentSimStage++;
                        if (currentSimStage === 3) {
                            updateRepoStatus(repoFullName, 'analyzing', 'Reading git history...');
                        } else if (currentSimStage === 4) {
                            updateRepoStatus(repoFullName, 'fetching-prs', 'Loading PRs...');
                        }
                        // Stop simulating after stage 4
                        if (currentSimStage >= 4) {
                            clearInterval(progressSimulator);
                        }
                    }, 2500);

                    const response = await fetch('/api/git/analyze/single', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    // Stop progress simulation
                    if (progressSimulator) clearInterval(progressSimulator);

                    log('info', `‚îÇ üì® [${repoFullName}] Response status: ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        log('error', `‚îÇ ‚ùå [${repoFullName}] API Error:`, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                    }

                    // Final stage: Processing response
                    updateRepoStatus(repoFullName, 'fetching-prs', 'Finalizing...');

                    const data = await response.json();

                    const elapsed = ((Date.now() - repoStartTime) / 1000).toFixed(2);
                    const commits = data.summary?.totalCommits || 0;
                    const devs = data.developers?.length || 0;
                    const prs = data.summary?.totalPRs || 0;

                    log('info', `‚îÇ ‚úÖ [${repoFullName}] Analysis complete in ${elapsed}s`);
                    log('info', `‚îÇ    ‚îî‚îÄ Commits: ${commits}, Developers: ${devs}, PRs: ${prs}`);

                    updateRepoStatus(repoFullName, 'success', `${commits} commits, ${prs} PRs`, {
                        commits, developers: devs, prs, elapsed
                    });

                    return { success: true, data, repoFullName, elapsed };

                } catch (error) {
                    const elapsed = ((Date.now() - repoStartTime) / 1000).toFixed(2);
                    log('error', `‚îÇ ‚ùå [${repoFullName}] Failed after ${elapsed}s: ${error.message}`);

                    updateRepoStatus(repoFullName, 'error', error.message.substring(0, 30));
                    return { success: false, error: error.message, repoFullName, elapsed };
                }
            });

            // Wait for all to complete (parallel execution)
            log('info', '\n‚è≥ Waiting for all parallel requests to complete...');
            updateCurrentAction(`Analyzing ${repoList.length} repositories in parallel...`);

            const results = await Promise.all(analyzePromises);

            // Filter successful results
            const successfulResults = results.filter(r => r.success).map(r => r.data);
            const failedRepos = results.filter(r => !r.success);

            const totalElapsed = ((Date.now() - loadingStartTime) / 1000).toFixed(2);

            log('info', '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üìä ANALYSIS COMPLETE');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', `Total time: ${totalElapsed}s`);
            log('info', `Successful: ${successfulResults.length}/${repoList.length}`);
            log('info', `Failed: ${failedRepos.length}/${repoList.length}`);

            if (failedRepos.length > 0) {
                log('warn', 'Failed repositories:', failedRepos.map(r => `${r.repoFullName}: ${r.error}`));
            }

            if (successfulResults.length === 0) {
                hideParallelLoading();
                document.getElementById('analyzeBtn').disabled = false;
                showError('analyze-error', 'Failed to analyze any repositories. Please check your permissions and try again.');
                return;
            }

            // Merge all results
            updateCurrentAction('Merging results from all repositories...');
            log('info', 'üîÄ Merging results from all repositories...');

            const mergedData = mergeAnalysisResults(successfulResults);

            log('info', 'üìà Merged data summary:', {
                totalCommits: mergedData.summary.totalCommits,
                totalDevelopers: mergedData.summary.totalDevelopers,
                totalPRs: mergedData.summary.totalPRs,
                repositories: mergedData.analyzedRepositories.length
            });

            // Brief delay to show completion
            await new Promise(resolve => setTimeout(resolve, 500));

            hideParallelLoading();
            document.getElementById('analyzeBtn').disabled = false;

            if (failedRepos.length > 0) {
                console.warn('Some repositories failed to analyze:', failedRepos);
            }

            displayResults(mergedData);
            goToStep(3);
        }

        // Display results
        function displayResults(data) {
            // Store full data for filtering
            fullAnalysisData = data;

            // Initialize selected developers with all developers (use name as key since we group by name)
            selectedDevelopers = new Set(data.developers.map(d => d.authorName));

            // Show analyzed repositories
            const reposList = document.getElementById('analyzedReposList');
            const repoCount = document.getElementById('analyzedRepoCount');
            const dateRangeInfo = document.getElementById('dateRangeInfo');

            repoCount.textContent = data.analyzedRepositories.length;
            reposList.innerHTML = data.analyzedRepositories.map(repo => `
                <span class="repo-tag">
                    <span class="repo-icon">üì¶</span>
                    ${repo}
                </span>
            `).join('');

            // Show date range and period
            const periodLabels = { 'DAILY': 'Daily', 'WEEKLY': 'Weekly', 'MONTHLY': 'Monthly' };
            dateRangeInfo.innerHTML = `
                <span>üìÖ Date Range: <strong>${data.dateRange.startDate}</strong> to <strong>${data.dateRange.endDate}</strong></span>
                <span style="margin-left: 1rem;">üìä Aggregation: <strong>${periodLabels[data.period] || data.period}</strong></span>
            `;

            // Render developer filter chips
            renderDeveloperFilter(data.developers);

            // Render overall charts (not affected by developer filter)
            renderOverallCharts(data.developers);

            // Render charts with all developers initially
            renderChartsAndTable(data.developers);
        }

        // Render overall charts that show all data regardless of developer filter
        function renderOverallCharts(allDevelopers) {
            if (allDevelopers.length === 0) return;

            const labels = allDevelopers[0]?.dataPoints.map(dp => dp.period) || [];
            const colors = generateColors(allDevelopers.length);

            // 1. Total Commits Over Time (aggregate all developers)
            const totalCommitsByPeriod = labels.map((_, periodIndex) =>
                allDevelopers.reduce((sum, dev) => sum + dev.dataPoints[periodIndex].commits, 0)
            );

            if (totalCommitsChart) totalCommitsChart.destroy();
            totalCommitsChart = new Chart(document.getElementById('totalCommitsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Commits',
                        data: totalCommitsByPeriod,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...chartOptions(),
                    plugins: {
                        ...chartOptions().plugins,
                        legend: { display: false }
                    }
                }
            });

            // 2. Top Committers (horizontal bar chart)
            const developerCommits = allDevelopers.map(dev => ({
                name: getDisplayName(dev.nickname),
                commits: dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0)
            })).sort((a, b) => b.commits - a.commits).slice(0, 10); // Top 10

            if (topCommittersChart) topCommittersChart.destroy();
            topCommittersChart = new Chart(document.getElementById('topCommittersChart'), {
                type: 'bar',
                data: {
                    labels: developerCommits.map(d => d.name),
                    datasets: [{
                        label: 'Commits',
                        data: developerCommits.map(d => d.commits),
                        backgroundColor: colors.slice(0, developerCommits.length),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#e4e4e7',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return developerCommits[context[0].dataIndex].name;
                                },
                                label: function(context) {
                                    return `Commits: ${context.parsed.x}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#e4e4e7' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // 3. PRs Authored Over Time - use data from backend
            const prData = fullAnalysisData.prCountByPeriod || labels.map(() => 0);
            const hasPRData = prData.some(v => v > 0);
            const totalPRs = prData.reduce((a, b) => a + b, 0);

            if (prsChart) prsChart.destroy();
            prsChart = new Chart(document.getElementById('prsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PRs Authored',
                        data: prData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...chartOptions(),
                    plugins: {
                        ...chartOptions().plugins,
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Total PRs Authored: ${totalPRs}`,
                            color: '#22c55e',
                            font: { size: 14 }
                        }
                    }
                }
            });

            // 4. PR Authors (horizontal bar chart)
            const prAuthorStats = fullAnalysisData.prAuthorStats || [];
            const topPRAuthors = prAuthorStats.slice(0, 10); // Top 10 PR authors

            if (prAuthorsChart) prAuthorsChart.destroy();

            if (topPRAuthors.length > 0) {
                prAuthorsChart = new Chart(document.getElementById('prAuthorsChart'), {
                    type: 'bar',
                    data: {
                        labels: topPRAuthors.map(a => getDisplayName(a.authorName)),
                        datasets: [{
                            label: 'PRs Authored',
                            data: topPRAuthors.map(a => a.prCount),
                            backgroundColor: topPRAuthors.map((_, i) => {
                                const hue = (i * 137.5) % 360;
                                return `hsla(${hue}, 70%, 60%, 0.8)`;
                            }),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `${prAuthorStats.length} developers authored PRs`,
                                color: '#a1a1aa',
                                font: { size: 12 }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#e4e4e7',
                                borderColor: '#22c55e',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return getDisplayName(topPRAuthors[context[0].dataIndex].authorName);
                                    },
                                    label: function(context) {
                                        return `PRs Authored: ${context.parsed.x}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#a1a1aa', stepSize: 1 },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                title: { display: true, text: 'Number of PRs', color: '#a1a1aa' }
                            },
                            y: { ticks: { color: '#e4e4e7' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            } else {
                // No PR data - show a message
                const canvas = document.getElementById('prAuthorsChart');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#71717a';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No PR data available', canvas.width / 2, canvas.height / 2);
            }
        }

        // Render developer filter chips
        function renderDeveloperFilter(developers) {
            const container = document.getElementById('developerFilterList');
            const searchInput = document.getElementById('devFilterSearch');
            const query = searchInput ? searchInput.value.toLowerCase() : '';
            document.getElementById('totalDevCount').textContent = developers.length;

            const filteredDevs = query
                ? developers.filter(dev => {
                    const displayName = getDisplayName(dev.nickname);
                    return displayName.toLowerCase().includes(query) || dev.nickname.toLowerCase().includes(query);
                })
                : developers;

            container.innerHTML = filteredDevs.map(dev => {
                const totalCommits = dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const displayName = getDisplayName(dev.nickname);
                const avatarUrl = getAvatarUrl(dev.nickname);
                const isSelected = selectedDevelopers.has(dev.authorName);
                const escapedName = dev.authorName.replace(/'/g, "\\'");
                return `
                    <div class="dev-chip ${isSelected ? 'selected' : ''}"
                         onclick="toggleDeveloper('${escapedName}')"
                         title="${displayName} ‚Äî ${totalCommits} commits">
                        ${avatarUrl
                            ? `<img class="dev-avatar" src="${avatarUrl}" alt="${displayName}">`
                            : '<span style="font-size: 1em;">üë§</span>'
                        }
                        <span>${displayName}</span>
                        <span class="dev-commits">${totalCommits}</span>
                    </div>
                `;
            }).join('');

            updateSelectedDevCount();
        }

        // Search/filter developer chips
        function filterDeveloperChips() {
            if (fullAnalysisData && fullAnalysisData.developers) {
                renderDeveloperFilter(fullAnalysisData.developers);
            }
        }

        // Toggle developer selection
        function toggleDeveloper(name) {
            if (selectedDevelopers.has(name)) {
                selectedDevelopers.delete(name);
            } else {
                selectedDevelopers.add(name);
            }

            // Re-render filter chips
            renderDeveloperFilter(fullAnalysisData.developers);

            // Re-render charts with filtered developers
            const filteredDevelopers = fullAnalysisData.developers.filter(d => selectedDevelopers.has(d.authorName));
            renderChartsAndTable(filteredDevelopers);
        }

        // Select all developers
        function selectAllDevelopers() {
            selectedDevelopers = new Set(fullAnalysisData.developers.map(d => d.authorName));
            renderDeveloperFilter(fullAnalysisData.developers);
            renderChartsAndTable(fullAnalysisData.developers);
        }

        // Deselect all developers
        function deselectAllDevelopers() {
            selectedDevelopers.clear();
            renderDeveloperFilter(fullAnalysisData.developers);
            renderChartsAndTable([]);
        }

        // Update selected developer count
        function updateSelectedDevCount() {
            document.getElementById('selectedDevCount').textContent = selectedDevelopers.size;
        }

        // Render charts and table with given developers
        function renderChartsAndTable(developers) {
            // Summary cards - calculate from filtered developers
            const totalCommits = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.commits, 0), 0);
            const totalLinesAdded = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.linesAdded, 0), 0);
            const totalLinesDeleted = developers.reduce((sum, dev) =>
                sum + dev.dataPoints.reduce((s, dp) => s + dp.linesDeleted, 0), 0);

            const summaryHtml = `
                <div class="summary-card">
                    <h3>${developers.length}</h3>
                    <p>Developers</p>
                </div>
                <div class="summary-card">
                    <h3>${totalCommits}</h3>
                    <p>Total Commits</p>
                </div>
                <div class="summary-card">
                    <h3>${totalLinesAdded.toLocaleString()}</h3>
                    <p>Lines Added</p>
                </div>
                <div class="summary-card">
                    <h3>${totalLinesDeleted.toLocaleString()}</h3>
                    <p>Lines Deleted</p>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHtml;

            if (developers.length === 0) {
                document.getElementById('developerTableBody').innerHTML = '<tr><td colspan="6">No developers selected</td></tr>';
                // Clear charts
                return;
            }

            const labels = developers[0]?.dataPoints.map(dp => dp.period) || [];
            const colors = generateColors(developers.length);

            // Commits chart
            if (commitsChart) commitsChart.destroy();
            commitsChart = new Chart(document.getElementById('commitsChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: developers.map((dev, i) => ({
                        label: getDisplayName(dev.nickname),
                        data: dev.dataPoints.map(dp => dp.commits),
                        borderColor: colors[i],
                        backgroundColor: colors[i] + '20',
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: chartOptions()
            });

            // Lines chart
            if (linesChart) linesChart.destroy();
            linesChart = new Chart(document.getElementById('linesChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: developers.map((dev, i) => ({
                        label: getDisplayName(dev.nickname),
                        data: dev.dataPoints.map(dp => dp.linesAdded),
                        backgroundColor: colors[i],
                        stack: 'added'
                    }))
                },
                options: { ...chartOptions(), scales: { x: { stacked: true, ...chartOptions().scales.x }, y: { stacked: true, ...chartOptions().scales.y } } }
            });

            // Pie chart
            if (pieChart) pieChart.destroy();
            const commitTotals = developers.map(dev => dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0));
            pieChart = new Chart(document.getElementById('developerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: developers.map(dev => getDisplayName(dev.nickname)),
                    datasets: [{ data: commitTotals, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#e4e4e7' } } }
                }
            });

            // Developer table
            // Store developers globally for popup access
            window._currentDevelopers = developers;
            document.getElementById('developerTableBody').innerHTML = developers.map((dev, index) => {
                const commits = dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
                const added = dev.dataPoints.reduce((sum, dp) => sum + dp.linesAdded, 0);
                const deleted = dev.dataPoints.reduce((sum, dp) => sum + dp.linesDeleted, 0);
                const displayName = getDisplayName(dev.nickname);
                const avatarUrl = getAvatarUrl(dev.nickname);

                return `
                    <tr onclick="showDeveloperCommits(${index})" title="Click to view ${displayName}'s commits">
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${avatarUrl
                                    ? `<img src="${avatarUrl}" alt="${displayName}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #6366f1;">`
                                    : '<span style="font-size: 1.5em;">üë§</span>'
                                }
                                <span style="font-weight: 500;">${displayName}</span>
                            </div>
                        </td>
                        <td>${dev.nickname}</td>
                        <td>${commits}</td>
                        <td style="color: #22c55e;">+${added.toLocaleString()}</td>
                        <td style="color: #ef4444;">-${deleted.toLocaleString()}</td>
                        <td>${Array.from(dev.repositories).join(', ')}</td>
                    </tr>
                `;
            }).join('');
        }

        // Utilities
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4',
                '#0ea5e9', '#3b82f6'
            ];
            return colors.slice(0, count);
        }

        function chartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { labels: { color: '#e4e4e7' } },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#e4e4e7',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            };
        }

        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showLoading(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideLoading(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ==================== DEVELOPER ACTIVITY POPUP (TABBED) ====================

        let _popupActiveTab = 'commits';

        function showDeveloperCommits(devIndex) {
            const developers = window._currentDevelopers;
            if (!developers || !developers[devIndex]) return;

            const dev = developers[devIndex];
            const displayName = getDisplayName(dev.nickname);
            const avatarUrl = getAvatarUrl(dev.nickname);
            const commits = dev.commits || [];
            const totalCommits = dev.dataPoints.reduce((sum, dp) => sum + dp.commits, 0);
            const totalAdded = dev.dataPoints.reduce((sum, dp) => sum + dp.linesAdded, 0);
            const totalDeleted = dev.dataPoints.reduce((sum, dp) => sum + dp.linesDeleted, 0);
            const repos = Array.from(dev.repositories);

            // Header
            const avatarEl = document.getElementById('commitPopupAvatar');
            avatarEl.src = avatarUrl || '';
            avatarEl.style.display = avatarUrl ? 'block' : 'none';
            document.getElementById('commitPopupName').textContent = displayName;
            document.getElementById('commitPopupLogin').textContent = '@' + dev.nickname;

            // Stats
            document.getElementById('commitPopupStats').innerHTML = `
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${totalCommits}</div>
                    <div class="commit-popup-stat-label">Total Commits</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value" style="color:#22c55e">+${totalAdded.toLocaleString()}</div>
                    <div class="commit-popup-stat-label">Lines Added</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value" style="color:#ef4444">-${totalDeleted.toLocaleString()}</div>
                    <div class="commit-popup-stat-label">Lines Deleted</div>
                </div>
                <div class="commit-popup-stat">
                    <div class="commit-popup-stat-value">${repos.length}</div>
                    <div class="commit-popup-stat-label">Repositories</div>
                </div>
            `;

            // Store data globally for tab switching / filtering
            window._popupCommits = commits;
            window._popupRepos = repos;

            // Update tab badges
            document.getElementById('tabBadgeCommits').textContent = commits.length;
            // PR data is not available on the contribution page
            document.getElementById('tabBadgePRsAuthored').textContent = '‚Äî';
            document.getElementById('tabBadgePRsReviewed').textContent = '‚Äî';

            // Reset to commits tab
            _popupActiveTab = 'commits';
            document.querySelectorAll('.popup-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.popup-tab[data-tab="commits"]').classList.add('active');
            document.getElementById('commitSearchInput').value = '';
            document.getElementById('commitSearchInput').placeholder = 'Search commits by message or hash‚Ä¶';

            renderPopupTabContent();

            // Show modal
            document.getElementById('commitPopupModal').classList.add('show');
        }

        function switchPopupTab(tab) {
            _popupActiveTab = tab;
            document.querySelectorAll('.popup-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.popup-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('commitSearchInput').value = '';

            const placeholders = {
                'commits': 'Search commits by message or hash‚Ä¶',
                'prs-authored': 'Search PRs by title, number, or repo‚Ä¶',
                'prs-reviewed': 'Search reviewed PRs by title, number, or repo‚Ä¶'
            };
            document.getElementById('commitSearchInput').placeholder = placeholders[tab] || 'Search‚Ä¶';

            renderPopupTabContent();
        }

        function renderPopupTabContent() {
            const q = (document.getElementById('commitSearchInput').value || '').toLowerCase();

            switch (_popupActiveTab) {
                case 'commits':
                    let commits = window._popupCommits || [];
                    if (q) commits = commits.filter(c =>
                        (c.message || '').toLowerCase().includes(q) ||
                        (c.hash || '').toLowerCase().includes(q) ||
                        (c.repositoryName || '').toLowerCase().includes(q)
                    );
                    renderCommitList(commits);
                    break;
                case 'prs-authored':
                case 'prs-reviewed':
                    renderPRUnavailable();
                    break;
            }
        }

        function filterPopupTab() {
            renderPopupTabContent();
        }

        function renderCommitList(commits) {
            const body = document.getElementById('commitPopupBody');

            if (!commits || commits.length === 0) {
                body.innerHTML = '<p style="text-align:center;color:#71717a;padding:2rem;">No commit details available</p>';
                return;
            }

            const sorted = [...commits].sort((a, b) => new Date(b.date) - new Date(a.date));

            body.innerHTML = sorted.map(c => {
                const shortHash = c.hash.substring(0, 7);
                const commitUrl = buildCommitUrl(c.hash, c.repositoryName);
                const date = new Date(c.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const repoShort = c.repositoryName ? c.repositoryName.split('/').pop() : '';
                const msgEl = document.createElement('span');
                msgEl.textContent = c.message || '';
                const safeMsg = msgEl.innerHTML;

                return `
                    <div class="commit-item">
                        <div class="commit-hash"><a href="${commitUrl}" target="_blank" rel="noopener noreferrer">${shortHash}</a></div>
                        <div class="commit-info">
                            <div class="commit-message"><a href="${commitUrl}" target="_blank" rel="noopener noreferrer">${safeMsg}</a></div>
                            <div class="commit-meta">
                                <span class="commit-meta-item">üìÖ ${dateStr} ${timeStr}</span>
                                ${repoShort ? `<span class="commit-meta-item">üì¶ ${repoShort}</span>` : ''}
                                <span class="commit-meta-item" style="color:#22c55e">+${c.linesAdded || 0}</span>
                                <span class="commit-meta-item" style="color:#ef4444">-${c.linesDeleted || 0}</span>
                                <span class="commit-meta-item">üìÅ ${c.filesChanged || 0} files</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPRUnavailable() {
            const body = document.getElementById('commitPopupBody');
            const label = _popupActiveTab === 'prs-authored' ? 'PRs Authored' : 'PRs Reviewed';
            body.innerHTML = `
                <div style="text-align:center; padding:3rem 1.5rem;">
                    <div style="font-size:2.5rem; margin-bottom:0.75rem; opacity:.5;">üîÄ</div>
                    <div style="font-size:1rem; color:#a1a1aa; font-weight:500; margin-bottom:0.5rem;">${label} data is not available here</div>
                    <div style="font-size:0.82rem; color:#71717a; max-width:340px; margin:0 auto;">
                        PR details are available on the <strong style="color:#818cf8;">Engagement</strong> page where GitHub API data is used for analysis.
                    </div>
                </div>
            `;
        }

        function buildCommitUrl(hash, repoName) {
            if (repoName && repoName.includes('/')) {
                return 'https://github.com/' + repoName + '/commit/' + hash;
            }
            return '#';
        }


        function closeCommitPopup(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('commitPopupModal').classList.remove('show');
        }

        // Close popup on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeCommitPopup();
        });
    </script>
</body>
</html>

